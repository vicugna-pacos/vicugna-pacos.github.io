---
title: "Azure Bot Service でボットを作成する(GitHubでデプロイ版)"
date: 2020-10-12T15:25:42+09:00
weight: 2
---

## はじめに
Azure Bot Service でボットを作成するとき、[公式ドキュメントのクイックスタート](https://docs.microsoft.com/ja-jp/azure/bot-service/dotnet/bot-builder-dotnet-sdk-quickstart?view=azure-bot-service-4.0&tabs=vs)の手順に従うと、まずローカルでボットのソースコードを作成した後、[CLIでAzureのリソースを作成しつつデプロイする手順](https://docs.microsoft.com/ja-jp/azure/bot-service/bot-builder-deploy-az-cli?view=azure-bot-service-4.0&tabs=csharp)になっている。
この記事では、それとは違った手順で、まずAzureにリソースを作成しつつ、GitHubと連携させてCI環境も作る方法を載せている。
個人的には、この方法の方が開発・保守しやすそうで良いかと思う。

前提条件：

* SDKの言語はC#を選択
* コード編集には Visual Studio 2019 Community 版を使用

## GitHubにリポジトリを作成する
ボットのソースコードを置くためのリポジトリを作成する。public/privateは問わず、空のままで良い。

## Azureにボットを作成する
Azureポータルで「リソースの作成」を選択し、「Web App Bot」を探して「作成」を押す。

![](2020-10-12-15-33-27.png)

ボット作成の画面になるので、必要事項を入力して「作成」を押す。

![](2020-10-12-15-40-10.png)

* ボットハンドル - ボットの名前。おそらくAzure全体で一意でなければいけない。チャンネルに接続するときなどに表示される名前。
* 価格 - F0(無料)推奨。後で変更可能。
* ボットテンプレート - Echo Bot 推奨。必要であれば別のテンプレートを選択する。
* Application Insights - オンにすると、ボットのログを記録できる。あとで日次データ量の制限をかけておくことを推奨。

作成後、しばらく待つとリソースが作成される。
「ボットテンプレート」という項目があったように、Web App Botを作成するとボットのソースコードも一緒に作成されるので、これをダウンロードして開発のひな型とする。

## ボットのソースコードを取得する
作成された「Web App Bot」のリソースを選択し、「ビルド」→「ボットのソースコードをダウンロードする」をクリックする。

![](2020-10-12-16-09-46.png)

ソースコードにシークレットを含めるかどうか確認したあと、しばらく待つとzipファイルがダウンロードできる。
zipファイルを解凍した後、あらかじめクローンしておいたGitHubリポジトリへコピーする。
その後、ソースコードは全てコミット＆プッシュしておく。

※ソースコードにシークレットを含めた場合、appsettings.jsonはリポジトリに含めない方が良いかもしれない。

## CI/CDを設定する
Azureポータルにて、ボット作成時に一緒に作成された App Service の方のリソースを選択し、「デプロイ センター」をクリックする。

![](2020-10-12-16-20-13.png)

Azure と GitHub の連携が初めての場合、GitHubにログインしてAzureのアクセスを許可する手順がある。

それが完了した後、ビルドプロバイダーを選択するページになるので「GitHub Actions」を選択する。

次に構成を選択するページになるので、下記の通り選択する：

* 組織 - GitHubの組織、またはアカウントを選択する。
* リポジトリ - ボットのソースコードをコミットしたリポジトリを選択する。
* ブランチ - CI/CDの対象になるブランチを指定。通常、mainになるかと思う。
* ランタイムスタック - アプリの言語を指定。今回は「.NET Core」を選択。
* バージョン - ソースコードのプロジェクトのプロパティを確認して、選択する。

![](2020-10-12-16-28-45.png)

最後に確認画面になるので、内容を確認して確定する。

確定後、GitHub側にデプロイ実行用のファイルが追加され、Actionが実行される。

![](2020-10-12-16-32-14.png)

## csファイルの文字コードを設定する
ソースコードからデプロイまでの流れができたので、ここからボットのカスタマイズに着手できる。
しかし Visual Studio はcsファイルの既定の文字コードがShift_JISなので、コード中に日本語のメッセージを書くと、ボットをテストしたときに文字化けしてしまう。それを避けるため、プロジェクトに設定ファイルを追加して既定の文字コードを UTF-8 にしておく必要がある。

![](2020-10-13-17-13-32.png)

まず Visual Studio でソリューションを開き、プロジェクト直下で「新しい項目の追加」を選択する(ソリューションエクスプローラーでプロジェクトのフォルダを選択し、`Ctrl` + `Shift` + `A`)。

「新しい項目の追加」画面が開くので、検索欄に「editor」と入力する。そうすると「editorconfig ファイル」が出てくるので、それを選択して「追加」を押す。
ファイル名は既定の「.editorconfig」のままで良い。

![](2020-10-13-17-17-46.png)

プロジェクト直下に「.editorconfig」ファイルが追加されるので、ファイルを開いて内容を確認する。
「# Code files」の下にある `charset` が `utf-8-bom` となっていればOK。

![](2020-10-13-17-21-06.png)

「.editorconfig」はプロジェクトに対するテキストエディターの設定を統一するものなので、Visual Studio の設定より優先して適用される。
他の設定項目が煩わしかったら、下記だけにしても良いと思う。

```
[*.cs]
charset = utf-8-bom
```
