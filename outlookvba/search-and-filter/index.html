<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta property="og:title" content="検索やフィルターの構文"><meta property="og:description" content="はじめに Outlook VBA でメールや予定の検索を行う際、Items.Find や Items.Restrict を使用する。このメソッドの引数に指定するフィルター構文について分かった部分をまとめた。 MSドキュメント：https://docs.mi"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/outlookvba/search-and-filter/"><meta property="article:published_time" content="2021-03-02T15:01:51+09:00"><meta property="article:modified_time" content="2021-03-02T15:01:51+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="検索やフィルターの構文"><meta name=twitter:description content="はじめに Outlook VBA でメールや予定の検索を行う際、Items.Find や Items.Restrict を使用する。このメソッドの引数に指定するフィルター構文について分かった部分をまとめた。 MSドキュメント：https://docs.mi"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>検索やフィルターの構文 - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Outlook VBA</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#基礎知識>基礎知識</a><ul><li><a href=#find-と-restrict-の違い>Find と Restrict の違い</a></li></ul></li><li><a href=#使用できる演算子>使用できる演算子</a></li><li><a href=#文字列のフィルター>文字列のフィルター</a></li><li><a href=#日付のフィルター>日付のフィルター</a><ul><li><a href=#予定を日付でフィルターするときの注意>予定を日付でフィルターするときの注意</a></li></ul></li><li><a href=#booleanのフィルター>Booleanのフィルター</a></li><li><a href=#列挙型のフィルター>列挙型のフィルター</a></li><li><a href=#分類項目>分類項目</a></li><li><a href=#mailitem-メール>MailItem (メール)</a></li><li><a href=#appointmentitem-予定>AppointmentItem (予定)</a></li></ul></nav></aside></div><div class=main><article><h1>検索やフィルターの構文</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2021-03-02 15:01:51 +0900 +0900" itemprop=datePublished>2021-03-02</time></div><div></div></div><h2 id=はじめに>はじめに</h2><p>Outlook VBA でメールや予定の検索を行う際、<code>Items.Find</code> や <code>Items.Restrict</code> を使用する。このメソッドの引数に指定するフィルター構文について分かった部分をまとめた。</p><p>MSドキュメント：https://docs.microsoft.com/ja-jp/office/vba/outlook/how-to/search-and-filter/filtering-items</p><p>Outlookのバージョン：Office 365</p><h2 id=基礎知識>基礎知識</h2><p>フィルターに指定できる構文は、Jet 構文と DASL 構文の2種類がある。
Jet 構文は SQL の WHERE 句のような書き方ができるが、前方一致検索がなかったりする。
DASL 構文には前方一致検索があるが、<code>Items.Find</code> と <code>Items.Restrict</code> で使用できる構文が一部異なる。</p><p>Jet 構文で使用できる列名 (ぽいもの) は、<code>MailItem</code> などの Item オブジェクトのプロパティと同じだと思われる。</p><h3 id=find-と-restrict-の違い>Find と Restrict の違い</h3><p>総じて、Restrict メソッドを使う方がいい。</p><ul><li><code>Items.Find</code><ul><li><code>ci_startswith</code> など <code>ci_</code> で始まる構文が使用できない。「検索操作にコンテンツ インデックス キーワードを使用することはできません。」のエラーになる。</li><li>検索条件に含められないプロパティがある。例えば、Body (本文) や Categories (分類項目) が使えない。</li><li>検索対象になるアイテム数が少ない場合、Restrict メソッドより実行速度が速い。</li></ul></li><li><code>Items.Restrict</code><ul><li><code>ci_</code> から始まる構文の制限なし。</li><li>検索対象のアイテム数が多い場合、Find メソッドより実行速度が速い。</li></ul></li></ul><h2 id=使用できる演算子>使用できる演算子</h2><p>Jet 構文、DASL 構文 いずれも使用できる演算子は同じ。</p><p>比較演算子：</p><ul><li><code>=</code></li><li><code>>=</code></li><li><code>></code></li><li><code>&lt;=</code></li><li><code>&lt;</code></li><li><code>&lt;></code></li></ul><p>論理演算子：</p><ul><li><code>And</code></li><li><code>Or</code></li><li><code>Not</code><ul><li>サンプル：<code>[FirstName] = 'Jane' And Not([CompanyName] = 'Microsoft')</code></li></ul></li></ul><h2 id=文字列のフィルター>文字列のフィルター</h2><p>Jet構文のサンプル：</p><ul><li><code>[Subject]='あいう'</code><ul><li>件名が「あいう」に一致する。頭に<code>RE:</code>や<code>FW:</code>が付いているものも含まれる。</li></ul></li></ul><p>DASL構文のサンプル：</p><ul><li><code>@SQL="urn:schemas:httpmail:subject" = 'あいう'</code><ul><li>件名が「あいう」に一致する。頭に<code>RE:</code>などが付いていたら対象外。</li></ul></li><li><code>@SQL="urn:schemas:httpmail:subject" like 'RE:%'</code><ul><li>件名が「RE:」で始まる(前方一致)</li></ul></li></ul><h2 id=日付のフィルター>日付のフィルター</h2><p>日付の書式は、「yyyy/MM/dd H:mm」。時刻は「HH」でも可。厳密には、Outlookが使っている書式に合わせる。</p><p><img src=2021-03-02-15-10-13.png alt></p><p>時刻までちゃんと指定しないと、<code>[Start] >= '2020/06/10 0:00'</code>としたときに、6月10日0時開始の予定がフィルターに引っかからない。</p><ul><li><code>[ReceivedTime] >= '2020/04/15'</code><ul><li>メールの受信日が2020/04/15以降</li></ul></li><li><code>[Start] >= '2020/06/10 0:00' AND [End] &lt;= '2020/06/30 0:00'</code><ul><li>予定の開始日が6/10以降 かつ 終了日が6/30以前</li></ul></li></ul><h3 id=予定を日付でフィルターするときの注意>予定を日付でフィルターするときの注意</h3><p>予定 (AppointmentItem) を検索する際、以下のように <code>IncludeRecurrences</code> プロパティを true にして、 <code>Start</code> プロパティでソートしてから検索する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderCalendar</span><span style=color:#111>)</span>

<span style=color:#111>$allItems</span> <span style=color:#111>=</span> <span style=color:#111>$folder</span><span style=color:#111>.</span><span style=color:#111>Items</span>
<span style=color:#111>$allItems</span><span style=color:#111>.</span><span style=color:#111>IncludeRecurrences</span> <span style=color:#111>=</span> <span style=color:#111>$true</span>
<span style=color:#111>$allItems</span><span style=color:#111>.</span><span style=color:#111>Sort</span><span style=color:#111>(</span><span style=color:#d88200>&#34;[Start]&#34;</span><span style=color:#111>)</span>

<span style=color:#111>$filter</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;[Start] &gt;= &#39;2021/08/01 0:00&#39; AND [End] &lt;= &#39;2021/08/01 23:59&#39;&#34;</span>
<span style=color:#111>$items</span> <span style=color:#111>=</span> <span style=color:#111>$allItems</span><span style=color:#111>.</span><span style=color:#111>Restrict</span><span style=color:#111>(</span><span style=color:#111>$filter</span><span style=color:#111>)</span>
</code></pre></div><p>こうしないと、8/1にはないはずの「繰り返しの予定」が検索されたりして、上手く検索できない。
詳しい説明は、<a href=https://docs.microsoft.com/en-us/office/vba/api/outlook.items.includerecurrences target=_blank rel=noopener>MSドキュメントの IncludeRecurrences プロパティのページ</a> に書かれている。</p><h2 id=booleanのフィルター>Booleanのフィルター</h2><ul><li><code>[UnRead] = True</code><ul><li>メールが未読である</li></ul></li><li><code>[AllDayEvent] = True</code><ul><li>予定が「終日」である</li></ul></li></ul><h2 id=列挙型のフィルター>列挙型のフィルター</h2><p>Importance(重要度)などはVBAでは列挙型で指定するが、フィルター構文ではすべて数字へ置き換える。</p><ul><li><code>[Importance] = 2</code><ul><li>重要度が「高」である</li></ul></li></ul><h2 id=分類項目>分類項目</h2><p>Jet 構文では、「XXという分類項目が付いているか」という指定ができる。</p><pre><code>[Categories] = 'Partner'
</code></pre><p>上記のサンプルでは、<code>Partner</code> という分類項目がついているアイテムを検索できる。Partner と Business など、他の分類項目が一緒に付いていても検索結果に表れる。</p><p>「<code>Partner</code> で始まる分類項目を持つアイテム」を検索したい場合は、DASL クエリを使用する。</p><pre><code>&quot;urn:schemas-microsoft-com:office:office#Keywords&quot; like 'Partner%'
</code></pre><p>分類項目が一切ついていないアイテムを検索する方法もある。DASL クエリでのみ <code>IS NULL</code> という構文が利用できるので、それを使う。</p><pre><code>&quot;urn:schemas-microsoft-com:office:office#Keywords&quot; is null
</code></pre><h2 id=mailitem-メール>MailItem (メール)</h2><p>検索に使いそうなプロパティを載せておく。</p><table><thead><tr><th>プロパティ名</th><th>型</th><th>説明</th></tr></thead><tbody><tr><td>Subject</td><td>文字</td><td>件名</td></tr><tr><td>SenderEmailAddress</td><td>文字</td><td>送信者のメールアドレス</td></tr><tr><td>ReceivedTime</td><td>日付</td><td>受信日時</td></tr><tr><td>UnRead</td><td>Boolean</td><td>未読かどうか</td></tr></tbody></table><h2 id=appointmentitem-予定>AppointmentItem (予定)</h2><table><thead><tr><th>プロパティ名</th><th>型</th><th>説明</th></tr></thead><tbody><tr><td>Subject</td><td>文字</td><td>件名</td></tr><tr><td>Start</td><td>日付</td><td>開始日時</td></tr><tr><td>End</td><td>日付</td><td>終了日時</td></tr><tr><td>AllDayEvent</td><td>Boolean</td><td>終日かどうか</td></tr><tr><td>Location</td><td>文字</td><td>場所</td></tr></tbody></table></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>