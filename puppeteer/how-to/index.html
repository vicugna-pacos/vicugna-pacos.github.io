<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-0L8LJXJEKX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-0L8LJXJEKX');</script><meta property="og:title" content="Puppeteer の使い方"><meta property="og:description" content="Puppeteer の使い方を逆引き形式でまとめました。"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/puppeteer/how-to/"><meta property="article:published_time" content="2019-12-14T11:54:00+09:00"><meta property="article:modified_time" content="2021-10-17T14:05:35+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Puppeteer の使い方"><meta name=twitter:description content="Puppeteer の使い方を逆引き形式でまとめました。"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>Puppeteer の使い方 - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Puppeteer</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#puppeteerとは>Puppeteerとは</a></li><li><a href=#インストール>インストール</a><ul><li><a href=#puppeteer-coreを使う>puppeteer-coreを使う</a></li></ul></li><li><a href=#ブラウザの起動と終了>ブラウザの起動と終了</a></li><li><a href=#指定したurlへ移動>指定したURLへ移動</a></li><li><a href=#要素を取得する>要素を取得する</a><ul><li><a href=#要素が存在するか調べる>要素が存在するか調べる</a></li><li><a href=#指定したテキストを含む要素を取得する>指定したテキストを含む要素を取得する</a></li></ul></li><li><a href=#クリックする>クリックする</a><ul><li><a href=#クリック後のページ移動を待つ>クリック後のページ移動を待つ</a></li><li><a href=#ctrlキーを押しながらリンクをクリックする>Ctrlキーを押しながらリンクをクリックする</a></li></ul></li><li><a href=#文字を入力する>文字を入力する</a></li><li><a href=#テキストを取得する>テキストを取得する</a></li><li><a href=#指定秒を待つ>指定秒を待つ</a></li><li><a href=#要素が表示されるまで待つ>要素が表示されるまで待つ</a></li><li><a href=#ページの描画が終わるのを待つ>ページの描画が終わるのを待つ</a></li><li><a href=#chromeで動的に生成される要素を調べる>Chromeで動的に生成される要素を調べる</a></li><li><a href=#ダイアログに対応する>ダイアログに対応する</a></li><li><a href=#ログインが必要なページへのアクセス>ログインが必要なページへのアクセス</a><ul><li><a href=#cookieを使用してログインする>Cookieを使用してログインする</a><ul><li><a href=#editthiscookieのインストール>EditThisCookieのインストール</a></li><li><a href=#cookieのエクスポート>Cookieのエクスポート</a></li><li><a href=#puppeteerでcookieを読み込む>puppeteerでCookieを読み込む</a></li></ul></li></ul></li><li><a href=#navigatorwebdriver-をオフにする>navigator.webdriver をオフにする</a></li></ul></nav></aside></div><div class=main><article><h1>Puppeteer の使い方</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2019-12-14 11:54:00 +0900 +0900" itemprop=datePublished>2019-12-14</time>
(最終更新：<time datetime="2021-10-17 14:05:35 +0900 +0900" itemprop=dateModified>2021-10-17</time>)</div><div></div></div><h2 id=puppeteerとは>Puppeteerとは</h2><p>Chrome または Chromium を操れるライブラリ。スクレイピングや自動テストに使える。Node.jsから使用できる。</p><p>公式サイト
<a href=https://pptr.dev/>https://pptr.dev/</a></p><p>初稿を書いたときのバージョン：1.19.0</p><h2 id=インストール>インストール</h2><p>任意のプロジェクトフォルダで下記コマンドを実行。</p><pre><code>npm i puppeteer
</code></pre><p>既定では、puppeteerをインストールすると、最新バージョンのChromiumも一緒にダウンロードされる。ダウンロードさせたくない場合は、環境変数で設定を変更するか、<code>puppeteer-core</code>の使用を検討すると良い。</p><h3 id=puppeteer-coreを使う>puppeteer-coreを使う</h3><p>v1.7.0から追加されたパッケージ。Chromiumのダウンロードを行わない。代わりに既にPCにあるChrome/Chromiumなどを使用する。
大体の場合は<code>puppeteer</code>の方を使えば良いが、スクリプトを動かす環境内にChomeがあり、そちらを使えば良いやと思う場合などは、<code>puppeteer-core</code>を使う方が容量を取らなくて良さそう。</p><h2 id=ブラウザの起動と終了>ブラウザの起動と終了</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// headless : ブラウザを画面に表示するかどうかのフラグ。既定値はtrueで非表示となる。
</span><span style=color:#75715e>// executablePath : 同梱されているChromiumを使用しない場合のみ、インストール済みのChromeやChromiumのパスを指定する。puppeteer-core使用時は必須指定。
</span><span style=color:#75715e></span><span style=color:#00a8c8>const</span> <span style=color:#75af00>LAUNCH_OPTION</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span>
	 <span style=color:#75af00>headless</span> <span style=color:#f92672>:</span> <span style=color:#00a8c8>false</span>
	<span style=color:#111>,</span><span style=color:#75af00>executablePath</span> <span style=color:#f92672>:</span> <span style=color:#d88200>&#39;C:/Program Files/Google/Chrome/Application/chrome.exe&#39;</span>
<span style=color:#111>};</span>

<span style=color:#00a8c8>const</span> <span style=color:#75af00>browser</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>puppeteer</span><span style=color:#111>.</span><span style=color:#75af00>launch</span><span style=color:#111>(</span><span style=color:#75af00>LAUNCH_OPTION</span><span style=color:#111>);</span>
<span style=color:#00a8c8>try</span> <span style=color:#111>{</span>
	<span style=color:#00a8c8>const</span> <span style=color:#75af00>page</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>browser</span><span style=color:#111>.</span><span style=color:#75af00>newPage</span><span style=color:#111>();</span>	<span style=color:#75715e>// 新しいタブを開く
</span><span style=color:#75715e></span>	
	<span style=color:#75715e>// ここにスクレイピングを実装
</span><span style=color:#75715e></span>
<span style=color:#111>}</span> <span style=color:#00a8c8>finally</span> <span style=color:#111>{</span>
	<span style=color:#75af00>await</span> <span style=color:#75af00>browser</span><span style=color:#111>.</span><span style=color:#75af00>close</span><span style=color:#111>();</span>
<span style=color:#111>}</span>
</code></pre></div><h2 id=指定したurlへ移動>指定したURLへ移動</h2><p>ブラウザを起動したら、まずはスクレイピングしたいWebサイトへ移動することが多いと思う。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// 定義
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#00a8c8>goto</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>[,</span> <span style=color:#75af00>options</span><span style=color:#111>]);</span>

<span style=color:#75715e>// サンプル
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#00a8c8>goto</span><span style=color:#111>(</span><span style=color:#d88200>&#34;https://www.yahoo.co.jp/&#34;</span><span style=color:#111>,</span> <span style=color:#111>{</span><span style=color:#d88200>&#34;waitUntil&#34;</span><span style=color:#f92672>:</span><span style=color:#d88200>&#34;domcontentloaded&#34;</span><span style=color:#111>});</span>
</code></pre></div><p>パラメータ：</p><ul><li><code>url</code> &lt;string> 移動先のURL。</li><li><code>options</code> &lt;Object> オプション。</li><li><code>timeout</code> &lt;number> 待機時間の最大値(ミリ秒)。既定値は30秒。0を指定するとタイムアウト無しになる。既定値は <code>page.setDefaultNavigationTimeout(timeout)</code> または <code>page.setDefaultTimeout(timeout)</code> で変更できる。</li><li><code>waitUntil</code> どの時点をもって移動完了とみなすかの設定値。既定値は <code>load</code>。配列にして複数の文字列を渡した場合は、すべてのイベントが完了してから移動完了とみなす。<ul><li><code>load</code> - ページの読込みが、画像などを含めて完了。</li><li><code>domcontentloaded</code> - HTMLの読込みが終わった。</li><li><code>networkidle0</code> - ネットワーク接続が0件の状態が500ミリ秒続いたとき。</li><li><code>networkidle2</code> - ネットワーク接続が2件以下の状態が500ミリ秒続いたとき。</li></ul></li><li><code>referer</code> &lt;string> リファラのヘッダー値。</li></ul><h2 id=要素を取得する>要素を取得する</h2><p>Webページを表示できたら、操作したいテキストボックスやボタンを指定するが、その各要素はCSSセレクタまたはXPathで指定できる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// CSSセレクタによる要素の取得(最初の1件のみ)
</span><span style=color:#75715e></span><span style=color:#00a8c8>const</span> <span style=color:#75af00>element1</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>$</span><span style=color:#111>(</span><span style=color:#d88200>&#34;#main-container&#34;</span><span style=color:#111>);</span>

<span style=color:#75715e>// CSSセレクタによる要素の取得(一致するものすべて)
</span><span style=color:#75715e></span><span style=color:#00a8c8>const</span> <span style=color:#75af00>elements1</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>$$</span><span style=color:#111>(</span><span style=color:#d88200>&#34;.section&#34;</span><span style=color:#111>);</span>

<span style=color:#75715e>// XPathによる要素の取得(一致するものすべて)
</span><span style=color:#75715e></span><span style=color:#00a8c8>const</span> <span style=color:#75af00>elements2</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>$x</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/html/body/h1&#34;</span><span style=color:#111>);</span>
</code></pre></div><p><code>page.$()</code>を使用しなくとも、クリックや文字入力は専用メソッドがあるが、CSSセレクタによる要素指定が基本となっている。XPathで要素を指定したい場合は、<code>page.$x()</code>を使う必要がある。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// CSSセレクタを使ってクリック
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>click</span><span style=color:#111>(</span><span style=color:#d88200>&#34;#confirm-button&#34;</span><span style=color:#111>);</span>

<span style=color:#75715e>// XPathを使ってクリック
</span><span style=color:#75715e></span><span style=color:#00a8c8>const</span> <span style=color:#75af00>elements</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>$x</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/html/body/input[@type=&#39;button&#39;]&#34;</span><span style=color:#111>);</span>
<span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>elements</span><span style=color:#111>.</span><span style=color:#75af00>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#75af00>await</span> <span style=color:#75af00>elements</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>].</span><span style=color:#75af00>click</span><span style=color:#111>();</span>
<span style=color:#111>}</span>
</code></pre></div><p>XPath を使う場合、パスの指定方法に注意。例えば下記のように、先に特定の div 要素を取得し、その中にある a タグを XPath で見つけたい場合は、XPath は <code>.//a</code> と書く。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#00a8c8>let</span> <span style=color:#75af00>div</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>$</span><span style=color:#111>(</span><span style=color:#d88200>&#34;div#container&#34;</span><span style=color:#111>);</span>

<span style=color:#00a8c8>let</span> <span style=color:#75af00>link1</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>div</span><span style=color:#111>.</span><span style=color:#75af00>$x</span><span style=color:#111>(</span><span style=color:#d88200>&#34;//a&#34;</span><span style=color:#111>);</span>    <span style=color:#75715e>// NG
</span><span style=color:#75715e></span><span style=color:#00a8c8>let</span> <span style=color:#75af00>link2</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>div</span><span style=color:#111>.</span><span style=color:#75af00>$x</span><span style=color:#111>(</span><span style=color:#d88200>&#34;.//a&#34;</span><span style=color:#111>);</span>   <span style=color:#75715e>// OK
</span></code></pre></div><p>こういう場合に <code>//a</code> と書いてしまうと、div 配下の要素を探すように記述したつもりでも、それを無視してページ全体から a タグを探してしまう。</p><h3 id=要素が存在するか調べる>要素が存在するか調べる</h3><p>要素が見つからない場合、<code>page.$()</code>の戻り値がnullになるので、それで存在チェックができる。</p><h3 id=指定したテキストを含む要素を取得する>指定したテキストを含む要素を取得する</h3><p>XPath を使うと便利。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// ページ全体から「あああ」というテキストを持つdivタグを探す
</span><span style=color:#75715e></span><span style=color:#00a8c8>const</span> <span style=color:#75af00>elements1</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>$x</span><span style=color:#111>(</span><span style=color:#d88200>&#39;//div[contains(text(), &#34;あああ&#34;)]&#39;</span><span style=color:#111>);</span>

<span style=color:#75715e>// 指定のタグの中から「いいい」というテキストを持つaタグを探す
</span><span style=color:#75715e>// ※XPathの先頭に「.」が必要。無いとページ全体を探索する。
</span><span style=color:#75715e></span><span style=color:#00a8c8>const</span> <span style=color:#75af00>parent</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>$</span><span style=color:#111>(</span><span style=color:#d88200>&#34;div#container&#34;</span><span style=color:#111>);</span>
<span style=color:#00a8c8>const</span> <span style=color:#75af00>elements2</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>parent</span><span style=color:#111>.</span><span style=color:#75af00>$x</span><span style=color:#111>(</span><span style=color:#d88200>&#39;.//a[contains(text(), &#34;いいい&#34;)]&#39;</span><span style=color:#111>);</span>
</code></pre></div><h2 id=クリックする>クリックする</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// 定義
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>click</span><span style=color:#111>(</span><span style=color:#75af00>selector</span><span style=color:#111>[,</span> <span style=color:#75af00>options</span><span style=color:#111>]);</span>
<span style=color:#75715e>// サンプル
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>click</span><span style=color:#111>(</span><span style=color:#d88200>&#34;#submit-button&#34;</span><span style=color:#111>);</span>
</code></pre></div><p>パラメータ：</p><ul><li><code>selector</code> &lt;string> 対象となる要素のセレクタ</li><li><code>options</code> &lt;Object></li><li><code>button</code> &lt;"left"|"right"|"middle"> 既定値：<code>left</code></li><li><code>clickCount</code> &lt;number> 既定値：<code>1</code></li><li><code>delay</code> &lt;number> <code>mousedown</code>と<code>mouseup</code>の間隔をミリ秒で指定する。既定値：<code>0</code></li></ul><p>クリックでナビゲーションが発生する場合、<code>page.waitForNavigation()</code> を使ってナビゲーションが終わるまで待機する必要がある。</p><h3 id=クリック後のページ移動を待つ>クリック後のページ移動を待つ</h3><p>クリックなどでナビゲーションが発生する場合、クリックした後ナビゲーションが終わるのを待つ必要がある。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#00a8c8>const</span> <span style=color:#111>[</span><span style=color:#75af00>response</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#111>Promise</span><span style=color:#111>.</span><span style=color:#75af00>all</span><span style=color:#111>([</span>
  <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>waitForNavigation</span><span style=color:#111>(</span><span style=color:#75af00>waitOptions</span><span style=color:#111>),</span>
  <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>click</span><span style=color:#111>(</span><span style=color:#75af00>selector</span><span style=color:#111>,</span> <span style=color:#75af00>clickOptions</span><span style=color:#111>),</span>
<span style=color:#111>]);</span>
</code></pre></div><p>ページ移動を伴うナビゲーションであれば <code>waitUntil</code> に <code>load</code> や <code>domcontentloaded</code> などを指定すればよいが、非同期のナビゲーションであれば、<code>networkidle0</code> などを指定する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// 定義
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>waitForNavigation</span><span style=color:#111>([</span><span style=color:#75af00>option</span><span style=color:#111>]);</span>
</code></pre></div><ul><li><code>options</code> &lt;Object><ul><li><code>timeout</code> &lt;number> 最大待機時間をミリ秒で指定する。0を指定するとタイムアウトなしになる。既定値：30秒。既定値は<code>page.setDefaultNavigationTimeout(timeout)</code>または<code>page.setDefaultTimeout(timeout)</code>で変更可能。</li><li><code>waitUntil</code> &lt;string|Array&lt;string&#187; どれくらい待つか指定する。既定値：<code>load</code>。複数指定した場合は、指定したすべてのイベントが終わるまで待つ。指定できる値は<code>page.goto()</code>と同じ。</li></ul></li><li>戻り値: &lt;Promise&lt;?Response&#187;</li></ul><p>waitForNavigation を使っても読み込み完了の検知がうまくいかない場合は、「ページの描画が終わるのを待つ」の章を参照。</p><h3 id=ctrlキーを押しながらリンクをクリックする>Ctrlキーを押しながらリンクをクリックする</h3><p>単純にリンクを新しいタブで開きたいなら、<code>browser.newPage()</code>してから指定のURLへ移動するのが最もシンプルだと思うが、Ctrlキーを押しながら<code>click()</code>を実行することでも、リンクを新しいタブで開くことができる。ただしこの場合、新しいタブに自動的にフォーカスが移らないので注意。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// Ctrlキーを押す(ControlRightでもOK)
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>keyboard</span><span style=color:#111>.</span><span style=color:#75af00>down</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ControlLeft&#34;</span><span style=color:#111>);</span>
<span style=color:#75715e>// リンクを押す
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>click</span><span style=color:#111>(</span><span style=color:#d88200>&#34;a&#34;</span><span style=color:#111>);</span>
<span style=color:#75715e>// Ctrlキーを話す
</span><span style=color:#75715e></span><span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>keyboard</span><span style=color:#111>.</span><span style=color:#75af00>up</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ControlLeft&#34;</span><span style=color:#111>);</span>

<span style=color:#75715e>// 開いたタブを最前面にする
</span><span style=color:#75715e></span><span style=color:#00a8c8>const</span> <span style=color:#75af00>pages</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>browser</span><span style=color:#111>.</span><span style=color:#75af00>pages</span><span style=color:#111>();</span>
<span style=color:#00a8c8>const</span> <span style=color:#75af00>newPage</span> <span style=color:#f92672>=</span> <span style=color:#75af00>pages</span><span style=color:#111>[</span><span style=color:#75af00>pages</span><span style=color:#111>.</span><span style=color:#75af00>length</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
<span style=color:#75af00>await</span> <span style=color:#75af00>newPage</span><span style=color:#111>.</span><span style=color:#75af00>bringToFront</span><span style=color:#111>();</span>
</code></pre></div><h2 id=文字を入力する>文字を入力する</h2><p><code>page.type(selector, text[, options])</code></p><ul><li><code>selector</code> &lt;string> 対象となる要素のセレクタ</li><li><code>text</code> &lt;string> 入力する文字列</li><li><code>options</code> &lt;Object></li><li><code>delay</code> &lt;number> キー入力間の待機時間をミリ秒で指定する。既定値：0。</li></ul><h2 id=テキストを取得する>テキストを取得する</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#00a8c8>const</span> <span style=color:#75af00>ele</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>$</span><span style=color:#111>(</span><span style=color:#d88200>&#34;.scrape&#34;</span><span style=color:#111>);</span>
<span style=color:#00a8c8>const</span> <span style=color:#75af00>text</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>evaluate</span><span style=color:#111>(</span><span style=color:#75af00>elm</span> <span style=color:#111>=&gt;</span> <span style=color:#75af00>elm</span><span style=color:#111>.</span><span style=color:#75af00>textContent</span><span style=color:#111>,</span> <span style=color:#75af00>ele</span><span style=color:#111>);</span>
</code></pre></div><p><code>Page</code>オブジェクトにテキスト取得のメソッドはないため、<code>evaluate</code>メソッドを代わりに使用する。
<code>evaluate</code>メソッドは、引数で指定した関数をページ内で実行する。第1引数に実行する関数、第2引数に関数へ渡す引数を指定する。この引数に、<code>page.$()</code>などで取得した<code>ElementHandle</code>を渡すことが可能。</p><h2 id=指定秒を待つ>指定秒を待つ</h2><p><code>page.waitForTimeout(milliseconds)</code></p><p>引数にミリ秒を指定する。</p><h2 id=要素が表示されるまで待つ>要素が表示されるまで待つ</h2><p><code>page.waitForSelector(selector, {visible:true});</code></p><h2 id=ページの描画が終わるのを待つ>ページの描画が終わるのを待つ</h2><p>参考：<a href=https://stackoverflow.com/questions/52497252/puppeteer-wait-until-page-is-completely-loaded target=_blank rel=noopener>javascript - Puppeteer wait until page is completely loaded - Stack Overflow</a></p><p>新しいWebページを開いた後、ページが読み込まれるのを待つには <code>page.waitForNavigation()</code> などを使えばよいが、
非同期でいろいろ読み込まれたり、読み込まれた後もスクリプトが動作していてページの描画が終わっていない場合がある。
これを解決するために、Webページの内容が一定時間変化しないのを待つ、という方法もある。
下記サンプルでは、WebページのHTMLの文字数をもとに、HTMLの書き換えが一定時間収まるのを待つ。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75af00>async</span> <span style=color:#00a8c8>function</span> <span style=color:#75af00>waitTillHTMLRendered</span><span style=color:#111>(</span><span style=color:#75af00>page</span><span style=color:#111>,</span> <span style=color:#75af00>timeout</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>30000</span><span style=color:#111>)</span> <span style=color:#111>{</span>
	<span style=color:#00a8c8>const</span> <span style=color:#75af00>checkDurationMsecs</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span><span style=color:#111>;</span>  <span style=color:#75715e>// チェックする間隔(ミリ秒)
</span><span style=color:#75715e></span>	<span style=color:#00a8c8>const</span> <span style=color:#75af00>minStableSizeIterations</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span><span style=color:#111>;</span>  <span style=color:#75715e>// ○回チェックしてサイズに変化がなければOKとする
</span><span style=color:#75715e></span>	<span style=color:#00a8c8>const</span> <span style=color:#75af00>maxChecks</span> <span style=color:#f92672>=</span> <span style=color:#75af00>timeout</span> <span style=color:#f92672>/</span> <span style=color:#75af00>checkDurationMsecs</span><span style=color:#111>;</span>
	<span style=color:#00a8c8>let</span> <span style=color:#75af00>lastHTMLSize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
	<span style=color:#00a8c8>let</span> <span style=color:#75af00>checkCounts</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span>
	<span style=color:#00a8c8>let</span> <span style=color:#75af00>countStableSizeIterations</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
  
	<span style=color:#00a8c8>while</span><span style=color:#111>(</span><span style=color:#75af00>checkCounts</span><span style=color:#f92672>++</span> <span style=color:#f92672>&lt;=</span> <span style=color:#75af00>maxChecks</span><span style=color:#111>){</span>
		<span style=color:#00a8c8>let</span> <span style=color:#75af00>html</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>content</span><span style=color:#111>();</span>
		<span style=color:#00a8c8>let</span> <span style=color:#75af00>currentHTMLSize</span> <span style=color:#f92672>=</span> <span style=color:#75af00>html</span><span style=color:#111>.</span><span style=color:#75af00>length</span><span style=color:#111>;</span> 

		<span style=color:#00a8c8>let</span> <span style=color:#75af00>bodyHTMLSize</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>evaluate</span><span style=color:#111>(()</span> <span style=color:#111>=&gt;</span> <span style=color:#111>document</span><span style=color:#111>.</span><span style=color:#75af00>body</span><span style=color:#111>.</span><span style=color:#75af00>innerHTML</span><span style=color:#111>.</span><span style=color:#75af00>length</span><span style=color:#111>);</span>

		<span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>lastHTMLSize</span> <span style=color:#f92672>==</span> <span style=color:#75af00>currentHTMLSize</span><span style=color:#111>)</span> <span style=color:#111>{</span>
			<span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;last: &#39;</span><span style=color:#111>,</span> <span style=color:#75af00>lastHTMLSize</span><span style=color:#111>,</span> <span style=color:#d88200>&#39; == curr: &#39;</span><span style=color:#111>,</span> <span style=color:#75af00>currentHTMLSize</span><span style=color:#111>,</span> <span style=color:#d88200>&#34; body html size: &#34;</span><span style=color:#111>,</span> <span style=color:#75af00>bodyHTMLSize</span><span style=color:#111>);</span>
		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
			<span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;last: &#39;</span><span style=color:#111>,</span> <span style=color:#75af00>lastHTMLSize</span><span style=color:#111>,</span> <span style=color:#d88200>&#39; &lt;&gt; curr: &#39;</span><span style=color:#111>,</span> <span style=color:#75af00>currentHTMLSize</span><span style=color:#111>,</span> <span style=color:#d88200>&#34; body html size: &#34;</span><span style=color:#111>,</span> <span style=color:#75af00>bodyHTMLSize</span><span style=color:#111>);</span>
		<span style=color:#111>}</span>

		<span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>lastHTMLSize</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>currentHTMLSize</span> <span style=color:#f92672>==</span> <span style=color:#75af00>lastHTMLSize</span><span style=color:#111>)</span> <span style=color:#111>{</span>
			<span style=color:#75af00>countStableSizeIterations</span><span style=color:#f92672>++</span><span style=color:#111>;</span>
		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
			<span style=color:#75af00>countStableSizeIterations</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75715e>//reset the counter
</span><span style=color:#75715e></span>		<span style=color:#111>}</span>

		<span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>countStableSizeIterations</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>minStableSizeIterations</span><span style=color:#111>)</span> <span style=color:#111>{</span>
			<span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Page rendered fully..&#34;</span><span style=color:#111>);</span>
			<span style=color:#00a8c8>break</span><span style=color:#111>;</span>
		<span style=color:#111>}</span>

		  <span style=color:#75af00>lastHTMLSize</span> <span style=color:#f92672>=</span> <span style=color:#75af00>currentHTMLSize</span><span style=color:#111>;</span>
		  <span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>waitForTimeout</span><span style=color:#111>(</span><span style=color:#75af00>checkDurationMsecs</span><span style=color:#111>);</span>
	<span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h2 id=chromeで動的に生成される要素を調べる>Chromeで動的に生成される要素を調べる</h2><p>一時停止(F8)を押すか、要素で右クリック→「検証」を選ぶ。</p><p><a href=https://ja.stackoverflow.com/questions/24648/%E3%83%9E%E3%82%A6%E3%82%B9%E3%82%AB%E3%83%BC%E3%82%BD%E3%83%AB%E3%82%92%E4%B9%97%E3%81%9B%E3%81%A6%E3%81%84%E3%82%8B%E9%96%93%E3%81%A0%E3%81%91%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%82%8B%E8%A6%81%E7%B4%A0%E3%82%92-%E9%96%8B%E7%99%BA%E8%80%85%E3%83%84%E3%83%BC%E3%83%AB%E3%81%A7%E8%AA%BF%E3%81%B9%E3%82%8B%E3%81%AB%E3%81%AF target=_blank rel=noopener>javascript - マウスカーソルを乗せている間だけ表示される要素を、開発者ツールで調べるには - スタック・オーバーフロー</a></p><h2 id=ダイアログに対応する>ダイアログに対応する</h2><p>Webサイトが表示するダイアログに対して処理が必要な場合のサンプル。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// ダイアログが表示されたらOKを押す
</span><span style=color:#75715e></span><span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#34;dialog&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>async</span> <span style=color:#111>(</span><span style=color:#75af00>dialog</span><span style=color:#111>)=&gt;{</span>
    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;dialog message : &#34;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>dialog</span><span style=color:#111>.</span><span style=color:#75af00>message</span><span style=color:#111>());</span>
    <span style=color:#75af00>await</span> <span style=color:#75af00>dialog</span><span style=color:#111>.</span><span style=color:#75af00>accept</span><span style=color:#111>();</span>
<span style=color:#111>});</span>
</code></pre></div><p>一度だけ処理させたいなら、<code>page.once()</code>を使う方が良いかもしれない。使用方法は<code>page.on()</code>と同じ。</p><p><a href="https://pptr.dev/#?product=Puppeteer&version=v2.1.1&show=api-class-dialog" target=_blank rel=noopener>Dialogクラスの説明</a></p><h2 id=ログインが必要なページへのアクセス>ログインが必要なページへのアクセス</h2><p>以下の方法がある：</p><ul><li>IDとパスワードを入力してログインする動作をスクリプトに実装する。<ul><li>良いところ：単純で分かりやすい。</li><li>悪いところ：Googleには弾かれる。</li></ul></li><li>ChromeからCookieをエクスポートし、それをpuppeteerに読み込ませて使用する。<ul><li>良いところ：Googleにもログインできる。</li><li>悪いところ：Cookieをエクスポートするのが手間。Cookieの有効期限も考慮しなければならない。</li></ul></li></ul><p>アカウント＋パスワードでGoogleにログインするスクリプトを作成し実行したところ、ページが以下のようになってログインできなかった。
<img src=2021-08-30-20-01-13.png alt></p><p>puppeteerの操作を自動テストツールと判定して、ログインを阻止していると思われる。こういう場合、Cookieを使う方法だとログインせずともページがログイン後の状態となって上手く動作する場合がある。</p><h3 id=cookieを使用してログインする>Cookieを使用してログインする</h3><p>Webサイトへログインした後のCookieを保存しておき、それをpuppeteerに読み込ませることで、自動化中もログイン後と同じ状態にする。</p><h4 id=editthiscookieのインストール>EditThisCookieのインストール</h4><p>Chromeから簡単にCookieをエクスポートするためのツールをインストールする。EditThisCookieはChrome拡張機能として提供されている。</p><h4 id=cookieのエクスポート>Cookieのエクスポート</h4><p>Chromeで目的のWebサイトへログインした後、EditThisCookieのアイコンをクリックして、エクスポートのアイコンをクリックする。</p><p><img src=2021-08-30-20-01-33.png alt></p><p>Cookieの内容がJSON形式でクリップボードへエクスポートされるので、テキストファイルへ貼り付けて保存する。</p><h4 id=puppeteerでcookieを読み込む>puppeteerでCookieを読み込む</h4><p>保存したCookieのファイルを、puppeteerで読み込む。目的のサイトへ移動する前にCookieを読み込んでおくこと。また、サンプルには実装していないが、Cookieの有効期限が切れた場合も考慮しておく必要がある。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#00a8c8>const</span> <span style=color:#75af00>puppeteer</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#34;puppeteer-core&#34;</span><span style=color:#111>);</span>
<span style=color:#00a8c8>const</span> <span style=color:#75af00>config</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#34;config&#34;</span><span style=color:#111>);</span>
<span style=color:#00a8c8>const</span> <span style=color:#75af00>fs</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#34;fs&#34;</span><span style=color:#111>);</span>

<span style=color:#75af00>async</span> <span style=color:#00a8c8>function</span> <span style=color:#75af00>useCookieSample</span><span style=color:#111>(</span><span style=color:#75af00>page</span><span style=color:#111>)</span> <span style=color:#111>{</span>

	<span style=color:#00a8c8>let</span> <span style=color:#75af00>content</span> <span style=color:#f92672>=</span> <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>readFileSync</span><span style=color:#111>(</span><span style=color:#d88200>&#34;cookie.json&#34;</span><span style=color:#111>);</span>
	<span style=color:#00a8c8>let</span> <span style=color:#75af00>cookie</span> <span style=color:#f92672>=</span> <span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>parse</span><span style=color:#111>(</span><span style=color:#75af00>content</span><span style=color:#111>);</span>

	<span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>setCookie</span><span style=color:#111>(...</span><span style=color:#75af00>cookie</span><span style=color:#111>);</span>

	<span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#00a8c8>goto</span><span style=color:#111>(</span><span style=color:#d88200>&#34;https://gmailのURL&#34;</span><span style=color:#111>,</span> <span style=color:#111>{</span>
		<span style=color:#d88200>&#34;waitUntil&#34;</span> <span style=color:#f92672>:</span> <span style=color:#d88200>&#34;domcontentloaded&#34;</span>
	<span style=color:#111>});</span>
<span style=color:#111>}</span>
</code></pre></div><p>参考：<a href=https://stackoverflow.com/a/56629942 target=_blank rel=noopener>javascript - login into gmail fails for unknown reason - Stack Overflow</a></p><h2 id=navigatorwebdriver-をオフにする>navigator.webdriver をオフにする</h2><p>Webサイトによっては、puppeteerでアクセスするとツールであることを判定して、通常とは異なるページを返す。Webサイト側がチェックをかけているのだが、その方法の一つとして、JavaScriptを使って簡単に判定できる。
<code>navigator.webdriver</code> というプロパティで、puppeteer で Chrome を動かしているときもこの値が <code>true</code> になっている。</p><p>参考：<a href=https://developer.mozilla.org/ja/docs/Web/API/Navigator/webdriver target=_blank rel=noopener>Navigator.webdriver - Web API | MDN</a></p><p>puppeteer側でこのプロパティをなくすことが可能。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#00a8c8>const</span> <span style=color:#75af00>page</span> <span style=color:#f92672>=</span> <span style=color:#75af00>await</span> <span style=color:#75af00>browser</span><span style=color:#111>.</span><span style=color:#75af00>newPage</span><span style=color:#111>();</span>
<span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>evaluateOnNewDocument</span><span style=color:#111>(()</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
	<span style=color:#111>Object</span><span style=color:#111>.</span><span style=color:#75af00>defineProperty</span><span style=color:#111>(</span><span style=color:#75af00>navigator</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;webdriver&#39;</span><span style=color:#111>,</span> <span style=color:#111>()=&gt;{});</span>
	<span style=color:#00a8c8>delete</span> <span style=color:#75af00>navigator</span><span style=color:#111>.</span><span style=color:#75af00>__proto__</span><span style=color:#111>.</span><span style=color:#75af00>webdriver</span><span style=color:#111>;</span>
<span style=color:#111>});</span>
<span style=color:#75af00>await</span> <span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#00a8c8>goto</span><span style=color:#111>(</span><span style=color:#d88200>&#34;https://www.yahoo.co.jp/&#34;</span><span style=color:#111>);</span>
</code></pre></div><p>ただ、自分で試行錯誤するより、有志のライブラリの力を借りる方が便利だと思う。</p><p><a href=https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth target=_blank rel=noopener>berstend/puppeteer-extra</a></p></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>