<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-0L8LJXJEKX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-0L8LJXJEKX');</script><meta property="og:title" content="今日の当番をTeamsに通知するサンプル"><meta property="og:description" content="はじめに 職場の電話当番とか掃除当番の表をExcelで管理して、毎日決まった時間に今日と明日の当番をTeamsへ通知するサンプル。 使うもの： Excel Office Scripts Power Automate SharePoint (または OneDrive) Teams 当番表の作成 当番表と、担当者のメールア"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/azure/logic-apps/sample-toban-notification/"><meta property="article:published_time" content="2022-02-28T16:07:40+09:00"><meta property="article:modified_time" content="2022-02-28T16:07:40+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="今日の当番をTeamsに通知するサンプル"><meta name=twitter:description content="はじめに 職場の電話当番とか掃除当番の表をExcelで管理して、毎日決まった時間に今日と明日の当番をTeamsへ通知するサンプル。 使うもの： Excel Office Scripts Power Automate SharePoint (または OneDrive) Teams 当番表の作成 当番表と、担当者のメールア"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>今日の当番をTeamsに通知するサンプル - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Logic Apps (Power Automateも含む)</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#当番表の作成>当番表の作成</a></li><li><a href=#office-スクリプトの作成>Office スクリプトの作成</a></li><li><a href=#power-automate-でフローの作成>Power Automate でフローの作成</a><ul><li><a href=#今日と明日の日付を取得>今日と明日の日付を取得</a></li><li><a href=#当番表のスクリプトを実行する>当番表のスクリプトを実行する</a></li><li><a href=#担当者の有無で分岐>担当者の有無で分岐</a></li><li><a href=#チャットメッセージの作成>チャットメッセージの作成</a></li><li><a href=#チャットメッセージを送る>チャットメッセージを送る</a></li></ul></li><li><a href=#テストする>テストする</a></li></ul></nav></aside></div><div class=main><article><h1>今日の当番をTeamsに通知するサンプル</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2022-02-28 16:07:40 +0900 +0900" itemprop=datePublished>2022-02-28</time></div><div></div></div><h2 id=はじめに>はじめに</h2><p>職場の電話当番とか掃除当番の表をExcelで管理して、毎日決まった時間に今日と明日の当番をTeamsへ通知するサンプル。</p><p>使うもの：</p><ul><li>Excel</li><li>Office Scripts</li><li>Power Automate</li><li>SharePoint (または OneDrive)</li><li>Teams</li></ul><h2 id=当番表の作成>当番表の作成</h2><p>当番表と、担当者のメールアドレスの2つの表を用意する。</p><p><img src=2022-02-28-16-13-02.png alt></p><p>いずれも「テーブル」にしておく。
このExcelファイルは SharePoint の任意の場所へ置き、Power Automate からアクセスできるようにしておく。</p><h2 id=office-スクリプトの作成>Office スクリプトの作成</h2><p>指定した日付で当番表を検索し、担当者の名前とメールアドレスをJSON形式で返す Office スクリプトを作成する。
スクリプトの内容は下記の通り。</p><ol><li>main 関数の引数に <code>dtstr : string</code> を追加する。この引数は、日付を yyyy-MM-dd 形式で受け取る。</li><li>当番表のテーブルの日付列に、引数の日付でフィルタを設定する。</li><li>フィルタに一致した行の担当者名を取得する。</li><li>担当者名をキーにして、メールアドレスのテーブルにフィルタを設定する。</li><li>フィルタに一致したメールアドレスを取得する。</li><li>取得した担当者名とメールアドレスを JSON 形式にまとめて戻り値にする。</li></ol><p>引数の日付は applyValuesFilter メソッドの仕様上、yyyy-MM-dd 形式でなければならない。</p><p>サンプルを下記に記載。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#00a8c8>function</span> <span style=color:#75af00>main</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span>: <span style=color:#00a8c8>ExcelScript.Workbook</span>
  <span style=color:#111>,</span> <span style=color:#75af00>dtstr</span>: <span style=color:#00a8c8>string</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>tantosha</span> <span style=color:#f92672>=</span> <span style=color:#75af00>getTantosha</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span><span style=color:#111>,</span> <span style=color:#75af00>dtstr</span><span style=color:#111>);</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>mailAddress</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span> <span style=color:#00a8c8>as</span> <span style=color:#00a8c8>string</span><span style=color:#111>;</span>

  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>tantosha</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#75af00>mailAddress</span> <span style=color:#f92672>=</span> <span style=color:#75af00>getMailAddress</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span><span style=color:#111>,</span> <span style=color:#75af00>tantosha</span><span style=color:#111>);</span>
  <span style=color:#111>}</span>

  <span style=color:#00a8c8>return</span> <span style=color:#111>{</span><span style=color:#d88200>&#34;tantosha&#34;</span><span style=color:#f92672>:</span> <span style=color:#75af00>tantosha</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;mailAddress&#34;</span><span style=color:#f92672>:</span> <span style=color:#75af00>mailAddress</span><span style=color:#111>};</span>
<span style=color:#111>}</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> * 担当者取得
</span><span style=color:#75715e> */</span>
<span style=color:#00a8c8>function</span> <span style=color:#75af00>getTantosha</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span>: <span style=color:#00a8c8>ExcelScript.Workbook</span>
  <span style=color:#111>,</span> <span style=color:#75af00>dtstr</span>: <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>result</span>: <span style=color:#00a8c8>string</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#111>;</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>sheet</span> <span style=color:#f92672>=</span> <span style=color:#75af00>workbook</span><span style=color:#111>.</span><span style=color:#75af00>getWorksheet</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Sheet1&#34;</span><span style=color:#111>);</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>table</span> <span style=color:#f92672>=</span> <span style=color:#75af00>sheet</span><span style=color:#111>.</span><span style=color:#75af00>getTable</span><span style=color:#111>(</span><span style=color:#d88200>&#34;メール当番&#34;</span><span style=color:#111>);</span>

  <span style=color:#75715e>// フィルタ
</span><span style=color:#75715e></span>  <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>clearFilters</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>column</span> <span style=color:#f92672>=</span> <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>getColumnByName</span><span style=color:#111>(</span><span style=color:#d88200>&#34;日付&#34;</span><span style=color:#111>);</span>
  <span style=color:#75af00>column</span><span style=color:#111>.</span><span style=color:#75af00>getFilter</span><span style=color:#111>().</span><span style=color:#75af00>applyValuesFilter</span><span style=color:#111>([{</span> <span style=color:#75af00>date</span>: <span style=color:#00a8c8>dtstr</span><span style=color:#111>,</span> <span style=color:#75af00>specificity</span>: <span style=color:#00a8c8>ExcelScript.FilterDatetimeSpecificity.day</span> <span style=color:#111>}]);</span>

  <span style=color:#75715e>// 結果を取得
</span><span style=color:#75715e></span>  <span style=color:#00a8c8>let</span> <span style=color:#75af00>range</span> <span style=color:#f92672>=</span> <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>getRange</span><span style=color:#111>().</span><span style=color:#75af00>getVisibleView</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>range</span><span style=color:#111>.</span><span style=color:#75af00>getRowCount</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>clearFilters</span><span style=color:#111>();</span>
    <span style=color:#00a8c8>return</span> <span style=color:#75af00>result</span><span style=color:#111>;</span>
  <span style=color:#111>}</span>

  <span style=color:#75715e>// values は Object[][] 型。1行目にヘッダー、2行目以降にデータ行。
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 担当者の値を返す
</span><span style=color:#75715e></span>  <span style=color:#75af00>result</span> <span style=color:#f92672>=</span> <span style=color:#75af00>range</span><span style=color:#111>.</span><span style=color:#75af00>getValues</span><span style=color:#111>()[</span><span style=color:#ae81ff>1</span><span style=color:#111>][</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#00a8c8>as</span> <span style=color:#00a8c8>string</span><span style=color:#111>;</span>

  <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>clearFilters</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>return</span> <span style=color:#75af00>result</span><span style=color:#111>;</span>
<span style=color:#111>}</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> * メールアドレス取得
</span><span style=color:#75715e> */</span>
<span style=color:#00a8c8>function</span> <span style=color:#75af00>getMailAddress</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span>: <span style=color:#00a8c8>ExcelScript.Workbook</span>
  <span style=color:#111>,</span> <span style=color:#75af00>tantosha</span>: <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>result</span>: <span style=color:#00a8c8>string</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#111>;</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>sheet</span> <span style=color:#f92672>=</span> <span style=color:#75af00>workbook</span><span style=color:#111>.</span><span style=color:#75af00>getWorksheet</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Sheet1&#34;</span><span style=color:#111>);</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>table</span> <span style=color:#f92672>=</span> <span style=color:#75af00>sheet</span><span style=color:#111>.</span><span style=color:#75af00>getTable</span><span style=color:#111>(</span><span style=color:#d88200>&#34;担当者メールアドレス&#34;</span><span style=color:#111>);</span>

  <span style=color:#75715e>// フィルタ
</span><span style=color:#75715e></span>  <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>clearFilters</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>column</span> <span style=color:#f92672>=</span> <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>getColumnByName</span><span style=color:#111>(</span><span style=color:#d88200>&#34;担当者&#34;</span><span style=color:#111>);</span>
  <span style=color:#75af00>column</span><span style=color:#111>.</span><span style=color:#75af00>getFilter</span><span style=color:#111>().</span><span style=color:#75af00>applyValuesFilter</span><span style=color:#111>([</span><span style=color:#75af00>tantosha</span><span style=color:#111>]);</span>

  <span style=color:#75715e>// 結果を取得
</span><span style=color:#75715e></span>  <span style=color:#00a8c8>let</span> <span style=color:#75af00>range</span> <span style=color:#f92672>=</span> <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>getRange</span><span style=color:#111>().</span><span style=color:#75af00>getVisibleView</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>range</span><span style=color:#111>.</span><span style=color:#75af00>getRowCount</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>clearFilters</span><span style=color:#111>();</span>
    <span style=color:#00a8c8>return</span> <span style=color:#75af00>result</span><span style=color:#111>;</span>
  <span style=color:#111>}</span>

  <span style=color:#75715e>// values は Object[][] 型。1行目にヘッダー、2行目以降にデータ行。
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 担当者の値を返す
</span><span style=color:#75715e></span>  <span style=color:#75af00>result</span> <span style=color:#f92672>=</span> <span style=color:#75af00>range</span><span style=color:#111>.</span><span style=color:#75af00>getValues</span><span style=color:#111>()[</span><span style=color:#ae81ff>1</span><span style=color:#111>][</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#00a8c8>as</span> <span style=color:#00a8c8>string</span><span style=color:#111>;</span>

  <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>clearFilters</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>return</span> <span style=color:#75af00>result</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><h2 id=power-automate-でフローの作成>Power Automate でフローの作成</h2><p>「スケジュール済みクラウドフロー」を新規作成する。繰り返しの頻度や実行時間を必要に応じて設定する。</p><p><img src=2022-02-28-16-32-49.png alt></p><p>フローの全体像は下記の通り。</p><p><img src=2022-02-28-16-34-55.png alt></p><h3 id=今日と明日の日付を取得>今日と明日の日付を取得</h3><p>「現在の時刻」を使い、実行時の日時を取得する。</p><p>そのあと、「タイムゾーンの変換」を使い、現在日時のタイムゾーンと書式を変換する。</p><p><img src=2022-02-28-16-42-39.png alt></p><ul><li>書式設定文字列：yyyy-MM-dd (リストにはないので、カスタム値として直接入力する)</li><li>変換元のタイムゾーン：UTC</li><li>変換先のタイムゾーン：UTC+09:00 大阪、札幌、東京</li></ul><p>明日の日付を取得するには「未来の時間の取得」を使う。</p><p><img src=2022-02-28-16-46-24.png alt></p><p>こちらの取得結果も同じようにタイムゾーンと書式を変換する。</p><h3 id=当番表のスクリプトを実行する>当番表のスクリプトを実行する</h3><p>今日と明日の日付を引数にして、先に作成した Office スクリプトを実行する。</p><p>Excel Online (Business) の「スクリプトの実行 (RunScriptProd)」を使う。</p><p><img src=2022-02-28-16-49-57.png alt></p><ul><li>場所、ファイル ： 当番表を指定する。</li><li>スクリプト ： 前の手順で作成したスクリプトの名前。</li><li>dtstr ： 書式変換後の今日の日付または明日の日付。</li></ul><h3 id=担当者の有無で分岐>担当者の有無で分岐</h3><p>今日も明日も担当者がいない場合は、ここでフローを終了させている (休日などの場合を考慮)。</p><p><img src=2022-02-28-16-56-56.png alt></p><p>Office スクリプトは担当者を取得できない場合は担当者名を null にするので、フローの条件文で empty 関数を使う。</p><p>条件式の左側のサンプルを下記に記載する。</p><pre><code>empty(outputs('今日の当番を取得')?['body/result/tantosha'])
</code></pre><p>実際に入力するときは <code>empty()</code> だけ入力し、カッコの中は「動的な値」から選択して挿入するとよい。</p><h3 id=チャットメッセージの作成>チャットメッセージの作成</h3><p>「変数を初期化する」を使い、「チャットメッセージ」という名前の変数を定義する。種類は文字列、値は空白にする。</p><p><img src=2022-02-28-17-03-52.png alt></p><p>今回は、担当者のメールアドレスがある場合はメンションを挿入し、メールアドレスがない場合は担当者名をメッセージに挿入する。</p><p><img src=2022-02-28-17-05-47.png alt></p><p>メンションを挿入するには、メールアドレスを <code>&lt;at>&lt;/at></code> で囲む。</p><p><img src=2022-02-28-17-07-01.png alt></p><p>変数に文字列を追加するには、「文字列変数に追加」を使う。</p><h3 id=チャットメッセージを送る>チャットメッセージを送る</h3><p>Teams コネクタの「チャットまたはチャネルでメッセージを投稿する (PostMessageToConversation)」を使う。</p><p><img src=2022-02-28-17-11-13.png alt></p><p>メッセージ欄は動的な値があるときの編集が分かりづらいので、コードビューに切り替えて編集するとよい。</p><p><img src=2022-02-28-17-14-07.png alt></p><h2 id=テストする>テストする</h2><p>作成したフローを実行すると、下記のようなメッセージが Teams に送られる。</p><p><img src=2022-02-28-17-17-22.png alt></p></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>