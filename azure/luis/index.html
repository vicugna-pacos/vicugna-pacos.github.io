<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-0L8LJXJEKX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-0L8LJXJEKX');</script><meta property="og:title" content="LUIS"><meta property="og:description" content="はじめに 参考： https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-model https://qiita.com/annie/items/5fdc9030521f8a0ed61c LUISは、ユーザーの発話から意図とデータを抽出できるようにするサービス。チャットボットなどで使う。 つまりLUISを単体で使うことはほとんどなく、チャットボットなどクライアントアプリ"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/azure/luis/"><meta property="article:published_time" content="2020-12-25T12:55:45+09:00"><meta property="article:modified_time" content="2021-02-02T10:14:53+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="LUIS"><meta name=twitter:description content="はじめに 参考： https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-model https://qiita.com/annie/items/5fdc9030521f8a0ed61c LUISは、ユーザーの発話から意図とデータを抽出できるようにするサービス。チャットボットなどで使う。 つまりLUISを単体で使うことはほとんどなく、チャットボットなどクライアントアプリ"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>LUIS - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#cognitive-services-の作成>Cognitive Services の作成</a></li><li><a href=#app-の作成>App の作成</a></li><li><a href=#インテント>インテント</a><ul><li><a href=#none-について>None について</a></li></ul></li><li><a href=#entity>Entity</a><ul><li><a href=#機械学習エンティティ>機械学習エンティティ</a></li><li><a href=#定義済みのエンティティ>定義済みのエンティティ</a></li></ul></li><li><a href=#パターン>パターン</a></li><li><a href=#ベストプラクティス>ベストプラクティス</a></li></ul></nav></aside></div><div class=main><article><h1>LUIS</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-12-25 12:55:45 +0900 +0900" itemprop=datePublished>2020-12-25</time>
(最終更新：<time datetime="2021-02-02 10:14:53 +0900 +0900" itemprop=dateModified>2021-02-02</time>)</div><div></div></div><h2 id=はじめに>はじめに</h2><p>参考：</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-model>https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-model</a></li><li><a href=https://qiita.com/annie/items/5fdc9030521f8a0ed61c>https://qiita.com/annie/items/5fdc9030521f8a0ed61c</a></li></ul><p>LUISは、ユーザーの発話から意図とデータを抽出できるようにするサービス。チャットボットなどで使う。
つまりLUISを単体で使うことはほとんどなく、チャットボットなどクライアントアプリがあることが前提で、
そのチャットボットにどんな機能を持たせるかが決まっていないと、LUISを作れない。</p><h2 id=cognitive-services-の作成>Cognitive Services の作成</h2><p>Azure リソースの Language Understanding を作成する。</p><p><img src=2021-02-10-14-20-19.png alt></p><p>自然言語の編集は下記ポータルサイトで行う。</p><p><a href=https://www.luis.ai/>https://www.luis.ai/</a></p><p>はじめてアクセスする場合、Azureアカウントの作成またはサインインをした後、そのアカウントに Cognitive Services を作成する流れになる。
LUISポータルサイトでリソースを作成する場合、新しいリソースグループの作成ができないので、Azureポータルサイトで、リソースグループと Cognitive Services を作っておいた方がいいかもしれない。</p><h2 id=app-の作成>App の作成</h2><p>appは、チャットボットなどLUISを使いたいクライアントアプリの単位で作成する。</p><h2 id=インテント>インテント</h2><p>インテント とは 意図 のこと。LUISは、まずユーザーの発話を意図で分類する。
例えば、ピザの注文をできるボットを作る場合、インテントは下記のようになる。</p><ul><li><code>OrderPizza</code> - ピザの注文内容を受け付ける。</li><li><code>Greeting</code> - ボットと会話を始めるための挨拶。</li><li><code>ConfirmOrder</code> - 注文内容を確定する。「それでいいです」とか「了解」とか。</li></ul><p>なお、インテントの名前は日本語も指定できる。</p><p>開発者は、<code>OrderPizza</code> のインテントに対し、いくつか例文を追加する。例えば下記の通り。</p><ul><li>ピザを注文したいのですが</li><li>ピザください</li><li>マルゲリータピザください</li></ul><p>1つのインテントに対し、例文は15個程度用意するのが一番良い。
また、インテントごとの例文の数は、アプリ内でバランスが取れている必要がある。
例えば、特定のインテントに10個の例文があるのに対して、他のインテントの例文が500個もある状態はよくない。
例文の数に偏りがある場合は、多い方をパターンにまとめられないか検討すると良い。
なお、None インテントはこのバランスの母数に含めない。None インテントの例文は、全体のうち10%を占めるようにするのが良い。</p><h3 id=none-について>None について</h3><p>必ず既定で作成され、削除もできないインテント。
自分が作成したインテントのいずれにも該当しない例文を入れておく。
これを入れておかないと、全く関係のない発話「音楽をかけて」に対して、<code>OrderPizza</code> のインテントに分類してしまったりする。
それを防ぐため、「音楽をかけて」を None のインテントに登録しておくとよい。</p><h2 id=entity>Entity</h2><p>参考：<a href=https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-entity-types target=_blank rel=noopener>Entity types - LUIS - Azure Cognitive Services | Microsoft Docs</a></p><p>エンティティは、発話から取り出したデータを格納するもの。
例えば「マルゲリータピザとサイドメニューのサラダをください」と言われたとき、
「マルゲリータピザ」と「シーザーサラダ」を注文したのだと理解したい。
そういうときに、あらかじめ「マルゲリータピザ」と「シーザーサラダ」を固有名詞としてエンティティに登録しておく。</p><p>エンティティにはいくつか種類がある。</p><ul><li>機械学習 エンティティ</li><li>非 機械学習 エンティティ<ul><li>正規表現</li><li>リスト</li><li>定義済み (pre-build)</li></ul></li></ul><p>このうち、一番優先して採用すべきなのが機械学習エンティティとのこと。</p><h3 id=機械学習エンティティ>機械学習エンティティ</h3><p>機械学習エンティティは、他のエンティティを子要素として構造化できる。</p><h3 id=定義済みのエンティティ>定義済みのエンティティ</h3><p><a href=https://docs.microsoft.com/ja-jp/azure/cognitive-services/luis/luis-reference-prebuilt-entities target=_blank rel=noopener>すべての作成済みエンティティ - LUIS - Azure Cognitive Services | Microsoft Docs</a></p><p>電話番号とかメールアドレスとか、汎用的なエンティティはあらかじめ用意されている。
上記ドキュメントに言語ごとの一覧によると日本語も一部サポートされているっぽいが、実際に使えるかどうかは不明。</p><p>これ以外に、<a href=https://github.com/microsoft/Recognizers-Text target=_blank rel=noopener>Microsoft Recognizers Text の GitHub リポジトリ</a> を調べてみると日本語のエンティティが定義されている。
このリポジトリが LUIS の 定義済みエンティティの元ネタになるっぽいが、実際は存在しないのでよくわからない。
さらにパターンが YAML ファイルになっていて、JSON をインポート形式としている LUIS には取り込めなさそう。</p><h2 id=パターン>パターン</h2><p>参考：<a href=https://docs.microsoft.com/ja-jp/azure/cognitive-services/luis/luis-tutorial-pattern target=_blank rel=noopener>チュートリアル:パターン - LUIS - Azure Cognitive Services | Microsoft Docs</a></p><p>パターンは、発話が似通っている際に精度を向上させるために使用する。パターンを活用すれば、インテントの例文を増やさずに精度を向上できる。</p><p>例えば、社員の上司や部下は誰か、という質問に答えてくれるアプリを作るとする。
インテントと例文として下記を登録する。</p><ul><li>インテント：上司を聞く<ul><li>佐藤は誰の部下ですか</li><li>佐藤の上司は誰ですか</li></ul></li><li>インテント：部下を聞く<ul><li>佐藤は誰の上司ですか</li><li>佐藤の部下は誰ですか</li></ul></li><li>インテント：None<ul><li>猫大好き</li><li>ピザ食べたい</li></ul></li></ul><p>また、「佐藤」は エンティティ：社員名 として登録している。</p><p>この状態で　TRAIN → Production へ PUBLISH したあと、下記APIを実行する。
URL内の下記の部分はそれぞれ置き換える。</p><ul><li><code>YOUR-CUSTOM-SUBDOMAIN</code> - LUISを作ったリージョン。endpoint URL から分かる。</li><li><code>APP-ID</code> - LUIS のアプリID。</li><li><code>KEY-ID</code> - サブスクリプションキー。</li><li><code>YOUR_QUERY_HERE</code> - 「佐藤の上司は誰ですか」</li></ul><pre><code>https://YOUR-CUSTOM-SUBDOMAIN.api.cognitive.microsoft.com/luis/prediction/v3.0/apps/APP-ID/slots/production/predict?subscription-key=KEY-ID&amp;verbose=true&amp;show-all-intents=true&amp;log=true&amp;query=YOUR_QUERY_HERE
</code></pre><p>すると、結果として下記が返ってくる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#111>{</span>
    <span style=color:#f92672>&#34;query&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;佐藤の上司は誰ですか&#34;</span><span style=color:#111>,</span>
    <span style=color:#f92672>&#34;prediction&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
        <span style=color:#f92672>&#34;topIntent&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;部下を聞く&#34;</span><span style=color:#111>,</span>
        <span style=color:#f92672>&#34;intents&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
            <span style=color:#f92672>&#34;部下を聞く&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
                <span style=color:#f92672>&#34;score&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>0.481271327</span>
            <span style=color:#111>},</span>
            <span style=color:#f92672>&#34;上司を聞く&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
                <span style=color:#f92672>&#34;score&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>0.481269926</span>
            <span style=color:#111>},</span>
            <span style=color:#f92672>&#34;None&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
                <span style=color:#f92672>&#34;score&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>0.02978976</span>
            <span style=color:#111>}</span>
        <span style=color:#111>},</span>
        <span style=color:#f92672>&#34;entities&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
            <span style=color:#f92672>&#34;社員名&#34;</span><span style=color:#111>:</span> <span style=color:#111>[</span>
                <span style=color:#111>[</span>
                    <span style=color:#d88200>&#34;佐藤&#34;</span>
                <span style=color:#111>]</span>
            <span style=color:#111>],</span>
            <span style=color:#f92672>&#34;$instance&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
                <span style=color:#f92672>&#34;社員名&#34;</span><span style=color:#111>:</span> <span style=color:#111>[</span>
                    <span style=color:#111>{</span>
                        <span style=color:#f92672>&#34;type&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;社員名&#34;</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;text&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;佐藤&#34;</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;startIndex&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;length&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>2</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;modelTypeId&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>5</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;modelType&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;List Entity Extractor&#34;</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;recognitionSources&#34;</span><span style=color:#111>:</span> <span style=color:#111>[</span>
                            <span style=color:#d88200>&#34;model&#34;</span>
                        <span style=color:#111>]</span>
                    <span style=color:#111>}</span>
                <span style=color:#111>]</span>
            <span style=color:#111>}</span>
        <span style=color:#111>}</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p>「佐藤の上司は誰ですか」と聞いているにも関わらず、topIntent は僅差で「部下を聞く」になっている。
これは、「上司を聞く」と「部下を聞く」の例文が似通っているのが原因。
パターンを使うとこの状況を改善できる。</p><p>パターンとして、下記を登録する。</p><ul><li>インテント：上司を聞く<ul><li>{社員名}は誰の部下ですか</li><li>{社員名}の上司は誰ですか</li></ul></li><li>インテント：部下を聞く<ul><li>{社員名}は誰の上司ですか</li><li>{社員名}の部下は誰ですか</li></ul></li></ul><p>なお、パターンには必ずエンティティが含まれていないといけない。</p><p>これで再度 PUBLISH まで実行して、先ほどと同じAPIを実行すると、下記の結果が返ってくる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#111>{</span>
    <span style=color:#f92672>&#34;query&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;佐藤の上司は誰ですか&#34;</span><span style=color:#111>,</span>
    <span style=color:#f92672>&#34;prediction&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
        <span style=color:#f92672>&#34;topIntent&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;上司を聞く&#34;</span><span style=color:#111>,</span>
        <span style=color:#f92672>&#34;intents&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
            <span style=color:#f92672>&#34;上司を聞く&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
                <span style=color:#f92672>&#34;score&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>0.9999946</span>
            <span style=color:#111>},</span>
            <span style=color:#f92672>&#34;部下を聞く&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
                <span style=color:#f92672>&#34;score&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>0.0000184611981</span>
            <span style=color:#111>},</span>
            <span style=color:#f92672>&#34;None&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
                <span style=color:#f92672>&#34;score&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>6.185563e-7</span>
            <span style=color:#111>}</span>
        <span style=color:#111>},</span>
        <span style=color:#f92672>&#34;entities&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
            <span style=color:#f92672>&#34;社員名&#34;</span><span style=color:#111>:</span> <span style=color:#111>[</span>
                <span style=color:#111>[</span>
                    <span style=color:#d88200>&#34;佐藤&#34;</span>
                <span style=color:#111>]</span>
            <span style=color:#111>],</span>
            <span style=color:#f92672>&#34;$instance&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
                <span style=color:#f92672>&#34;社員名&#34;</span><span style=color:#111>:</span> <span style=color:#111>[</span>
                    <span style=color:#111>{</span>
                        <span style=color:#f92672>&#34;type&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;社員名&#34;</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;text&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;佐藤&#34;</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;startIndex&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;length&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>2</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;modelTypeId&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>5</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;modelType&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;List Entity Extractor&#34;</span><span style=color:#111>,</span>
                        <span style=color:#f92672>&#34;recognitionSources&#34;</span><span style=color:#111>:</span> <span style=color:#111>[</span>
                            <span style=color:#d88200>&#34;model&#34;</span>
                        <span style=color:#111>]</span>
                    <span style=color:#111>}</span>
                <span style=color:#111>]</span>
            <span style=color:#111>}</span>
        <span style=color:#111>}</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p>topIntent が「上司を聞く」になり、他のIntentともスコアが大きく差がついているのが分かる。</p><p>パターンは他にも、本や映画のタイトル等どこからどこまでがエンティティなのかが分かりづらい場合にも有用である。</p><h2 id=ベストプラクティス>ベストプラクティス</h2><p><a href=https://docs.microsoft.com/ja-jp/azure/cognitive-services/luis/luis-concept-best-practices>https://docs.microsoft.com/ja-jp/azure/cognitive-services/luis/luis-concept-best-practices</a></p></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>