<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>Adaptive Dialog とは - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li><li>Adaptive Dialog</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#前提条件>前提条件</a></li><li><a href=#adaptive-dialog-の構造>Adaptive Dialog の構造</a><ul><li><a href=#trigger>Trigger</a></li><li><a href=#action>Action</a></li><li><a href=#input>Input</a></li><li><a href=#generator>Generator</a></li><li><a href=#recognizer>Recognizer</a></li><li><a href=#メモリのスコープと-state-の管理>メモリのスコープと State の管理</a></li><li><a href=#declarative-assets>Declarative assets</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>Adaptive Dialog とは</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2021-01-08 13:27:54 +0900 +0900" itemprop=datePublished>2021-01-08</time></div><div></div></div><h2 id=はじめに>はじめに</h2><p>参考：</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-adaptive-dialog-introduction target=_blank rel=noopener>Introduction to adaptive dialogs - Bot Service | Microsoft Docs</a></li><li><a href=https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/adaptive-dialog target=_blank rel=noopener>Adaptive Dialog のサンプル (GitHubリポジトリ)</a></li></ul><p>ボットとユーザーの会話は Dialog を使って実装するが、会話の複雑さが上がるほど中断とか分岐とか考慮しなくてはいけないことが増え、実装が大変になる。
それを解決するために新しく追加されたのが Adaptive Dialog らしい。
いままでの Dialog の実装方法と異なり、「宣言的」に定義できるのが特徴で、ソースコードでも実装できるが json ファイルに定義することもできる。
また、Bot Framework Composer も、この Adaptive Dialog の考え方を元にしているようにみえる。</p><h2 id=前提条件>前提条件</h2><ul><li>現在.NET版のBot Framework SDKでのみ使用可能。</li><li>Bot Framework V4 SDK の Dialog の基礎知識</li><li>Bot Framework V4 SDK の Prompt の基礎知識</li></ul><h2 id=adaptive-dialog-の構造>Adaptive Dialog の構造</h2><h3 id=trigger>Trigger</h3><p>参考：</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-adaptive-dialog-triggers target=_blank rel=noopener>Events and triggers in adaptive dialogs</a><ul><li>Trigger についての説明が載っている</li></ul></li><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/adaptive-dialog/adaptive-dialog-prebuilt-triggers target=_blank rel=noopener>Events and triggers in adaptive dialogs - reference guide - Bot Service | Microsoft Docs</a><ul><li>あらかじめ定義されている Trigger の説明が載っている</li></ul></li></ul><p>Adaptive Dialog には、Trigger と言われるイベントハンドラのリストを定義する。
Trigger には Condition (条件) と Action (処理) を定義する。
Trigger のリストを上から順にたどっていって、Condition が合っていると Action が実行され、それ以降の Action は実行されない。
なので、リストの最後には、どの条件にも引っかからなかった場合の処理を用意しておくのが良いっぽい。
下記サンプルの <code>OnUnknownIntent</code> の部分がそれにあたる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>public</span> <span style=color:#111>RootDialog</span><span style=color:#111>()</span> <span style=color:#111>:</span> <span style=color:#00a8c8>base</span><span style=color:#111>(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>RootDialog</span><span style=color:#111>))</span>
<span style=color:#111>{</span>
    <span style=color:#111>Triggers</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>OnCondition</span><span style=color:#111>&gt;</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>new</span> <span style=color:#111>OnConversationUpdateActivity</span><span style=color:#111>()</span>
        <span style=color:#111>{</span>
            <span style=color:#111>Actions</span> <span style=color:#111>=</span> <span style=color:#111>WelcomeUserSteps</span><span style=color:#111>()</span>
        <span style=color:#111>},</span>
        <span style=color:#00a8c8>new</span> <span style=color:#111>OnUnknownIntent</span>
        <span style=color:#111>{</span>
            <span style=color:#111>Actions</span> <span style=color:#111>=</span>
            <span style=color:#111>{</span>
                <span style=color:#00a8c8>new</span> <span style=color:#111>SendActivity</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Hi, we are up and running!!&#34;</span><span style=color:#111>),</span>
            <span style=color:#111>}</span>
        <span style=color:#111>},</span>
    <span style=color:#111>};</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=action>Action</h3><p>Action は、Trigger の条件が合致したときに行う処理を定義する。
それぞれのステップをメソッドで定義する Waterfall Dialog とは違い、Adaptive dialog の Action は Dialog クラスを拡張したもののリストである。
これにより Adaptive Dialog をより強力で柔軟にしつつ、中断や分岐などの管理を容易にする。</p><p>Bot Framework SDKは、たくさんのビルトインActionを提供している。例えば、メモリの生成、ダイアログ管理、会話フローの制御などである。
Actionは拡張可能で、自分のカスタム Action を作成できる。</p><p>Actionの詳細は、<a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-adaptive-dialog-actions target=_blank rel=noopener>Actions in adaptive dialogs</a> を参照。</p><h3 id=input>Input</h3><p>Input は Adaptive Dialog 用の Prompt である。Input は、ユーザーへ情報をリクエスト＆検証するために、Adaptive Dialog で使える特別なActionである。
すべての Input クラスは、下記の機能がある。</p><ul><li>ユーザーへプロンプトする前に、その情報をボットがすでに持っているかどうかをチェックする。</li><li>入力が想定通りの形式である場合に、指定されたプロパティへ値を保存する。</li><li>制約を使える。最小、最大など。</li></ul><p>Inputの詳細は、<a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-adaptive-dialog-inputs target=_blank rel=noopener>Asking for user input using adaptive dialogs</a> を参照。</p><p><a href=https://docs.microsoft.com/en-us/azure/bot-service/adaptive-dialog/adaptive-dialog-prebuilt-inputs target=_blank rel=noopener>Inputs in adaptive dialogs - reference guide - Bot Service | Microsoft Docs</a></p><h3 id=generator>Generator</h3><p>Language Generator は、ボットからのメッセージをテンプレート化したものである。
いくつかの候補からランダムで発言したり、条件式などを指定できる。</p><h3 id=recognizer>Recognizer</h3><ul><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-adaptive-dialog-recognizers target=_blank rel=noopener>Recognizers in adaptive dialogs - Bot Service | Microsoft Docs</a><ul><li>Recognizer について</li></ul></li><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/adaptive-dialog/adaptive-dialog-prebuilt-recognizers target=_blank rel=noopener>Recognizers in adaptive dialogs - reference guide - Bot Service | Microsoft Docs</a><ul><li>下記 Recognizer の説明が載っている</li></ul></li></ul><p>Recognizerは、ユーザーの発話からインテント(意図)を取り出すのに使う。
例えば、LUIS を使ってインテントが見つかるかどうか検証したり、QnA Maker に答えられる質問かどうかを検証したりする。
Recognizer が発話から意図を見つけると、トリガーの <code>OnIntent</code> が発生する。</p><p>Recognizer には下記の種類がある：</p><ul><li><strong>RegexRecognizer</strong> - 正規表現を使い、ユーザーの入力からインテントを見つける。コード上で設定が済むので、LUISを使うほどでもない場合はこれを使うと良い。</li><li><strong>LUIS recognizer</strong> - LUIS を使い、ユーザーの入力からインテントを見つける。Azure の同サービスが必要。</li><li><strong>QnA Maker recognizer</strong> - QnA Maker を使い、ユーザーの入力が QnA Maker に答えられる質問かどうかを検証する。Azureの同サービスが必要。</li><li><strong>Multi-language recognizer</strong> - 言語ごとに Recognizer を指定できる。</li><li><strong>CrossTrained recognizer set</strong> - 複数の Recognizer の設定を学習し、会話の中断などを制御しやすくする。</li><li><strong>RecognizerSet</strong> - 複数の Recognizer を使うときに使う。</li></ul><h3 id=メモリのスコープと-state-の管理>メモリのスコープと State の管理</h3><p>参考：</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-adaptive-dialog-memory-states target=_blank rel=noopener>Managing state in Adaptive Dialogs - Bot Service | Microsoft Docs</a><ul><li>説明</li></ul></li><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/adaptive-dialog/adaptive-dialog-prebuilt-memory-states target=_blank rel=noopener>Managing state in adaptive dialogs - reference guide - Bot Service | Microsoft Docs</a><ul><li>スコープの一覧と使用例が載っている</li></ul></li></ul><p>Adaptive Dialog では、State への読み書きも簡易になっている。State にはいくつかのスコープがあり、User State であれば <code>user.xxxx</code> といった具合にアクセスできる。
以下にスコープの一覧を示す：</p><ul><li><strong>User scope</strong> (<code>user</code>) - 会話に参加したユーザーごと。</li><li><strong>Conversation scope</strong> (<code>conversation</code>) - 会話ごと。</li><li><strong>Dialog scope</strong> (<code>dialog</code>) - ダイアログごと。そのダイアログのが終わるとメモリが消えるかもしれない(未確認)。</li><li><strong>Turn scope</strong> (<code>turn</code>) - ターンごと。</li><li><strong>Settings scope</strong> (<code>settings</code>) - 設定値。appsettings.json とかの設定値を取得できる。コード上で書き込むことは少ないと思われる。</li><li><strong>This scope</strong> (<code>this</code>) - その Action クラスのプロパティを取得できる。Input アクションを使用するときによく使ったりするらしい。</li><li><strong>Class scope</strong> (<code>class</code>) - アクティブなダイアログのプロパティを取得できる。</li></ul><h3 id=declarative-assets>Declarative assets</h3><p>Adaptive Dialog を拡張して、自分でカスタマイズしたdialogクラスを作成できるが、それとは別に、JSONファイルを作って Adaptive dialogを拡張できる。
ソースコードは必要なく、両方のアプローチを一つのボットに入れられる。</p><p><a href="https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-adaptive-dialog-declarative?view=azure-bot-service-4.0" target=_blank rel=noopener>Using declarative assets</a></p></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>