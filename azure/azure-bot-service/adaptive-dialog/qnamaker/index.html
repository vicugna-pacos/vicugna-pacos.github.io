<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>QnA Maker - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li><li>Adaptive Dialog</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#サンプル>サンプル</a><ul><li><a href=#dialog-クラスのサンプル>Dialog クラスのサンプル</a></li><li><a href=#lg-ファイルのサンプル>lg ファイルのサンプル</a></li></ul></li><li><a href=#回答の参照>回答の参照</a></li><li><a href=#注意点>注意点</a></li></ul></nav></aside></div><div class=main><article><h1>QnA Maker</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2021-01-08 13:27:54 +0900 +0900" itemprop=datePublished>2021-01-08</time>
(最終更新：<time datetime="2021-03-17 20:48:03 +0900 +0900" itemprop=dateModified>2021-03-17</time>)</div><div></div></div><h2 id=はじめに>はじめに</h2><p>参考：</p><ul><li><a href=https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/adaptive-dialog/07.qnamaker target=_blank rel=noopener>BotBuilder-Samples/samples/csharp_dotnetcore/adaptive-dialog/07.qnamaker at main · microsoft/BotBuilder-Samples</a></li></ul><p>Adaptive Dialog で QnAMaker を使う方法を記載する。
MS のドキュメントに載っているのは、ボットのソースコードと一緒に <code>.qna</code> ファイルを作成し、Q&Aのリストを管理する方法だが、
ここに記載するのは、QnAMaker ポータルサイトに作成済みのナレッジベースを使う方法である。</p><h2 id=サンプル>サンプル</h2><h3 id=dialog-クラスのサンプル>Dialog クラスのサンプル</h3><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.AI.QnA</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.AI.QnA.Recognizers</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Dialogs</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Dialogs.Adaptive</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Dialogs.Adaptive.Actions</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Dialogs.Adaptive.Conditions</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Dialogs.Adaptive.Generators</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Dialogs.Adaptive.Input</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Dialogs.Adaptive.Templates</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.LanguageGeneration</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Extensions.Configuration</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Newtonsoft.Json</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Newtonsoft.Json.Linq</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Collections.Generic</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.IO</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Linq</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Threading</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Threading.Tasks</span><span style=color:#111>;</span>

<span style=color:#00a8c8>namespace</span> <span style=color:#111>FaqBotDemo.Dialogs</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>RootDialog</span> <span style=color:#111>:</span> <span style=color:#111>AdaptiveDialog</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>public</span> <span style=color:#111>RootDialog</span><span style=color:#111>(</span><span style=color:#111>IConfiguration</span> <span style=color:#111>configuration</span><span style=color:#111>)</span> <span style=color:#111>:</span> <span style=color:#00a8c8>base</span><span style=color:#111>(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>RootDialog</span><span style=color:#111>))</span>
        <span style=color:#111>{</span>
            <span style=color:#111>Recognizer</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>QnAMakerRecognizer</span><span style=color:#111>()</span>
            <span style=color:#111>{</span>
                <span style=color:#111>HostName</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;qna:hostname&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>EndpointKey</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;qna:endpointKey&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>KnowledgeBaseId</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;qna:knowledgeBaseId&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>QnAId</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaIdFromPrompt&#34;</span><span style=color:#111>,</span>
                <span style=color:#111>IncludeDialogNameInMetadata</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
            <span style=color:#111>};</span>

            <span style=color:#111>Triggers</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>OnCondition</span><span style=color:#111>&gt;</span>
            <span style=color:#111>{</span>
                <span style=color:#00a8c8>new</span> <span style=color:#111>OnQnAMatch</span><span style=color:#111>()</span>
                <span style=color:#111>{</span>
                    <span style=color:#111>Actions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Dialog</span><span style=color:#111>&gt;()</span>
                    <span style=color:#111>{</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>CodeAction</span><span style=color:#111>(</span><span style=color:#111>GetTopAnswer</span><span style=color:#111>),</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>SendActivity</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Activity</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ActivityTemplate</span><span style=color:#111>(</span><span style=color:#d88200>&#34;${SimpleAnswer()}&#34;</span><span style=color:#111>),</span>
                        <span style=color:#111>}</span>
                    <span style=color:#111>}</span>
                <span style=color:#111>},</span>
                <span style=color:#75715e>// 回答が複数あるものの、最大のスコアが0.8未満のとき
</span><span style=color:#75715e></span>                <span style=color:#00a8c8>new</span> <span style=color:#111>OnQnAMatch</span><span style=color:#111>()</span>
                <span style=color:#111>{</span>
                    <span style=color:#111>Condition</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;count(turn.recognized.answers) &gt; 1 &amp;&amp; count(where(turn.recognized.answers, answer, answer.score &gt;= 0.8)) == 0&#34;</span><span style=color:#111>,</span>
                    <span style=color:#111>Actions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Dialog</span><span style=color:#111>&gt;()</span>
                    <span style=color:#111>{</span>
                        <span style=color:#75715e>// 回答リストを保存しておく
</span><span style=color:#75715e></span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>SetProperty</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;dialog.qnaAnswers&#34;</span><span style=color:#111>,</span>
                            <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;=turn.recognized.answers&#34;</span>
                        <span style=color:#111>},</span>
                        <span style=color:#75715e>// どの回答が合っているかユーザーへ尋ねる
</span><span style=color:#75715e></span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>TextInput</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Prompt</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ActivityTemplate</span><span style=color:#111>(</span><span style=color:#d88200>&#34;${UnconfidentAnswer()}&#34;</span><span style=color:#111>),</span>
                            <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaUnconfidentResponse&#34;</span><span style=color:#111>,</span>
                            <span style=color:#111>AllowInterruptions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span>
                            <span style=color:#111>AlwaysPrompt</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
                        <span style=color:#111>},</span>
                        <span style=color:#75715e>// ユーザーが選んだ質問を使って回答を探す
</span><span style=color:#75715e></span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>SetProperty</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaMatchFromAnswers&#34;</span><span style=color:#111>,</span>
                            <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;=where(dialog.qnaAnswers, answer, answer.questions[0] == turn.qnaUnconfidentResponse)&#34;</span>
                        <span style=color:#111>},</span>
                        <span style=color:#75715e>// 保存しておいた回答リストを削除する
</span><span style=color:#75715e></span>                         <span style=color:#00a8c8>new</span> <span style=color:#111>DeleteProperty</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;dialog.qnaAnswers&#34;</span>
                        <span style=color:#111>},</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>IfCondition</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Condition</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaMatchFromAnswers &amp;&amp; count(turn.qnaMatchFromAnswers) &gt; 0&#34;</span><span style=color:#111>,</span>
                            <span style=color:#111>Actions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Dialog</span><span style=color:#111>&gt;()</span>
                            <span style=color:#111>{</span>
                                <span style=color:#00a8c8>new</span> <span style=color:#111>SetProperty</span><span style=color:#111>()</span>
                                <span style=color:#111>{</span>
                                    <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.topAnswer&#34;</span><span style=color:#111>,</span>
                                    <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;=turn.qnaMatchFromAnswers[0]&#34;</span>
                                <span style=color:#111>},</span>
                                <span style=color:#00a8c8>new</span> <span style=color:#111>SendActivity</span><span style=color:#111>(</span><span style=color:#d88200>&#34;${SimpleAnswer()}&#34;</span><span style=color:#111>)</span>
                            <span style=color:#111>},</span>
                            <span style=color:#75715e>// follow-up prompt で提示したもの以外が送られてきたとき
</span><span style=color:#75715e></span>                            <span style=color:#111>ElseActions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Dialog</span><span style=color:#111>&gt;()</span>
                            <span style=color:#111>{</span>
                                <span style=color:#00a8c8>new</span> <span style=color:#111>SendActivity</span><span style=color:#111>(</span><span style=color:#d88200>&#34;お答えできませんでした。改めてご質問ください。&#34;</span><span style=color:#111>)</span>
                            <span style=color:#111>}</span>
                        <span style=color:#111>}</span>
                    <span style=color:#111>}</span>
                <span style=color:#111>},</span>
                <span style=color:#75715e>// 回答に follow-up prompt が付いているとき
</span><span style=color:#75715e></span>                <span style=color:#00a8c8>new</span> <span style=color:#111>OnQnAMatch</span><span style=color:#111>()</span>
                <span style=color:#111>{</span>
                    <span style=color:#111>Condition</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;count(turn.recognized.answers[0].context.prompts) &gt; 0&#34;</span><span style=color:#111>,</span>
                    <span style=color:#111>Actions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Dialog</span><span style=color:#111>&gt;()</span>
                    <span style=color:#111>{</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>SetProperty</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;dialog.qnaContext&#34;</span><span style=color:#111>,</span>
                            <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;=turn.recognized.answers[0].context.prompts&#34;</span>
                        <span style=color:#111>},</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>TextInput</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Prompt</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ActivityTemplate</span><span style=color:#111>(</span><span style=color:#d88200>&#34;${PromptAnswer()}&#34;</span><span style=color:#111>),</span>
                            <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaMultiTurnResponse&#34;</span><span style=color:#111>,</span>
                            <span style=color:#111>AllowInterruptions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span>
                            <span style=color:#111>AlwaysPrompt</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
                        <span style=color:#111>},</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>SetProperty</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaMatchFromContext&#34;</span><span style=color:#111>,</span>
                            <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;=where(dialog.qnaContext, item, item.displayText == turn.qnaMultiTurnResponse)&#34;</span>
                        <span style=color:#111>},</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>DeleteProperty</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;dialog.qnaContext&#34;</span>
                        <span style=color:#111>},</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>IfCondition</span><span style=color:#111>()</span>
                        <span style=color:#111>{</span>
                            <span style=color:#111>Condition</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaMatchFromContext &amp;&amp; count(turn.qnaMatchFromContext) &gt; 0&#34;</span><span style=color:#111>,</span>
                            <span style=color:#111>Actions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Dialog</span><span style=color:#111>&gt;()</span>
                            <span style=color:#111>{</span>
                                <span style=color:#00a8c8>new</span> <span style=color:#111>SetProperty</span><span style=color:#111>()</span>
                                <span style=color:#111>{</span>
                                    <span style=color:#111>Property</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaIdFromPrompt&#34;</span><span style=color:#111>,</span>
                                    <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;=turn.qnaMatchFromContext[0].qnaId&#34;</span>
                                <span style=color:#111>},</span>
                                <span style=color:#00a8c8>new</span> <span style=color:#111>EmitEvent</span><span style=color:#111>()</span>
                                <span style=color:#111>{</span>
                                    <span style=color:#111>EventName</span> <span style=color:#111>=</span> <span style=color:#111>DialogEvents</span><span style=color:#111>.</span><span style=color:#111>ActivityReceived</span><span style=color:#111>,</span>
                                    <span style=color:#111>EventValue</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;=turn.activity&#34;</span>
                                <span style=color:#111>}</span>
                            <span style=color:#111>},</span>
                            <span style=color:#75715e>// follow-up prompt で提示したもの以外が送られてきたとき
</span><span style=color:#75715e></span>                            <span style=color:#111>ElseActions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Dialog</span><span style=color:#111>&gt;()</span>
                            <span style=color:#111>{</span>
                                <span style=color:#00a8c8>new</span> <span style=color:#111>SendActivity</span><span style=color:#111>(</span><span style=color:#d88200>&#34;お答えできませんでした。改めてご質問ください。&#34;</span><span style=color:#111>)</span>
                            <span style=color:#111>}</span>
                        <span style=color:#111>}</span>
                    <span style=color:#111>}</span>
                <span style=color:#111>},</span>
                <span style=color:#00a8c8>new</span> <span style=color:#111>OnConversationUpdateActivity</span><span style=color:#111>()</span>
                <span style=color:#111>{</span>
                    <span style=color:#111>Actions</span> <span style=color:#111>=</span>
                    <span style=color:#111>{</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>CodeAction</span><span style=color:#111>(</span><span style=color:#111>WelcomeUser</span><span style=color:#111>)</span>
                    <span style=color:#111>}</span>
                <span style=color:#111>},</span>
                <span style=color:#00a8c8>new</span> <span style=color:#111>OnUnknownIntent</span><span style=color:#111>()</span>
                <span style=color:#111>{</span>
                    <span style=color:#111>Actions</span> <span style=color:#111>=</span>
                    <span style=color:#111>{</span>
                        <span style=color:#00a8c8>new</span> <span style=color:#111>SendActivity</span><span style=color:#111>(</span><span style=color:#d88200>&#34;回答が見つかりませんでした。&#34;</span><span style=color:#111>)</span>
                    <span style=color:#111>}</span>
                <span style=color:#111>},</span>
            <span style=color:#111>};</span>

            <span style=color:#00a8c8>string</span><span style=color:#111>[]</span> <span style=color:#111>paths</span> <span style=color:#111>=</span> <span style=color:#111>{</span> <span style=color:#d88200>&#34;.&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Dialogs&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;RootDialog.lg&#34;</span> <span style=color:#111>};</span>
            <span style=color:#00a8c8>string</span> <span style=color:#111>fullPath</span> <span style=color:#111>=</span> <span style=color:#111>Path</span><span style=color:#111>.</span><span style=color:#111>Combine</span><span style=color:#111>(</span><span style=color:#111>paths</span><span style=color:#111>);</span>

            <span style=color:#111>Generator</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TemplateEngineLanguageGenerator</span><span style=color:#111>(</span><span style=color:#111>Templates</span><span style=color:#111>.</span><span style=color:#111>ParseFile</span><span style=color:#111>(</span><span style=color:#111>fullPath</span><span style=color:#111>));</span>

        <span style=color:#111>}</span>

        <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// QnAMaker から返ってきた回答のうち、一番スコアの高いものを「turn.topAnswer」に保存する
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;dc&#34;&gt;&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;options&#34;&gt;&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span><span style=color:#75715e></span>        <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>DialogTurnResult</span><span style=color:#111>&gt;</span> <span style=color:#111>GetTopAnswer</span><span style=color:#111>(</span><span style=color:#111>DialogContext</span> <span style=color:#111>dc</span><span style=color:#111>,</span> <span style=color:#00a8c8>object</span> <span style=color:#111>options</span><span style=color:#111>)</span>
        <span style=color:#111>{</span>
            <span style=color:#00a8c8>var</span> <span style=color:#111>answers</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#111>JArray</span><span style=color:#111>)</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>State</span><span style=color:#111>[</span><span style=color:#d88200>&#34;turn.recognized.answers&#34;</span><span style=color:#111>];</span>
            <span style=color:#111>JToken</span> <span style=color:#111>topAnswer</span> <span style=color:#111>=</span> <span style=color:#00a8c8>null</span><span style=color:#111>;</span>
            <span style=color:#00a8c8>float</span> <span style=color:#111>topScore</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>

            <span style=color:#00a8c8>foreach</span> <span style=color:#111>(</span><span style=color:#00a8c8>var</span> <span style=color:#111>answer</span> <span style=color:#00a8c8>in</span> <span style=color:#111>answers</span><span style=color:#111>)</span>
            <span style=color:#111>{</span>
                <span style=color:#00a8c8>var</span> <span style=color:#111>score</span> <span style=color:#111>=</span> <span style=color:#00a8c8>float</span><span style=color:#111>.</span><span style=color:#111>Parse</span><span style=color:#111>(</span><span style=color:#111>answer</span><span style=color:#111>[</span><span style=color:#d88200>&#34;score&#34;</span><span style=color:#111>].</span><span style=color:#111>ToString</span><span style=color:#111>());</span>

                <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>topAnswer</span> <span style=color:#111>==</span> <span style=color:#00a8c8>null</span> <span style=color:#111>||</span> <span style=color:#111>topScore</span> <span style=color:#111>&lt;</span> <span style=color:#111>score</span><span style=color:#111>)</span>
                <span style=color:#111>{</span>
                    <span style=color:#111>topScore</span> <span style=color:#111>=</span> <span style=color:#111>score</span><span style=color:#111>;</span>
                    <span style=color:#111>topAnswer</span> <span style=color:#111>=</span> <span style=color:#111>answer</span><span style=color:#111>;</span>
                <span style=color:#111>}</span>
            <span style=color:#111>}</span>

            <span style=color:#00a8c8>var</span> <span style=color:#111>turn</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#111>JObject</span><span style=color:#111>)</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>State</span><span style=color:#111>[</span><span style=color:#d88200>&#34;turn&#34;</span><span style=color:#111>];</span>
            <span style=color:#111>turn</span><span style=color:#111>[</span><span style=color:#d88200>&#34;topAnswer&#34;</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#111>topAnswer</span><span style=color:#111>;</span>

            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>EndDialogAsync</span><span style=color:#111>(</span><span style=color:#111>options</span><span style=color:#111>);</span>
        <span style=color:#111>}</span>

        <span style=color:#75715e>/// &lt;summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// 新しいユーザーが追加されたときの処理
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;/summary&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;dc&#34;&gt;&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;param name=&#34;options&#34;&gt;&lt;/param&gt;
</span><span style=color:#75715e></span>        <span style=color:#75715e>/// &lt;returns&gt;&lt;/returns&gt;
</span><span style=color:#75715e></span>        <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>DialogTurnResult</span><span style=color:#111>&gt;</span> <span style=color:#111>WelcomeUser</span><span style=color:#111>(</span><span style=color:#111>DialogContext</span> <span style=color:#111>dc</span><span style=color:#111>,</span> <span style=color:#00a8c8>object</span> <span style=color:#111>options</span><span style=color:#111>)</span>
        <span style=color:#111>{</span>
            <span style=color:#00a8c8>foreach</span> <span style=color:#111>(</span><span style=color:#00a8c8>var</span> <span style=color:#111>member</span> <span style=color:#00a8c8>in</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>.</span><span style=color:#111>Activity</span><span style=color:#111>.</span><span style=color:#111>MembersAdded</span><span style=color:#111>)</span>
            <span style=color:#111>{</span>
                <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>member</span><span style=color:#111>.</span><span style=color:#111>Name</span> <span style=color:#111>!=</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>.</span><span style=color:#111>Activity</span><span style=color:#111>.</span><span style=color:#111>Recipient</span><span style=color:#111>.</span><span style=color:#111>Name</span><span style=color:#111>)</span>
                <span style=color:#111>{</span>
                    <span style=color:#75715e>// はじめのメッセージを送信
</span><span style=color:#75715e></span>                    <span style=color:#00a8c8>var</span> <span style=color:#111>template</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ActivityTemplate</span><span style=color:#111>(</span><span style=color:#d88200>&#34;${WelcomeUser()}&#34;</span><span style=color:#111>);</span>
                    <span style=color:#00a8c8>var</span> <span style=color:#111>message</span> <span style=color:#111>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>template</span><span style=color:#111>.</span><span style=color:#111>BindAsync</span><span style=color:#111>(</span><span style=color:#111>dc</span><span style=color:#111>,</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>State</span><span style=color:#111>);</span>
                    <span style=color:#00a8c8>await</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#111>message</span><span style=color:#111>);</span>
                <span style=color:#111>}</span>
            <span style=color:#111>}</span>
            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>EndDialogAsync</span><span style=color:#111>(</span><span style=color:#111>options</span><span style=color:#111>);</span>
        <span style=color:#111>}</span>

        <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>override</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>DialogTurnResult</span><span style=color:#111>&gt;</span> <span style=color:#111>BeginDialogAsync</span><span style=color:#111>(</span><span style=color:#111>DialogContext</span> <span style=color:#111>dc</span><span style=color:#111>,</span> <span style=color:#00a8c8>object</span> <span style=color:#111>options</span> <span style=color:#111>=</span> <span style=color:#00a8c8>null</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span> <span style=color:#111>=</span> <span style=color:#00a8c8>default</span><span style=color:#111>)</span>
        <span style=color:#111>{</span>
            <span style=color:#75715e>// debug用
</span><span style=color:#75715e></span>            <span style=color:#00a8c8>var</span> <span style=color:#111>debug</span> <span style=color:#111>=</span> <span style=color:#111>dc</span><span style=color:#111>.</span><span style=color:#111>State</span><span style=color:#111>[</span><span style=color:#d88200>&#34;turn&#34;</span><span style=color:#111>];</span>
            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>base</span><span style=color:#111>.</span><span style=color:#111>BeginDialogAsync</span><span style=color:#111>(</span><span style=color:#111>dc</span><span style=color:#111>,</span> <span style=color:#111>options</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
        <span style=color:#111>}</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=lg-ファイルのサンプル>lg ファイルのサンプル</h3><p>GitHub のサンプルでは follow-up prompt に Suggested Action を使っているが、
Teams などでは対応していないため、Adaptive Card の Action を使っている。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-md data-lang=md># SimpleAnswer
[Activity
    Attachments = ${json(SimpleAnswerCard())}
]

# SimpleAnswerCard
<span style=color:#00a8c8>-</span> ```
{
    &#34;type&#34;: &#34;AdaptiveCard&#34;,
    &#34;$schema&#34;: &#34;http://adaptivecards.io/schemas/adaptive-card.json&#34;,
    &#34;version&#34;: &#34;1.2&#34;,
    &#34;body&#34;: [
        {
            &#34;type&#34;: &#34;FactSet&#34;,
            &#34;facts&#34;: [
                {
                    &#34;title&#34;: &#34;Q :&#34;,
                    &#34;value&#34;: &#34;${turn.topAnswer.questions[0]}&#34;
                },
                {
                    &#34;title&#34;: &#34;A :&#34;,
                    &#34;value&#34;: &#34;${turn.topAnswer.answer}&#34;
                }
            ]
        }
    ]
}
<span style=color:#d88200>```
</span><span style=color:#d88200></span>
# PromptAnswer
[Activity
    Attachments = ${json(PromptAnswerCard())}
]

# PromptAnswerCard
- ```
{
    &#34;type&#34;: &#34;AdaptiveCard&#34;,
    &#34;$schema&#34;: &#34;http://adaptivecards.io/schemas/adaptive-card.json&#34;,
    &#34;version&#34;: &#34;1.2&#34;,
    &#34;body&#34;: [
        {
            &#34;type&#34;: &#34;TextBlock&#34;,
            &#34;text&#34;: &#34;${@answer}&#34;,
            &#34;wrap&#34;: true
        },
        ${join(foreach(turn.recognized.answers[0].context.prompts, x, ActionButton(x.displayText)), &#39;,&#39;)}
    ]
}
<span style=color:#d88200>```</span>

# UnconfidentAnswer
[Activity
    Attachments = ${json(UnconfidentAnswerCard())}
]

# UnconfidentAnswerCard
<span style=color:#00a8c8>-</span> ```
{
    &#34;type&#34;: &#34;AdaptiveCard&#34;,
    &#34;$schema&#34;: &#34;http://adaptivecards.io/schemas/adaptive-card.json&#34;,
    &#34;version&#34;: &#34;1.2&#34;,
    &#34;body&#34;: [
        {
            &#34;type&#34;: &#34;TextBlock&#34;,
            &#34;text&#34;: &#34;以下の回答が見つかりました。&#34;,
            &#34;wrap&#34;: true
        },
        ${join(foreach(turn.recognized.answers, x, ActionButton(x.questions[0])), &#39;,&#39;)}
    ]
}
<span style=color:#d88200>```
</span><span style=color:#d88200></span>
# ActionButton (displayText)
- IF: ${turn.activity.channelId == &#39;msteams&#39;}
    - ```
    {
        &#34;type&#34;: &#34;ActionSet&#34;,
        &#34;actions&#34;: [
            {
                &#34;type&#34;: &#34;Action.Submit&#34;,
                &#34;title&#34;: &#34;${displayText}&#34;,
                &#34;data&#34;: {
                &#34;msteams&#34;: {
                    &#34;type&#34;: &#34;imBack&#34;,
                    &#34;value&#34;: &#34;${displayText}&#34;
                    }
                }
            }
        ]
    }
    ```
- ELSE:
    - ```
    {
        &#34;type&#34;: &#34;ActionSet&#34;,
        &#34;actions&#34;: [
            {
                &#34;type&#34;: &#34;Action.Submit&#34;,
                &#34;title&#34;: &#34;${displayText}&#34;,
                &#34;data&#34;: &#34;${displayText}&#34;
            }
        ]
    }
    ```
# WelcomeUser
- ```
こんにちは。FAQチャットボットです。
<span style=color:#d88200>```</span>
</code></pre></div><h2 id=回答の参照>回答の参照</h2><p><code>OnQnAMatch</code> トリガーが発生した後、QnAMaker から得た回答は以下で参照できる。</p><ul><li><p><code>{@answer}</code> - 一番スコアの高い回答。文字データ。</p></li><li><p><code>turn.recognized.answers</code> - Microsoft.Bot.Builder.AI.QnA.QueryResult[] - QnAMaker が返した回答すべてが入っている。</p></li><li><p>QueryResult</p><ul><li><code>questions</code> - string[]</li><li><code>answer</code> - string</li><li><code>score</code> - float</li><li><code>metadata</code> - Microsoft.Bot.Builder.AI.QnA.Metadata[]</li><li><code>source</code> - string</li><li><code>id</code> - int - QnAId</li><li><code>context</code> - Microsoft.Bot.Builder.AI.QnA.QnAResponseContext<ul><li><code>prompts</code> - Microsoft.Bot.Builder.AI.QnA.QnaMakerPrompt[]</li></ul></li></ul></li><li><p>QnaMakerPrompt</p><ul><li><code>displayOrder</code> - int</li><li><code>qnaId</code> - int</li><li><code>displayText</code> - string</li><li><code>qna</code> - object</li></ul></li></ul><p>型も一緒に記載したが、CodeAction などで直接 State を取り出す場合、JObject とか JArray とか、JSONの形式になっている。</p><h2 id=注意点>注意点</h2><p><code>QnAMakerRecognizer</code> の生成時に、<code>IncludeDialogNameInMetadata</code> プロパティを <code>false</code> にしている。
これを忘れると既定値の <code>true</code> が適用され、QnAMaker 検索時に常にダイアログ名がメタデータフィルターにセットされる。
QnAMaker 側にメタデータの設定がない場合、QnAMaker が必ず 400 (Bad Request) を返す。
ボット側でエラーの原因を見つけるのは難しく、QnAMaker 作成時に一緒に作成した AppInsights のログを見てやっと気づけた。</p><p>AppInsights に記録されていたエラーメッセージ：</p><pre><code>Exception : Microsoft.CognitiveServices.QnAMaker.Runtime.Exceptions.AzureSearchBadStateException
Message : Strict filter (dialogname) does not exist in the KB. Please retry with valid strict filters.
</code></pre></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>