<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-0L8LJXJEKX"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-0L8LJXJEKX');</script><meta property="og:title" content="LUIS を使う"><meta property="og:description" content="はじめに ボットに LUIS を追加する手順を記載する。 Bot Framework のドキュメントから Adaptive Dialog での実装方法が消えているため、Adaptive Dialog なしでの実装方法である。 botframework-cli のインストール LUIS アプリケーションのインテントなどを、ソー"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/azure/azure-bot-service/luis/"><meta property="article:published_time" content="2021-06-30T10:44:20+09:00"><meta property="article:modified_time" content="2021-06-30T10:44:20+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="LUIS を使う"><meta name=twitter:description content="はじめに ボットに LUIS を追加する手順を記載する。 Bot Framework のドキュメントから Adaptive Dialog での実装方法が消えているため、Adaptive Dialog なしでの実装方法である。 botframework-cli のインストール LUIS アプリケーションのインテントなどを、ソー"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>LUIS を使う - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#botframework-cli-のインストール>botframework-cli のインストール</a></li><li><a href=#luis-アプリケーションを作る>LUIS アプリケーションを作る</a></li><li><a href=#json-ファイルをエクスポートする>json ファイルをエクスポートする</a></li><li><a href=#コマンド実行>コマンド実行</a></li><li><a href=#nuget-パッケージの追加>nuget パッケージの追加</a></li><li><a href=#設定値の追加>設定値の追加</a></li><li><a href=#recognizer-の作成>Recognizer の作成</a></li><li><a href=#recognizer-を使う>Recognizer を使う</a></li></ul></nav></aside></div><div class=main><article><h1>LUIS を使う</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2021-06-30 10:44:20 +0900 +0900" itemprop=datePublished>2021-06-30</time></div><div></div></div><h2 id=はじめに>はじめに</h2><p>ボットに LUIS を追加する手順を記載する。
Bot Framework のドキュメントから Adaptive Dialog での実装方法が消えているため、Adaptive Dialog なしでの実装方法である。</p><h2 id=botframework-cli-のインストール>botframework-cli のインストール</h2><p>LUIS アプリケーションのインテントなどを、ソースコードで扱いやすくするためのクラスを自動生成するために使う。</p><p><a href=https://github.com/microsoft/botframework-cli target=_blank rel=noopener>公式サイト</a></p><p>当ツールを使うには、Node.js がインストールされている必要がある。
Node.js インストール後、コマンドプロンプトで下記コマンドを実行しcliツールをインストールする。</p><pre><code>npm i -g @microsoft/botframework-cli
</code></pre><p>インストールが終わった後、下記コマンドを実行するとヘルプが表示される。</p><pre><code>bf
</code></pre><h2 id=luis-アプリケーションを作る>LUIS アプリケーションを作る</h2><p>LUIS ポータルサイトで、LUIS アプリケーションを作る。詳細は割愛。</p><h2 id=json-ファイルをエクスポートする>json ファイルをエクスポートする</h2><p>LUIS ポータルサイトで作ったアプリケーションの設定内容をエクスポートする。
<img src=2021-06-30-11-11-32.png alt></p><h2 id=コマンド実行>コマンド実行</h2><p>下記コマンドを実行する。</p><pre><code>bf luis:generate:cs -i FaqBotDev.json -o C:\test --className=FaqBot.FaqBotModel
</code></pre><ul><li><code>-i</code> - LUIS ポータルサイトからエクスポートしたjsonファイルのパスを指定する。</li><li><code>-o</code> - 自動生成されるクラスの出力先。ファイル名またはフォルダ名を指定する。フォルダ名を指定した場合は、クラス名＋<code>.cs</code> でファイルが作成される。</li><li><code>--className</code> - 自動生成されるクラス名を指定する。名前空間も一緒に指定可能。これだけオプション名と値を <code>=</code> で繋げる。</li></ul><p>コマンドを実行すると下記のようなファイルが作成されるので、ボットのプロジェクトへ取り込む。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// &lt;auto-generated&gt;
</span><span style=color:#75715e>// Code generated by luis:generate:cs
</span><span style=color:#75715e>// Tool github: https://github.com/microsoft/botframework-cli
</span><span style=color:#75715e>// Changes may cause incorrect behavior and will be lost if the code is
</span><span style=color:#75715e>// regenerated.
</span><span style=color:#75715e>// &lt;/auto-generated&gt;
</span><span style=color:#75715e></span><span style=color:#00a8c8>using</span> <span style=color:#111>Newtonsoft.Json</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Newtonsoft.Json.Serialization</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Collections.Generic</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.AI.Luis</span><span style=color:#111>;</span>
<span style=color:#00a8c8>namespace</span> <span style=color:#111>FaqBot</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>partial</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>FaqBotModel</span><span style=color:#111>:</span> <span style=color:#111>IRecognizerConvert</span>
    <span style=color:#111>{</span>
<span style=color:#75af00>        [JsonProperty(&#34;text&#34;)]</span>
        <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>string</span> <span style=color:#111>Text</span><span style=color:#111>;</span>
<span style=color:#75af00>
</span><span style=color:#75af00>        [JsonProperty(&#34;alteredText&#34;)]</span>
        <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>string</span> <span style=color:#111>AlteredText</span><span style=color:#111>;</span>

        <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>enum</span> <span style=color:#111>Intent</span> <span style=color:#111>{</span>
            <span style=color:#111>None</span><span style=color:#111>,</span>
            <span style=color:#111>AAA</span><span style=color:#111>,</span>
            <span style=color:#111>BBB</span>
        <span style=color:#111>};</span>
<span style=color:#75715e>// 略
</span></code></pre></div><h2 id=nuget-パッケージの追加>nuget パッケージの追加</h2><p>Visual Studio などでボットのソースコードを開き、プロジェクトに
<code>Microsoft.Bot.Builder.AI.Luis</code> を追加する。</p><h2 id=設定値の追加>設定値の追加</h2><p>appsettings.json に LUISアプリケーションへの接続情報を追加する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#111>{</span>
  <span style=color:#f92672>&#34;LuisAppId&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;xxx&#34;</span><span style=color:#111>,</span>
  <span style=color:#f92672>&#34;LuisAPIKey&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;yyy&#34;</span><span style=color:#111>,</span>
  <span style=color:#f92672>&#34;LuisAPIHostName&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;https://&lt;region&gt;.api.cognitive.microsoft.com&#34;</span>
<span style=color:#111>}</span>
</code></pre></div><p>App ID は LUIS ポータルサイトの下記から取得する。</p><p><img src=2021-06-30-14-29-33.png alt></p><p>API key は下記から取得する。</p><p><img src=2021-06-30-14-31-32.png alt></p><p>APIHostName は上記URLの <code>region</code> の部分を Azure のリソースを作成したときのリージョンにする。
日本から使う場合、推奨は <code>westus</code> なのでそれを指定する。</p><h2 id=recognizer-の作成>Recognizer の作成</h2><p>ボットのプロジェクトに
<code>Microsoft.Bot.Builder.IRecognizer</code> インターフェイスを実装したクラスを作成する。
内部で <code>Microsoft.Bot.Builder.AI.Luis.LuisRecognizer</code> クラスを生成してラップしているだけ。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>using</span> <span style=color:#111>System</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Collections.Generic</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Linq</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Threading</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Threading.Tasks</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.AI.Luis</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Extensions.Configuration</span><span style=color:#111>;</span>

<span style=color:#00a8c8>namespace</span> <span style=color:#111>FaqBot.Recognizers</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>FaqBotLuisRecognizer</span> <span style=color:#111>:</span> <span style=color:#111>IRecognizer</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>readonly</span> <span style=color:#111>LuisRecognizer</span> <span style=color:#111>_recognizer</span><span style=color:#111>;</span>

        <span style=color:#00a8c8>public</span> <span style=color:#111>FaqBotLuisRecognizer</span><span style=color:#111>(</span><span style=color:#111>IConfiguration</span> <span style=color:#111>configuration</span><span style=color:#111>)</span>
        <span style=color:#111>{</span>
            <span style=color:#00a8c8>var</span> <span style=color:#111>luisApplication</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>LuisApplication</span><span style=color:#111>(</span>
                <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;LuisAppId&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;LuisAPIKey&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;LuisAPIHostName&#34;</span><span style=color:#111>]);</span>

            <span style=color:#00a8c8>var</span> <span style=color:#111>recognizerOptions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>LuisRecognizerOptionsV3</span><span style=color:#111>(</span><span style=color:#111>luisApplication</span><span style=color:#111>)</span>
            <span style=color:#111>{</span>
                <span style=color:#111>PredictionOptions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Microsoft</span><span style=color:#111>.</span><span style=color:#111>Bot</span><span style=color:#111>.</span><span style=color:#111>Builder</span><span style=color:#111>.</span><span style=color:#111>AI</span><span style=color:#111>.</span><span style=color:#111>LuisV3</span><span style=color:#111>.</span><span style=color:#111>LuisPredictionOptions</span>
                <span style=color:#111>{</span>
                    <span style=color:#111>IncludeInstanceData</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
                <span style=color:#111>}</span>
            <span style=color:#111>};</span>

            <span style=color:#111>_recognizer</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>LuisRecognizer</span><span style=color:#111>(</span><span style=color:#111>recognizerOptions</span><span style=color:#111>);</span>
        <span style=color:#111>}</span>

        <span style=color:#00a8c8>public</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>RecognizerResult</span><span style=color:#111>&gt;</span> <span style=color:#111>RecognizeAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
        <span style=color:#111>{</span>
            <span style=color:#00a8c8>return</span> <span style=color:#111>_recognizer</span><span style=color:#111>.</span><span style=color:#111>RecognizeAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
        <span style=color:#111>}</span>

        <span style=color:#00a8c8>public</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>T</span><span style=color:#111>&gt;</span> <span style=color:#111>RecognizeAsync</span><span style=color:#111>&lt;</span><span style=color:#111>T</span><span style=color:#111>&gt;(</span><span style=color:#111>ITurnContext</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span> <span style=color:#00a8c8>where</span> <span style=color:#111>T</span> <span style=color:#111>:</span> <span style=color:#111>IRecognizerConvert</span><span style=color:#111>,</span> <span style=color:#00a8c8>new</span><span style=color:#111>()</span>
        <span style=color:#111>{</span>
            <span style=color:#00a8c8>return</span> <span style=color:#111>_recognizer</span><span style=color:#111>.</span><span style=color:#111>RecognizeAsync</span><span style=color:#111>&lt;</span><span style=color:#111>T</span><span style=color:#111>&gt;(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
        <span style=color:#111>}</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p>作成したクラスは、Startup.cs で DI に登録しておく。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>FaqBotLuisRecognizer</span><span style=color:#111>&gt;();</span>
</code></pre></div><h2 id=recognizer-を使う>Recognizer を使う</h2><p>ボット、ダイアログなど、LUIS を使いたいところで Recognizer を使う。
<code>RecognizeAsync</code> メソッドの型引数には、コマンドで自動生成したクラスを指定する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>var</span> <span style=color:#111>luisResult</span> <span style=color:#111>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>_recognizer</span><span style=color:#111>.</span><span style=color:#111>RecognizeAsync</span><span style=color:#111>&lt;</span><span style=color:#111>FaqBotModel</span><span style=color:#111>&gt;(</span><span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

<span style=color:#00a8c8>switch</span> <span style=color:#111>(</span><span style=color:#111>luisResult</span><span style=color:#111>.</span><span style=color:#111>TopIntent</span><span style=color:#111>().</span><span style=color:#111>intent</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>case</span> <span style=color:#111>FaqBotModel</span><span style=color:#111>.</span><span style=color:#111>Intent</span><span style=color:#111>.</span><span style=color:#111>None</span><span style=color:#111>:</span>
        <span style=color:#75715e>// なにか処理する
</span><span style=color:#75715e></span>        <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
    <span style=color:#00a8c8>case</span> <span style=color:#111>FaqBotModel</span><span style=color:#111>.</span><span style=color:#111>Intent</span><span style=color:#111>.</span><span style=color:#111>AAA</span><span style=color:#111>:</span>
        <span style=color:#75715e>// なにか処理する
</span><span style=color:#75715e></span>        <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
    <span style=color:#00a8c8>case</span> <span style=color:#111>FaqBotModel</span><span style=color:#111>.</span><span style=color:#111>Intent</span><span style=color:#111>.</span><span style=color:#111>BBB</span><span style=color:#111>:</span>
        <span style=color:#75715e>// なにか処理する
</span><span style=color:#75715e></span>        <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
    <span style=color:#00a8c8>case</span> <span style=color:#111>FaqBotModel</span><span style=color:#111>.</span><span style=color:#111>Intent</span><span style=color:#111>.</span><span style=color:#111>CCC</span><span style=color:#111>:</span>
        <span style=color:#75715e>// なにか処理する
</span><span style=color:#75715e></span>        <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
    <span style=color:#00a8c8>default</span><span style=color:#111>:</span>
        <span style=color:#75715e>// なにか処理する
</span><span style=color:#75715e></span>        <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
<span style=color:#111>}</span>

</code></pre></div></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>