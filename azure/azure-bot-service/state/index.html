<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta property="og:title" content="記憶の管理 (State)"><meta property="og:description" content="Stateの保存場所 ボットは、Webアプリケーションと同じように基本的にはステートレスである。 1回目のターンでやりとりした内容は、基本的には2回目ではもう覚えていない。 しかし、より充実した機能を提供す"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/azure/azure-bot-service/state/"><meta property="article:published_time" content="2020-10-02T12:04:50+09:00"><meta property="article:modified_time" content="2021-02-09T15:32:26+09:00"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>記憶の管理 (State) - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#stateの保存場所>Stateの保存場所</a></li><li><a href=#stateのスコープ>Stateのスコープ</a></li><li><a href=#実装サンプル>実装サンプル</a><ul><li><a href=#データを格納するクラスの作成>データを格納するクラスの作成</a></li><li><a href=#storageクラスなどの準備>Storageクラスなどの準備</a></li><li><a href=#turncontext-に登録する>TurnContext に登録する</a><ul><li><a href=#turncontext-から取得する>TurnContext から取得する</a></li></ul></li><li><a href=#state-を読み書きする>State を読み書きする</a></li></ul></li><li><a href=#azure-blob-storage-を使う>Azure Blob Storage を使う</a><ul><li><a href=#ストレージアカウントの準備>ストレージアカウントの準備</a></li><li><a href=#startupcs-の編集>Startup.cs の編集</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>記憶の管理 (State)</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-10-02 12:04:50 +0900 +0900" itemprop=datePublished>2020-10-02</time>
(最終更新：<time datetime="2021-02-09 15:32:26 +0900 +0900" itemprop=dateModified>2021-02-09</time>)</div><div></div></div><h2 id=stateの保存場所>Stateの保存場所</h2><p>ボットは、Webアプリケーションと同じように基本的にはステートレスである。
1回目のターンでやりとりした内容は、基本的には2回目ではもう覚えていない。
しかし、より充実した機能を提供するには「今までどんな会話をしてきたか」を覚えなくてはいけない場合がある。</p><p>そういった情報を保存する場所として、Bot Framework SDKには以下の3つが用意されている：</p><ul><li>Memory Storage - テスト用のインメモリのストレージ。ローカルでボットのテストをしたいときに使う。ボットが再起動すると消える。</li><li>Azure Blob Storage</li><li>Azure Cosmos DB</li></ul><h2 id=stateのスコープ>Stateのスコープ</h2><p>Stateのスコープは3つ用意されている。</p><ul><li>User state - ユーザーとボットの間でずっと有効なスコープ。</li><li>Conversation state - 特定の会話で有効なスコープ。ユーザーは問わない(例えばグループ会話)</li><li>Private conversation state - 特定の会話とユーザーで有効なスコープ。</li></ul><p>ユーザーと会話は1つのチャネル内でのみ認識できる。同じユーザーが異なるチャネルからボットにアクセスした場合、異なるユーザーと判断する。</p><h2 id=実装サンプル>実装サンプル</h2><p>参考ドキュメント：<a href="https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-howto-v4-state?view=azure-bot-service-4.0&tabs=csharp" target=_blank rel=noopener>Save user and conversation data - Bot Service | Microsoft Docs</a><br>サンプルソース：<a href=https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/45.state-management target=_blank rel=noopener>BotBuilder-Samples/samples/csharp_dotnetcore/45.state-management at main · microsoft/BotBuilder-Samples</a></p><p>このサンプルでは、conversation state と user state の2種類のスコープを扱う。</p><h3 id=データを格納するクラスの作成>データを格納するクラスの作成</h3><p>まず最初に、保存したいデータを保持するためのクラスを作成する。この工程は必須ではないが、クラスを作成しておくと管理が楽になると思われる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>// user stateで保持するデータ。ユーザー名などが相当する。
</span><span style=color:#75715e></span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>UserProfile</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>string</span> <span style=color:#111>Name</span> <span style=color:#111>{</span> <span style=color:#00a8c8>get</span><span style=color:#111>;</span> <span style=color:#00a8c8>set</span><span style=color:#111>;</span> <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>// conversation state で保存するデータ。
</span><span style=color:#75715e></span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>ConversationData</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>string</span> <span style=color:#111>Timestamp</span> <span style=color:#111>{</span> <span style=color:#00a8c8>get</span><span style=color:#111>;</span> <span style=color:#00a8c8>set</span><span style=color:#111>;</span> <span style=color:#111>}</span>

    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>string</span> <span style=color:#111>ChannelId</span> <span style=color:#111>{</span> <span style=color:#00a8c8>get</span><span style=color:#111>;</span> <span style=color:#00a8c8>set</span><span style=color:#111>;</span> <span style=color:#111>}</span>

    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>PromptedUserForName</span> <span style=color:#111>{</span> <span style=color:#00a8c8>get</span><span style=color:#111>;</span> <span style=color:#00a8c8>set</span><span style=color:#111>;</span> <span style=color:#111>}</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=storageクラスなどの準備>Storageクラスなどの準備</h3><p>次に、<code>Startup.cs</code> の <code>ConfigureServices</code> メソッドに下記の処理を追加して、ストレージやStateをDIに登録する。今サンプルではテスト用の <code>MemoryStorage</code> を使用する。
MemoryStorage はデータをただのメモリに保持するだけなので、アプリが再起動すると消えてしまう。
本番環境では必ず Azure Blob Storage などを使うこと。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#111>ConfigureServices</span><span style=color:#111>(</span><span style=color:#111>IServiceCollection</span> <span style=color:#111>services</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>IStorage</span><span style=color:#111>,</span> <span style=color:#111>MemoryStorage</span><span style=color:#111>&gt;();</span>
    <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>UserState</span><span style=color:#111>&gt;();</span>
    <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>ConversationState</span><span style=color:#111>&gt;();</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=turncontext-に登録する>TurnContext に登録する</h3><p>BotAdapter クラス (AdapterWithErrorHandler.cs) のコンストラクタに下記を追加し、TurnContext に各StateクラスとStorageクラスを登録する。
こうすると、State を DI で注入してもらわなくても、TurnContext さえあれば State などを使用できるようになる。<br>※ この手順は Adaptive Dialog を使えるようにする手順と重複しているため、そちらが済んでいるのなら改めて実装する必要はない。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>AdapterWithErrorHandler</span> <span style=color:#111>:</span> <span style=color:#111>BotFrameworkHttpAdapter</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#111>AdapterWithErrorHandler</span><span style=color:#111>(</span><span style=color:#111>IConfiguration</span> <span style=color:#111>configuration</span><span style=color:#111>,</span> <span style=color:#111>ILogger</span><span style=color:#111>&lt;</span><span style=color:#111>BotFrameworkHttpAdapter</span><span style=color:#111>&gt;</span> <span style=color:#111>logger</span>
<span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#111>,</span> <span style=color:#111>IStorage</span> <span style=color:#111>storage</span><span style=color:#111>,</span> <span style=color:#111>UserState</span> <span style=color:#111>userState</span><span style=color:#111>,</span> <span style=color:#111>ConversationState</span> <span style=color:#111>conversationState</span><span style=color:#111>)</span>
</span>        <span style=color:#111>:</span> <span style=color:#00a8c8>base</span><span style=color:#111>(</span><span style=color:#111>configuration</span><span style=color:#111>,</span> <span style=color:#111>logger</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
<span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>UseStorage</span><span style=color:#111>(</span><span style=color:#111>storage</span><span style=color:#111>);</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>UseBotState</span><span style=color:#111>(</span><span style=color:#111>userState</span><span style=color:#111>);</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>UseBotState</span><span style=color:#111>(</span><span style=color:#111>conversationState</span><span style=color:#111>);</span>
</span>
        <span style=color:#111>OnTurnError</span> <span style=color:#111>=</span> <span style=color:#00a8c8>async</span> <span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>exception</span><span style=color:#111>)</span> <span style=color:#111>=&gt;</span>
        <span style=color:#111>{</span>
            <span style=color:#75715e>// 略
</span><span style=color:#75715e></span>        <span style=color:#111>};</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h4 id=turncontext-から取得する>TurnContext から取得する</h4><p>Bot クラス等からStateを使いたい場合は、下記のように記述する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Threading</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>System.Threading.Tasks</span><span style=color:#111>;</span>

<span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>EmptyBot</span> <span style=color:#111>:</span> <span style=color:#111>ActivityHandler</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnTurnAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span> <span style=color:#111>=</span> <span style=color:#00a8c8>default</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
<span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>var</span> <span style=color:#111>storage</span> <span style=color:#111>=</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>TurnState</span><span style=color:#111>.</span><span style=color:#111>Get</span><span style=color:#111>&lt;</span><span style=color:#111>IStorage</span><span style=color:#111>&gt;(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>IStorage</span><span style=color:#111>));</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>var</span> <span style=color:#111>userState</span> <span style=color:#111>=</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>TurnState</span><span style=color:#111>.</span><span style=color:#111>Get</span><span style=color:#111>&lt;</span><span style=color:#111>UserState</span><span style=color:#111>&gt;(</span><span style=color:#00a8c8>typeof</span><span style=color:#111>(</span><span style=color:#111>UserState</span><span style=color:#111>).</span><span style=color:#111>FullName</span><span style=color:#111>);</span>
</span>    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p>Storage クラスは <code>nameof(IStorage)</code> がキーになっているが、各 State クラスは <code>typeof(UserState).FullName</code> と、名前空間も含めたクラス名がキーになっている点に注意。</p><h3 id=state-を読み書きする>State を読み書きする</h3><p>State クラスへデータを読み書きするには、<code>IStatePropertyAccessor</code> インターフェイスを経由して行う。
ボットクラスのサンプルは以下の通り。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>private</span> <span style=color:#111>BotState</span> <span style=color:#111>_conversationState</span><span style=color:#111>;</span>
<span style=color:#00a8c8>private</span> <span style=color:#111>BotState</span> <span style=color:#111>_userState</span><span style=color:#111>;</span>

<span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnMessageActivityAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span><span style=color:#111>&lt;</span><span style=color:#111>IMessageActivity</span><span style=color:#111>&gt;</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
<span style=color:#111>{</span>

    <span style=color:#75715e>// accessorを取得→accessor.GetAsyncを呼び出し で保存データを取得できる
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#111>conversationStateAccessors</span> <span style=color:#111>=</span>  <span style=color:#111>_conversationState</span><span style=color:#111>.</span><span style=color:#111>CreateProperty</span><span style=color:#111>&lt;</span><span style=color:#111>ConversationData</span><span style=color:#111>&gt;(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>ConversationData</span><span style=color:#111>));</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>conversationData</span> <span style=color:#111>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>conversationStateAccessors</span><span style=color:#111>.</span><span style=color:#111>GetAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>()</span> <span style=color:#111>=&gt;</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ConversationData</span><span style=color:#111>());</span>

    <span style=color:#00a8c8>var</span> <span style=color:#111>userStateAccessors</span> <span style=color:#111>=</span> <span style=color:#111>_userState</span><span style=color:#111>.</span><span style=color:#111>CreateProperty</span><span style=color:#111>&lt;</span><span style=color:#111>UserProfile</span><span style=color:#111>&gt;(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>UserProfile</span><span style=color:#111>));</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>userProfile</span> <span style=color:#111>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>userStateAccessors</span><span style=color:#111>.</span><span style=color:#111>GetAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>()</span> <span style=color:#111>=&gt;</span> <span style=color:#00a8c8>new</span> <span style=color:#111>UserProfile</span><span style=color:#111>());</span>

    <span style=color:#75715e>// (略)
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// 保存する値を変えるときは、オブジェクトに値をセットすればよい
</span><span style=color:#75715e></span>    <span style=color:#111>conversationData</span><span style=color:#111>.</span><span style=color:#111>Timestamp</span> <span style=color:#111>=</span> <span style=color:#111>localMessageTime</span><span style=color:#111>.</span><span style=color:#111>ToString</span><span style=color:#111>();</span>
    <span style=color:#111>conversationData</span><span style=color:#111>.</span><span style=color:#111>ChannelId</span> <span style=color:#111>=</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>Activity</span><span style=color:#111>.</span><span style=color:#111>ChannelId</span><span style=color:#111>.</span><span style=color:#111>ToString</span><span style=color:#111>();</span>
<span style=color:#111>}</span>

<span style=color:#00a8c8>public</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnTurnAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span> <span style=color:#111>=</span> <span style=color:#00a8c8>default</span><span style=color:#111>(</span><span style=color:#111>CancellationToken</span><span style=color:#111>))</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>await</span> <span style=color:#00a8c8>base</span><span style=color:#111>.</span><span style=color:#111>OnTurnAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

    <span style=color:#75715e>// ターンが終わる直前に、データを保存する
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>await</span> <span style=color:#111>_conversationState</span><span style=color:#111>.</span><span style=color:#111>SaveChangesAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
    <span style=color:#00a8c8>await</span> <span style=color:#111>_userState</span><span style=color:#111>.</span><span style=color:#111>SaveChangesAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
<span style=color:#111>}</span>
</code></pre></div><p>State はターンが終わるまでにデータを保存しないといけない。
DialogManager クラスを使用している場合は、ConversationState と UserState に限り自動的に保存される。
それ以外の場合は、<code>AutoSaveStateMiddleware</code> というミドルウェアの使用を検討すると良い。
このミドルウェアはコンストラクタに指定した BotState をターンの最後に自動で保存してくれる。
ミドルウェアの使い方については、<a href=https://vicugna-pacos.github.io/azure/azure-bot-service/middleware/>こちらの記事</a> を参照。</p><h2 id=azure-blob-storage-を使う>Azure Blob Storage を使う</h2><h3 id=ストレージアカウントの準備>ストレージアカウントの準備</h3><p>State の保存場所に Azure Blob Storage を使う場合、まずストレージアカウントをAzureに作成する。
作成後、ストレージアカウントのリソースを表示し、左側メニューの「設定」→「アクセスキー」をクリック。</p><p>key1 または key2 の接続文字列をコピーする。コピーした接続文字列は secrets.json へ貼り付ける。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#111>{</span>
  <span style=color:#f92672>&#34;storage&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
    <span style=color:#f92672>&#34;connectionString&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;接続文字列を貼り付ける&#34;</span><span style=color:#111>,</span>
    <span style=color:#f92672>&#34;containerName&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;bot-state&#34;</span>
  <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p><code>containerName</code> は好きな名前を付ける。ボット動作時に自動的に作成されるため、コンテナをあらかじめ作成しておく必要はない。</p><h3 id=startupcs-の編集>Startup.cs の編集</h3><p>NuGet パッケージ <code>Microsoft.Bot.Builder.Azure.Blobs</code> を追加する。<br>※ <code>Microsoft.Bot.Builder.Azure</code> を追加して <code>AzureBlobStorage</code> クラスを使おうとしたら非推奨といわれた。</p><p>ConfigureService メソッドに下記を追加する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Azure.Blobs</span><span style=color:#111>;</span>

<span style=color:#75715e>// 略
</span><span style=color:#75715e></span>
<span style=color:#00a8c8>var</span> <span style=color:#111>storage</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>BlobsStorage</span><span style=color:#111>(</span><span style=color:#111>Configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;storage:connectionString&#34;</span><span style=color:#111>],</span> <span style=color:#111>Configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;storage:containerName&#34;</span><span style=color:#111>]);</span>
<span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>IStorage</span><span style=color:#111>&gt;(</span><span style=color:#111>storage</span><span style=color:#111>);</span>
<span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>UserState</span><span style=color:#111>&gt;();</span>
<span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>ConversationState</span><span style=color:#111>&gt;();</span>
</code></pre></div></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>