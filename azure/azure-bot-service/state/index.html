<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta name=generator content="Hugo 0.74.1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>State (記憶) の管理 - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#stateの保存場所>Stateの保存場所</a></li><li><a href=#stateのスコープ>Stateのスコープ</a></li><li><a href=#実装サンプル>実装サンプル</a><ul><li><a href=#データを格納するクラスの作成>データを格納するクラスの作成</a></li><li><a href=#storageクラスなどの準備>storageクラスなどの準備</a></li><li><a href=#ボットクラスでデータを扱う>ボットクラスでデータを扱う</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>State (記憶) の管理</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-10-02 12:04:50 +0900 +0900" itemprop=datePublished>2020-10-02</time>
(最終更新：<time datetime="2020-10-15 14:49:00 +0900 +0900" itemprop=dateModified>2020-10-15</time>)</div><div></div></div><h2 id=stateの保存場所>Stateの保存場所</h2><p>ボットは、Webアプリケーションと同じように基本的にはステートレスである。
1回目のターンでやりとりした内容は、基本的には2回目ではもう覚えていない。
しかし、より充実した機能を提供するには「今までどんな会話をしてきたか」を覚えなくてはいけない場合がある。</p><p>そういった情報を保存する場所は、インメモリとかDBとかどこでも良いが、
Bot Framework SDKには以下のストレージに対する実装がある:</p><ul><li>Memory storage - テスト用のインメモリのストレージ。ローカルでボットのテストをしたいときに使う。ボットが再起動すると消える。</li><li>Azure Blob Storage</li><li>Azure Cosmos DB</li></ul><h2 id=stateのスコープ>Stateのスコープ</h2><p>Stateのスコープは3つある。</p><ul><li>User state - ユーザーとボットの間でずっと有効なスコープ。</li><li>Conversation state - 特定の会話で有効なスコープ。ユーザーは問わない(例えばグループ会話)</li><li>Private conversation state - 特定の会話とユーザーで有効なスコープ。</li></ul><p>ユーザーと会話は1つのチャネル内でのみ認識できる。同じユーザーが異なるチャネルからボットにアクセスした場合、異なるユーザーと判断する。</p><h2 id=実装サンプル>実装サンプル</h2><p>参考ドキュメント：<a href="https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-howto-v4-state?view=azure-bot-service-4.0&tabs=csharp" target=_blank rel=noopener>Save user and conversation data - Bot Service | Microsoft Docs</a><br>サンプルソース：<a href=https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/45.state-management target=_blank rel=noopener>BotBuilder-Samples/samples/csharp_dotnetcore/45.state-management at main · microsoft/BotBuilder-Samples</a></p><p>このサンプルでは、conversation state と user state の2種類のスコープを扱う。</p><h3 id=データを格納するクラスの作成>データを格納するクラスの作成</h3><p>まず最初に、保存したいデータを保持するためのクラスを作成する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>// user stateで保持するデータ。ユーザー名などが相当する。
</span><span style=color:#75715e></span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>UserProfile</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>string</span> <span style=color:#111>Name</span> <span style=color:#111>{</span> <span style=color:#00a8c8>get</span><span style=color:#111>;</span> <span style=color:#00a8c8>set</span><span style=color:#111>;</span> <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>// conversation state で保存するデータ。
</span><span style=color:#75715e></span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>ConversationData</span>
<span style=color:#111>{</span>
    <span style=color:#75715e>// The time-stamp of the most recent incoming message.
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>string</span> <span style=color:#111>Timestamp</span> <span style=color:#111>{</span> <span style=color:#00a8c8>get</span><span style=color:#111>;</span> <span style=color:#00a8c8>set</span><span style=color:#111>;</span> <span style=color:#111>}</span>

    <span style=color:#75715e>// The ID of the user&#39;s channel.
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>string</span> <span style=color:#111>ChannelId</span> <span style=color:#111>{</span> <span style=color:#00a8c8>get</span><span style=color:#111>;</span> <span style=color:#00a8c8>set</span><span style=color:#111>;</span> <span style=color:#111>}</span>

    <span style=color:#75715e>// Track whether we have already asked the user&#39;s name
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>PromptedUserForName</span> <span style=color:#111>{</span> <span style=color:#00a8c8>get</span><span style=color:#111>;</span> <span style=color:#00a8c8>set</span><span style=color:#111>;</span> <span style=color:#111>}</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=storageクラスなどの準備>storageクラスなどの準備</h3><p>次に、<code>Startup.cs</code> の <code>ConfigureServices</code> メソッドに、下記の処理を追加する。今回はローカルでのテスト用の <code>MemoryStorage</code> を使用する。
Azure Blob Storage などは別のクラスを使う。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#111>ConfigureServices</span><span style=color:#111>(</span><span style=color:#111>IServiceCollection</span> <span style=color:#111>services</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#75715e>// Bot States
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#111>storage</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>MemoryStorage</span><span style=color:#111>();</span>

    <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>UserState</span><span style=color:#111>(</span><span style=color:#111>storage</span><span style=color:#111>));</span>
    <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ConversationState</span><span style=color:#111>(</span><span style=color:#111>storage</span><span style=color:#111>));</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=ボットクラスでデータを扱う>ボットクラスでデータを扱う</h3><p>ボットクラスのサンプルは以下の通り。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>private</span> <span style=color:#111>BotState</span> <span style=color:#111>_conversationState</span><span style=color:#111>;</span>
<span style=color:#00a8c8>private</span> <span style=color:#111>BotState</span> <span style=color:#111>_userState</span><span style=color:#111>;</span>

<span style=color:#00a8c8>public</span> <span style=color:#111>StateManagementBot</span><span style=color:#111>(</span><span style=color:#111>ConversationState</span> <span style=color:#111>conversationState</span><span style=color:#111>,</span> <span style=color:#111>UserState</span> <span style=color:#111>userState</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#75715e>// コンストラクタで、各stateごとのオブジェクトを引数で受け取る。
</span><span style=color:#75715e></span>    <span style=color:#111>_conversationState</span> <span style=color:#111>=</span> <span style=color:#111>conversationState</span><span style=color:#111>;</span>
    <span style=color:#111>_userState</span> <span style=color:#111>=</span> <span style=color:#111>userState</span><span style=color:#111>;</span>
<span style=color:#111>}</span>

<span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnMessageActivityAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span><span style=color:#111>&lt;</span><span style=color:#111>IMessageActivity</span><span style=color:#111>&gt;</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
<span style=color:#111>{</span>

    <span style=color:#75715e>// accessorを取得→accessor.GetAsyncを呼び出し で保存データを取得できる
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#111>conversationStateAccessors</span> <span style=color:#111>=</span>  <span style=color:#111>_conversationState</span><span style=color:#111>.</span><span style=color:#111>CreateProperty</span><span style=color:#111>&lt;</span><span style=color:#111>ConversationData</span><span style=color:#111>&gt;(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>ConversationData</span><span style=color:#111>));</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>conversationData</span> <span style=color:#111>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>conversationStateAccessors</span><span style=color:#111>.</span><span style=color:#111>GetAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>()</span> <span style=color:#111>=&gt;</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ConversationData</span><span style=color:#111>());</span>

    <span style=color:#00a8c8>var</span> <span style=color:#111>userStateAccessors</span> <span style=color:#111>=</span> <span style=color:#111>_userState</span><span style=color:#111>.</span><span style=color:#111>CreateProperty</span><span style=color:#111>&lt;</span><span style=color:#111>UserProfile</span><span style=color:#111>&gt;(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>UserProfile</span><span style=color:#111>));</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>userProfile</span> <span style=color:#111>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>userStateAccessors</span><span style=color:#111>.</span><span style=color:#111>GetAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>()</span> <span style=color:#111>=&gt;</span> <span style=color:#00a8c8>new</span> <span style=color:#111>UserProfile</span><span style=color:#111>());</span>

    <span style=color:#75715e>// (略)
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// 保存する値を変えるときは、オブジェクトに値をセットすればよい
</span><span style=color:#75715e></span>    <span style=color:#111>conversationData</span><span style=color:#111>.</span><span style=color:#111>Timestamp</span> <span style=color:#111>=</span> <span style=color:#111>localMessageTime</span><span style=color:#111>.</span><span style=color:#111>ToString</span><span style=color:#111>();</span>
    <span style=color:#111>conversationData</span><span style=color:#111>.</span><span style=color:#111>ChannelId</span> <span style=color:#111>=</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>Activity</span><span style=color:#111>.</span><span style=color:#111>ChannelId</span><span style=color:#111>.</span><span style=color:#111>ToString</span><span style=color:#111>();</span>
<span style=color:#111>}</span>

<span style=color:#00a8c8>public</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnTurnAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span> <span style=color:#111>=</span> <span style=color:#00a8c8>default</span><span style=color:#111>(</span><span style=color:#111>CancellationToken</span><span style=color:#111>))</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>await</span> <span style=color:#00a8c8>base</span><span style=color:#111>.</span><span style=color:#111>OnTurnAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

    <span style=color:#75715e>// ターンが終わる直前に、データを保存する
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>await</span> <span style=color:#111>_conversationState</span><span style=color:#111>.</span><span style=color:#111>SaveChangesAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
    <span style=color:#00a8c8>await</span> <span style=color:#111>_userState</span><span style=color:#111>.</span><span style=color:#111>SaveChangesAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
<span style=color:#111>}</span>
</code></pre></div></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>