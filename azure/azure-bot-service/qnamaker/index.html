<!doctype html><html><head><meta name=generator content="Hugo 0.74.1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>QnA Maker を使用する - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a><ul><li><a href=#前提条件>前提条件</a></li></ul></li><li><a href=#ボットに-qna-maker-を追加する>ボットに QnA Maker を追加する</a><ul><li><a href=#ナレッジベースへの接続情報を取得>ナレッジベースへの接続情報を取得</a></li><li><a href=#ナレッジベースの情報をボットに追加>ナレッジベースの情報をボットに追加</a></li><li><a href=#conversation-state-を追加>Conversation State を追加</a></li><li><a href=#qnamakerdialog-を追加>QnAMakerDialog を追加</a></li></ul></li><li><a href=#ボットをカスタマイズする>ボットをカスタマイズする</a></li></ul></nav></aside></div><div class=main><article><h1>QnA Maker を使用する</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-10-22 17:10:47 +0900 +0900" itemprop=datePublished>2020-10-22</time></div><div></div></div><h2 id=はじめに>はじめに</h2><p>テンプレートから作成した Empty Bot に QnA Maker を追加する。</p><p>QnA Maker ポータルサイトから「Create Bot」のボタンを使ってボットを作成できるが、
ボットの挙動をカスタマイズしたい場合、空のボットから QnA Maker へ接続する手順を踏んで実装したほうが分かりやすいかもしれない。
(QnA Maker から作ったボットは、場合によっては必要なさそうなファイルが入っていたりして分かりづらい)</p><p>シンプルなボットに QnA Maker を追加するサンプルはMSのドキュメントにもあるが、このサンプルだと follow-up prompt に対応していない。</p><p>参考：<a href="https://docs.microsoft.com/ja-jp/azure/bot-service/bot-builder-tutorial-add-qna?view=azure-bot-service-4.0&tabs=csharp" target=_blank rel=noopener>質問に回答するボットの Azure Bot Service チュートリアル - Bot Service | Microsoft Docs</a></p><p>そのため、自分でググりつつ試しつつでたどり着いた実装手順を記載する。</p><h3 id=前提条件>前提条件</h3><ul><li>SDK v4 (C#)</li><li>Windows 10 + VS Code で開発</li><li>QnA Maker のナレッジベース作成済み</li><li>Empty Bot のテンプレートからプロジェクトを作成済み</li></ul><h2 id=ボットに-qna-maker-を追加する>ボットに QnA Maker を追加する</h2><p>EmptyBot に QnA Maker を追加する手順。
全体のサンプルは <a href=https://github.com/vicugna-pacos/azure-bot-samples/tree/main/qnamaker-bot target=_blank rel=noopener>GitHub</a> 参照。</p><h3 id=ナレッジベースへの接続情報を取得>ナレッジベースへの接続情報を取得</h3><p>QnA Maker ポータルへログインし、使用したい QnA Maker の「SETTINGS」のページを開く。
ページ下部の「Deployment Detail」にある <code>knowledge-base-id</code>、<code>endpoint-key</code>、<code>host-name</code> の3つを控えておく。</p><p><img src=2020-10-15-16-35-49.png alt></p><h3 id=ナレッジベースの情報をボットに追加>ナレッジベースの情報をボットに追加</h3><p>ボットの <code>appsettings.json</code> に、前の手順で取得した情報を追加する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#111>{</span>
  <span style=color:#f92672>&#34;MicrosoftAppId&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span>
  <span style=color:#f92672>&#34;MicrosoftAppPassword&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span>
<span style=display:block;width:100%;background-color:#e1e1e1>  <span style=color:#f92672>&#34;QnAKnowledgebaseId&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;kowledge-base-id&#34;</span><span style=color:#111>,</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>  <span style=color:#f92672>&#34;QnAEndpointKey&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;endpoint-key&#34;</span><span style=color:#111>,</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>  <span style=color:#f92672>&#34;QnAEndpointHostName&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;https://xxxx.azurewebsites.net/qnamaker&#34;</span>
</span><span style=color:#111>}</span>
</code></pre></div><h3 id=conversation-state-を追加>Conversation State を追加</h3><p>ダイアログが自身の状態管理ができるように、Conversation State を Startup.cs とボットに追加する。</p><p>Startup.cs のサンプルは下記の通り。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>Startup</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#111>ConfigureServices</span><span style=color:#111>(</span><span style=color:#111>IServiceCollection</span> <span style=color:#111>services</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
<span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>var</span> <span style=color:#111>storage</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>MemoryStorage</span><span style=color:#111>();</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>var</span> <span style=color:#111>conversationState</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ConversationState</span><span style=color:#111>(</span><span style=color:#111>storage</span><span style=color:#111>);</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>
</span><span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>(</span><span style=color:#111>conversationState</span><span style=color:#111>);</span>
</span>    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p>ボットはコンストラクタで Conversation State を受け取る。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>QnABot</span> <span style=color:#111>:</span> <span style=color:#111>ActivityHandler</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>private</span> <span style=color:#111>ConversationState</span> <span style=color:#111>_conversationState</span><span style=color:#111>;</span>

    <span style=color:#00a8c8>public</span> <span style=color:#111>QnABot</span><span style=color:#111>(</span><span style=color:#111>ConversationState</span> <span style=color:#111>conversationState</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
        <span style=color:#111>_conversationState</span> <span style=color:#111>=</span> <span style=color:#111>conversationState</span><span style=color:#111>;</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=qnamakerdialog-を追加>QnAMakerDialog を追加</h3><p>まず、<code>Microsoft.Bot.Builder.AI.QnA</code> をパッケージに追加する。
コマンドラインで下記コマンドを実行する。</p><pre><code>dotnet add package Microsoft.Bot.Builder.AI.QnA
</code></pre><p>つぎに、Startup.cs とボットにダイアログを追加する。</p><p>Startup.cs では、<code>QnAMakerDialog</code> クラスの生成をDIに登録する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>Startup</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#111>ConfigureServices</span><span style=color:#111>(</span><span style=color:#111>IServiceCollection</span> <span style=color:#111>services</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
<span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#75715e>// QnA Maker Dialog
</span></span><span style=display:block;width:100%;background-color:#e1e1e1><span style=color:#75715e></span>        <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddTransient</span><span style=color:#111>&lt;</span><span style=color:#111>QnAMakerDialog</span><span style=color:#111>&gt;(</span><span style=color:#111>dialog</span> <span style=color:#111>=&gt;</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#111>{</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>new</span> <span style=color:#111>QnAMakerDialog</span><span style=color:#111>(</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>                <span style=color:#111>knowledgeBaseId</span><span style=color:#111>:</span> <span style=color:#111>Configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;QnAKnowledgebaseId&#34;</span><span style=color:#111>],</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>                <span style=color:#111>endpointKey</span><span style=color:#111>:</span> <span style=color:#111>Configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;QnAEndpointKey&#34;</span><span style=color:#111>],</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>                <span style=color:#111>hostName</span><span style=color:#111>:</span> <span style=color:#111>Configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;QnAEndpointHostName&#34;</span><span style=color:#111>]);</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#111>});</span>
</span>    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p>ボットでは、コンストラクタでダイアログのインスタンスを受け取り、<code>OnMessageActivityAsync</code> メソッドでダイアログを使う。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>QnABot</span> <span style=color:#111>:</span> <span style=color:#111>ActivityHandler</span>
<span style=color:#111>{</span>

<span style=display:block;width:100%;background-color:#e1e1e1>    <span style=color:#00a8c8>private</span> <span style=color:#111>QnAMakerDialog</span> <span style=color:#111>_dialog</span><span style=color:#111>;</span>
</span>    <span style=color:#00a8c8>private</span> <span style=color:#111>ConversationState</span> <span style=color:#111>_conversationState</span><span style=color:#111>;</span>

<span style=display:block;width:100%;background-color:#e1e1e1>    <span style=color:#00a8c8>public</span> <span style=color:#111>QnABot</span><span style=color:#111>(</span><span style=color:#111>ConversationState</span> <span style=color:#111>conversationState</span><span style=color:#111>,</span> <span style=color:#111>QnAMakerDialog</span> <span style=color:#111>dialog</span><span style=color:#111>)</span>
</span>    <span style=color:#111>{</span>
        <span style=color:#111>_conversationState</span> <span style=color:#111>=</span> <span style=color:#111>conversationState</span><span style=color:#111>;</span>
<span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#111>_dialog</span> <span style=color:#111>=</span> <span style=color:#111>dialog</span><span style=color:#111>;</span>
</span>    <span style=color:#111>}</span>

    <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnMessageActivityAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span><span style=color:#111>&lt;</span><span style=color:#111>IMessageActivity</span><span style=color:#111>&gt;</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
<span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>var</span> <span style=color:#111>dialogState</span> <span style=color:#111>=</span> <span style=color:#111>_conversationState</span><span style=color:#111>.</span><span style=color:#111>CreateProperty</span><span style=color:#111>&lt;</span><span style=color:#111>DialogState</span><span style=color:#111>&gt;(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>DialogState</span><span style=color:#111>));</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>        <span style=color:#00a8c8>await</span> <span style=color:#111>_dialog</span><span style=color:#111>.</span><span style=color:#111>RunAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>dialogState</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h2 id=ボットをカスタマイズする>ボットをカスタマイズする</h2><p><code>QnAMakerDialog</code>のコンストラクタの引数に、挙動をカスタマイズできるものがある。</p><p>引数のリスト：</p><ul><li><code>noAnswer</code> (Activity) - QnA Maker が回答を見つけられなかったときに返すアクティビティを指定する。</li><li><code>threshold</code> (float) - 質問のスコア(一致率)の閾値。</li><li><code>activeLearningCardTitle</code> (string) - アクティブラーニングが有効な場合にユーザーへ表示する、アクティブラーニングのオプションのカードのタイトル。</li><li><code>cardNoMatchText</code> (string) - アクティブラーニングが有効な場合に表示される。ボットが示したいずれの回答も適切でない場合に押すボタンのテキスト。</li><li><code>top</code> (int) - ナレッジベースから返す回答の最大数。</li><li><code>cardNoMatchResponse</code> (Activity) - アクティブラーニングが有効な際、ユーザーが「いずれにも該当しない」を押したときに返すメッセージ。</li><li><code>strictFilters</code> (Metadata[]) - QnA Maker のメタデータを指定して、ナレッジベースへのクエリのフィルタにする。</li><li><code>httpClient</code> (HttpClient) - QnA Maker サービスへリクエストを送るときに使う HTTP クライアント。nullの場合は既定のクライアントが使用される。</li><li><code>sourceFilePath</code> (string) - デバッグで使用する。ソースファイルパスを指定。既定でフルパスがセットされる。</li><li><code>sourceLineNumber</code> (int) - デバッグで使用する。ソースファイルの行番号。既定で呼び出し元のソースファイルの行番号がセットされる。</li></ul></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>