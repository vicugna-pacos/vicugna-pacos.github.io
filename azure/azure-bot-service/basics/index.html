<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta property="og:title" content="ボットのしくみ"><meta property="og:description" content="前提条件 Visual Studio 2019 Community 版で開発 言語はC#を選択 ボットのしくみ 参考：ボットのしくみ - Bot Service | Microsoft Docs ユーザーとボットとの間で行われるやり取りの一つ一つを「アクティビティ」と呼ぶ。 Bot Framework Serviceは、ユーザーがボッ"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/azure/azure-bot-service/basics/"><meta property="article:published_time" content="2020-09-23T19:11:50+09:00"><meta property="article:modified_time" content="2020-11-05T09:17:06+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ボットのしくみ"><meta name=twitter:description content="前提条件 Visual Studio 2019 Community 版で開発 言語はC#を選択 ボットのしくみ 参考：ボットのしくみ - Bot Service | Microsoft Docs ユーザーとボットとの間で行われるやり取りの一つ一つを「アクティビティ」と呼ぶ。 Bot Framework Serviceは、ユーザーがボッ"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>ボットのしくみ - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#前提条件>前提条件</a></li><li><a href=#ボットのしくみ>ボットのしくみ</a><ul><li><a href=#httpの詳細>HTTPの詳細</a></li><li><a href=#ターン>ターン</a></li></ul></li><li><a href=#アクティビティを処理する流れ>アクティビティを処理する流れ</a></li><li><a href=#activity-handler>Activity Handler</a><ul><li><a href=#基本形>基本形</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>ボットのしくみ</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-09-23 19:11:50 +0900 +0900" itemprop=datePublished>2020-09-23</time>
(最終更新：<time datetime="2020-11-05 09:17:06 +0900 +0900" itemprop=dateModified>2020-11-05</time>)</div><div></div></div><h2 id=前提条件>前提条件</h2><ul><li>Visual Studio 2019 Community 版で開発</li><li>言語はC#を選択</li></ul><h2 id=ボットのしくみ>ボットのしくみ</h2><p>参考：<a href="https://docs.microsoft.com/ja-jp/azure/bot-service/bot-builder-basics?view=azure-bot-service-4.0&tabs=csharp" target=_blank rel=noopener>ボットのしくみ - Bot Service | Microsoft Docs</a></p><p>ユーザーとボットとの間で行われるやり取りの一つ一つを「アクティビティ」と呼ぶ。
Bot Framework Serviceは、ユーザーがボットとの接続に使っているアプリ(Teamsとかの各チャネル)の情報をボットへ送る。
それぞれのチャネルは、固有の追加情報を含むことがある。
下図は、シンプルなEcho Botがどのようにアクティビティをやり取りするかを示している。</p><p><img src=2020-09-26-20-20-38.png alt><br>引用元：上記参考サイト</p><p>図には「conversation update」と「message」のアクティビティが書かれている。</p><p>「conversation update」アクティビティは、ユーザーがボットとの会話を始めたときなどに送られてくる。
ユーザーとボットの会話が始まった時は、2つの「conversation update」アクティビティが送られてくる。
1つはユーザーの追加、もう1つはボットの追加である。</p><p>「message」アクティビティは、ユーザーとボット間のメッセージを運ぶ。メッセージはシンプルなテキストだったり、画像やカードだったりする。</p><h3 id=httpの詳細>HTTPの詳細</h3><p>アクティビティがBot Framework Serviceからボットに送られる際は、HTTP POSTリクエストの形になっている。
ボットはそのリクエストに対して、HTTP status 200を返す。ボットから返すアクティビティは、別のHTTP POSTリクエストとしてBot Framework Serviceへ送る。
それに対して、Bot Framework Serviceから HTTP status 200が返ってくる。</p><p>ボットは、リクエストを受け取ってから15秒以内に HTTP status 200 を返さなくてはいけない。もし返せなかった場合は、HTTP GatewayTimeout(504)がおこる。</p><h3 id=ターン>ターン</h3><p>基本的に、ユーザーとボットのやり取りは、ユーザーのメッセージにボットが応答する形になる。
この行きかえりのやりとりを「ターン」という。
「ターンコンテキスト(turn context)」オブジェクトは、アクティビティに関する情報を提供してくれる(送受信者、チャネルなど)。</p><h2 id=アクティビティを処理する流れ>アクティビティを処理する流れ</h2><p>アクティビティをWebアプリケーション側で処理する流れを下図に示した。</p><p><img src=2020-11-05-09-04-17.png alt></p><p>Webアプリケーションは、C#のASP.NETのプロジェクトだったり、Node.jsのExpressやRestifyなどのフレームワークを使用したアプリだったりする。
これはAzureポータルでBot Serviceを作るときに選択したSDK言語によって変わる。</p><p>Bot Service がユーザーからのメッセージを受け取ると、WebアプリケーションへHTTP POSTリクエストを送る。
リクエストにはJSON形式のデータが含まれている。</p><p>WebアプリケーションのControllerクラスがそのリクエストを受け取ると、Adapterクラスの処理を呼び出す。
AdapterクラスがSDKのコアとなるコンポーネントで、このクラスがリクエストをデシリアライズし、TurnContextを生成したり、ActivityHandlerクラスのメソッドを呼び出したりする。</p><p>TurnContextは、ボットがアウトバウンド(ボット→ユーザー)アクティビティを送るための機能を提供する。
他にもアクティビティを更新・削除するためのメソッドも提供していて、それぞれのメソッドは非同期で実行される。</p><p>ただ、ボットの処理の終わりにはcontextオブジェクトが破棄されるため、
アクティビティ関連のメソッドを実行する際は、awaitを付けてメソッドの処理が終わるのを確実に待たないといけない。</p><h2 id=activity-handler>Activity Handler</h2><p>いわゆるボットクラス。ここでインバウンドのメッセージを処理して、どんなアウトバウンドのメッセージを返すかを実装する。</p><p>アクティビティの処理は、AdapterからActivityHandlerに渡される。ボットを作るときは、このActivityHandlerを拡張してロジックを実装していく。
ActivityHandlerには各イベントごとにメソッドがあるので、それぞれをオーバーライドして拡張していく感じ。
それぞれのメソッドに既存のロジックはないので、シンプルにメソッドをオーバーライドすれば良い(一部例外あり)。</p><p>C#でテンプレートを使って新しいプロジェクトを作った場合、ActivityHandlerを継承したクラスが既に作られている。<code>EmptyBot</code> とか、<code>EchoBot</code>がそれにあたる。</p><h3 id=基本形>基本形</h3><p>Echo Bot のActivityHandlerが参考になる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>namespace</span> <span style=color:#111>EchoBot1.Bots</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>EchoBot</span> <span style=color:#111>:</span> <span style=color:#111>ActivityHandler</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnMessageActivityAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span><span style=color:#111>&lt;</span><span style=color:#111>IMessageActivity</span><span style=color:#111>&gt;</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
        <span style=color:#111>{</span>
            <span style=color:#00a8c8>var</span> <span style=color:#111>replyText</span> <span style=color:#111>=</span> <span style=color:#d88200>$&#34;Echo: {turnContext.Activity.Text}&#34;</span><span style=color:#111>;</span>
            <span style=color:#00a8c8>await</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#111>replyText</span><span style=color:#111>,</span> <span style=color:#111>replyText</span><span style=color:#111>),</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
        <span style=color:#111>}</span>

        <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnMembersAddedAsync</span><span style=color:#111>(</span><span style=color:#111>IList</span><span style=color:#111>&lt;</span><span style=color:#111>ChannelAccount</span><span style=color:#111>&gt;</span> <span style=color:#111>membersAdded</span><span style=color:#111>,</span> <span style=color:#111>ITurnContext</span><span style=color:#111>&lt;</span><span style=color:#111>IConversationUpdateActivity</span><span style=color:#111>&gt;</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
        <span style=color:#111>{</span>
            <span style=color:#00a8c8>var</span> <span style=color:#111>welcomeText</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;Hello and welcome!&#34;</span><span style=color:#111>;</span>
            <span style=color:#75715e>// ユーザーとボットが会話に参加した場合、ボットについても当メソッドが呼び出されるので、
</span><span style=color:#75715e></span>            <span style=color:#75715e>// メンバーidがボットと同一でない場合だけ、挨拶を送信するようになっている。
</span><span style=color:#75715e></span>            <span style=color:#00a8c8>foreach</span> <span style=color:#111>(</span><span style=color:#00a8c8>var</span> <span style=color:#111>member</span> <span style=color:#00a8c8>in</span> <span style=color:#111>membersAdded</span><span style=color:#111>)</span>
            <span style=color:#111>{</span>
                <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>member</span><span style=color:#111>.</span><span style=color:#111>Id</span> <span style=color:#111>!=</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>Activity</span><span style=color:#111>.</span><span style=color:#111>Recipient</span><span style=color:#111>.</span><span style=color:#111>Id</span><span style=color:#111>)</span>
                <span style=color:#111>{</span>
                    <span style=color:#00a8c8>await</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#111>welcomeText</span><span style=color:#111>,</span> <span style=color:#111>welcomeText</span><span style=color:#111>),</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
                <span style=color:#111>}</span>
            <span style=color:#111>}</span>
        <span style=color:#111>}</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>