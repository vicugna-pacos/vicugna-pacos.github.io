<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta name=generator content="Hugo 0.74.1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>テキストメッセージの送受信 - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#メッセージの受信>メッセージの受信</a></li><li><a href=#メッセージの送信>メッセージの送信</a></li><li><a href=#入力していますのメッセージの送信>「入力しています」のメッセージの送信</a></li><li><a href=#いろいろなメッセージ>いろいろなメッセージ</a><ul><li><a href=#候補を提示する>候補を提示する</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>テキストメッセージの送受信</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-10-02 15:09:42 +0900 +0900" itemprop=datePublished>2020-10-02</time></div><div></div></div><h2 id=メッセージの受信>メッセージの受信</h2><p>ユーザーが送ってきたメッセージは、以下のようにして受け取る。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>var</span> <span style=color:#111>responseMessage</span> <span style=color:#111>=</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>Activity</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>;</span>
</code></pre></div><h2 id=メッセージの送信>メッセージの送信</h2><p>ボットからシンプルなテキストを送るには、以下のようにする。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>await</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Welcome!&#34;</span><span style=color:#111>);</span>
</code></pre></div><p>または、以下のようにする。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>var</span> <span style=color:#111>text</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;Welcome!&#34;</span><span style=color:#111>;</span>
<span style=color:#00a8c8>var</span> <span style=color:#111>msg</span> <span style=color:#111>=</span> <span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#111>text</span><span style=color:#111>,</span> <span style=color:#111>text</span><span style=color:#111>);</span>
<span style=color:#00a8c8>await</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#111>msg</span><span style=color:#111>);</span>
</code></pre></div><p><code>MessageFactory</code>は、ボットから送るメッセージを作るためのユーティリティクラス。
添付ファイルとかボタンとか色々追加できるので、たくさん使うことになる。</p><h2 id=入力していますのメッセージの送信>「入力しています」のメッセージの送信</h2><p>もし即座に返事を返せない場合、Teamsで出てくるような「○○が入力しています」のようなメッセージを返すことができる。
以下のサンプルは、ユーザーが「wait」と送ってきたときに、まず「入力しています」を送り、3秒後にメッセージを送信する。</p><p>※ Bot Framework Emulatorは非対応のためテストできない</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>SendTypingAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span><span style=color:#111>&lt;</span><span style=color:#111>IMessageActivity</span><span style=color:#111>&gt;</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#00a8c8>string</span><span style=color:#111>.</span><span style=color:#111>Equals</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>Activity</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;wait&#34;</span><span style=color:#111>,</span> <span style=color:#111>System</span><span style=color:#111>.</span><span style=color:#111>StringComparison</span><span style=color:#111>.</span><span style=color:#111>InvariantCultureIgnoreCase</span><span style=color:#111>))</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>await</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>SendActivitiesAsync</span><span style=color:#111>(</span>
            <span style=color:#00a8c8>new</span> <span style=color:#111>Activity</span><span style=color:#111>[]</span> <span style=color:#111>{</span>
                <span style=color:#00a8c8>new</span> <span style=color:#111>Activity</span> <span style=color:#111>{</span> <span style=color:#111>Type</span> <span style=color:#111>=</span> <span style=color:#111>ActivityTypes</span><span style=color:#111>.</span><span style=color:#111>Typing</span> <span style=color:#111>},</span>
                <span style=color:#00a8c8>new</span> <span style=color:#111>Activity</span> <span style=color:#111>{</span> <span style=color:#111>Type</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;delay&#34;</span><span style=color:#111>,</span> <span style=color:#111>Value</span><span style=color:#111>=</span> <span style=color:#ae81ff>3000</span> <span style=color:#111>},</span>
                <span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Finished typing&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Finished typing&#34;</span><span style=color:#111>),</span>
            <span style=color:#111>},</span>
            <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
    <span style=color:#111>}</span>
    <span style=color:#00a8c8>else</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>var</span> <span style=color:#111>replyText</span> <span style=color:#111>=</span> <span style=color:#d88200>$&#34;Echo: {turnContext.Activity.Text}. Say &#39;wait&#39; to watch me type.&#34;</span><span style=color:#111>;</span>
        <span style=color:#00a8c8>await</span> <span style=color:#111>turnContext</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#111>replyText</span><span style=color:#111>,</span> <span style=color:#111>replyText</span><span style=color:#111>),</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h2 id=いろいろなメッセージ>いろいろなメッセージ</h2><h3 id=候補を提示する>候補を提示する</h3><p><img src=2020-11-17-17-04-06.png alt></p><p><code>MessageFactory</code> で作成したメッセージに <code>SuggestedActions</code> を追加すると、ボットのメッセージの下にユーザーが押せるボタンが出てくる。
ユーザーがボタンを押すと、ボタンに設定した値がそのままユーザーの発言として返ってくる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>var</span> <span style=color:#111>reply</span> <span style=color:#111>=</span> <span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#d88200>&#34;実行したい処理を選んでください。&#34;</span><span style=color:#111>);</span>

<span style=color:#111>reply</span><span style=color:#111>.</span><span style=color:#111>SuggestedActions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>SuggestedActions</span><span style=color:#111>()</span>
<span style=color:#111>{</span>
    <span style=color:#111>Actions</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>CardAction</span><span style=color:#111>&gt;()</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>new</span> <span style=color:#111>CardAction</span><span style=color:#111>()</span> <span style=color:#111>{</span> <span style=color:#111>Title</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;処理1&#34;</span><span style=color:#111>,</span> <span style=color:#111>Type</span> <span style=color:#111>=</span> <span style=color:#111>ActionTypes</span><span style=color:#111>.</span><span style=color:#111>ImBack</span><span style=color:#111>,</span> <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;処理1&#34;</span> <span style=color:#111>},</span>
        <span style=color:#00a8c8>new</span> <span style=color:#111>CardAction</span><span style=color:#111>()</span> <span style=color:#111>{</span> <span style=color:#111>Title</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;処理2&#34;</span><span style=color:#111>,</span> <span style=color:#111>Type</span> <span style=color:#111>=</span> <span style=color:#111>ActionTypes</span><span style=color:#111>.</span><span style=color:#111>ImBack</span><span style=color:#111>,</span> <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;処理2&#34;</span> <span style=color:#111>},</span>
        <span style=color:#00a8c8>new</span> <span style=color:#111>CardAction</span><span style=color:#111>()</span> <span style=color:#111>{</span> <span style=color:#111>Title</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;処理3&#34;</span><span style=color:#111>,</span> <span style=color:#111>Type</span> <span style=color:#111>=</span> <span style=color:#111>ActionTypes</span><span style=color:#111>.</span><span style=color:#111>ImBack</span><span style=color:#111>,</span> <span style=color:#111>Value</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;処理3&#34;</span> <span style=color:#111>},</span>
    <span style=color:#111>}</span>
<span style=color:#111>};</span>

<span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#111>reply</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
</code></pre></div><p>厳密にいうと、<code>CardAction</code> のプロパティ <code>Type</code> によりボタンが押された時の動作が変わる。</p><p>参考：<a href="https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-howto-add-media-attachments?view=azure-bot-service-4.0&tabs=csharp#process-events-within-rich-cards" target=_blank rel=noopener>Add media to messages - Bot Service | Microsoft Docs</a></p></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>