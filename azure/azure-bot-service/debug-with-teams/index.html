<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta property="og:title" content="ローカルのボットをTeamsでデバッグ"><meta property="og:description" content="概要 ローカルでボットをテストする場合、Bot Framework Emulator を使えば基本的なデバッグは行える。 ただこれでは、Teams など特定のアプリと接続したときの検証はできない。 本記事では、ローカルにあるボットを Teams でデバッグ"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/azure/azure-bot-service/debug-with-teams/"><meta property="article:published_time" content="2020-12-18T11:35:12+09:00"><meta property="article:modified_time" content="2020-12-18T11:35:12+09:00"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>ローカルのボットをTeamsでデバッグ - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#bot-channels-registration-の作成>Bot Channels Registration の作成</a><ul><li><a href=#appid-などの取得>appId などの取得</a></li><li><a href=#secretjson-の作成>secret.json の作成</a></li></ul></li><li><a href=#ボット起動>ボット起動</a></li><li><a href=#ngrok-起動>ngrok 起動</a><ul><li><a href=#エンドポイントをボットチャネルに設定>エンドポイントをボットチャネルに設定</a></li></ul></li><li><a href=#webチャットでテスト>Webチャットでテスト</a></li><li><a href=#teams-に接続>Teams に接続</a></li><li><a href=#参考>参考</a></li></ul></nav></aside></div><div class=main><article><h1>ローカルのボットをTeamsでデバッグ</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-12-18 11:35:12 +0900 +0900" itemprop=datePublished>2020-12-18</time></div><div></div></div><h2 id=概要>概要</h2><p>ローカルでボットをテストする場合、Bot Framework Emulator を使えば基本的なデバッグは行える。
ただこれでは、Teams など特定のアプリと接続したときの検証はできない。
本記事では、ローカルにあるボットを Teams でデバッグする方法を記載する。</p><p>前提条件：</p><ul><li>Windows 10</li><li>Visual Studio 2019</li><li>Bot Framework SDK v4</li><li>C#</li><li><a href=https://ngrok.com/ target=_blank rel=noopener>ngrok</a> 登録＆インストール済み</li></ul><p>構成のイメージ図は下記の通り。</p><p><img src=2020-12-18-001.png alt></p><h2 id=bot-channels-registration-の作成>Bot Channels Registration の作成</h2><p>Azure にボットを作成するとき、多くの場合は「Web アプリボット」から作成すると思う。
「Web アプリボット」はボットのチャネル部分(Web アプリボット)とアプリ部分(App Service)の2つを同時に作成するが、「Bot Channels Registration」は、Webアプリボットの部分だけを作成する。</p><p><img src=2020-12-18-13-51-28.png alt></p><p>このとき、「メッセージング エンドポイント」は空白で登録する。ngrok は起動のたびにURLが変わるので、その都度Azureに登録するURLも変えなければいけない。<br>※ ngrok の有料プランを使っている場合はドメイン名を設定できるようなので、その場合は都度変更する必要がないかもしれない。</p><h3 id=appid-などの取得>appId などの取得</h3><p>作成したボットチャネルがあるリソースグループのページへ戻り、「デプロイ」→右側にあるデプロイ名 をクリック。</p><p><img src=2020-12-18-14-42-27.png alt></p><p>デプロイのページへ移動するので、左のメニューの「入力」をクリック。
「appId」と「appSecret」の値をコピーする。</p><p><img src=2020-12-18-14-46-27.png alt></p><h3 id=secretjson-の作成>secret.json の作成</h3><p>Visual Studio のボット用プロジェクトを開き、プロジェクト名で右クリック → 「ユーザー シークレットの管理」をクリック。
すると secrets.json が開くので、下記サンプルのように書いて、先ほどコピーした appId と appSecret を入力する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#111>{</span>
  <span style=color:#f92672>&#34;MicrosoftAppId&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;[appId]&#34;</span><span style=color:#111>,</span>
  <span style=color:#f92672>&#34;MicrosoftAppPassword&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;[appSecret]&#34;</span>
<span style=color:#111>}</span>
</code></pre></div><p>参考 secrets.jsonについて：<a href="https://docs.microsoft.com/ja-jp/aspnet/core/security/app-secrets?view=aspnetcore-5.0&tabs=windows" target=_blank rel=noopener>ASP.NET Core での開発におけるアプリシークレットの安全な保存 | Microsoft Docs</a></p><h2 id=ボット起動>ボット起動</h2><p>Visual Studio のボットアプリを起動する。起動と同時にブラウザが起動する設定にしている場合は、開いたブラウザをうっかり閉じたりしないように気を付ける。</p><h2 id=ngrok-起動>ngrok 起動</h2><p>コマンドプロンプトで下記を実行。</p><pre><code>ngrok http -host-header=&quot;localhost:3978&quot; 3978
</code></pre><p><code>-host-header</code> のオプションがないと、Webチャットでテストする際にボットから返事が来なかったりする。</p><h3 id=エンドポイントをボットチャネルに設定>エンドポイントをボットチャネルに設定</h3><p>ngrok 起動中に表示されるURLをコピーする。</p><p><img src=2020-12-18-14-03-34.png alt></p><p>Azure ポータルサイトでボットチャネルのページを開く。
左側のメニューの「設定」をクリック。「メッセージング エンドポイント」に先ほどコピーしたURLに <code>/api/messages</code> を付けたものを入力して保存する。</p><p><img src=2020-12-18-16-24-22.png alt></p><h2 id=webチャットでテスト>Webチャットでテスト</h2><p>ボットチャネルの「Webチャットでテスト」にて、メッセージの送受信が行えるか確認する。
無事に想定通りの動作をすれば、Azureとローカルのボットの間で対話ができている。</p><h2 id=teams-に接続>Teams に接続</h2><p>普通のボットと同じ方法で、Teamsに接続できる。</p><h2 id=参考>参考</h2><ul><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-service-debug-channel-ngrok target=_blank rel=noopener>Debug a channel using ngrok - Bot Service | Microsoft Docs</a></li><li><a href=https://qiita.com/chomado/items/23c66a975e21265d99ae target=_blank rel=noopener>【第4/5】Teams bot をローカル (Visual Studio 2019) で開発し、Azure で無料で動かす【その４：Teams に繋げてデバッグ編】 - Qiita</a></li></ul></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>