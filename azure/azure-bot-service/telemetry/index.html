<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>App Insights でログを記録 - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#環境設定>環境設定</a><ul><li><a href=#nuget-パッケージの追加>NuGet パッケージの追加</a></li><li><a href=#startupcs-の編集>Startup.cs の編集</a><ul><li><a href=#ユーザーが送ったメッセージをログに含める>ユーザーが送ったメッセージをログに含める</a></li></ul></li><li><a href=#adapterwitherrorhandlercs-の編集>AdapterWithErrorHandler.cs の編集</a></li><li><a href=#appsettingsjson-の編集>appsettings.json の編集</a></li></ul></li><li><a href=#dialog-に-application-insights-を追加>Dialog に Application Insights を追加</a></li><li><a href=#recognizer-に-application-insights-を追加>Recognizer に Application Insights を追加</a></li><li><a href=#分析>分析</a><ul><li><a href=#power-bi-desktop-で分析>Power BI Desktop で分析</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>App Insights でログを記録</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2021-01-15 15:42:29 +0900 +0900" itemprop=datePublished>2021-01-15</time></div><div></div></div><h2 id=はじめに>はじめに</h2><p>参考：</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-telemetry target=_blank rel=noopener>Add telemetry to your bot - Bot Service | Microsoft Docs</a></li></ul><p>Azure に Web アプリを置く場合、ログは Application Insights に記録するのが一つの方法である。
Application Insights にログを記録しておくと、あとから検索・分析ができたりする。
Bot Framework SDK にも、Application Insights へログを記録する機能が備わっていて、後述の編集を行うと大体必要なログが自動的に記録される。</p><p>ちなみに、Azure ポータルサイトで Web アプリボットのリソースを作成する際、「Application Insights を有効にする」かどうかのオプションがある。
しかし、これを有効にした際に記録されるログはあまり役に立たない気がするので、リソース作成時は無効にしておき、あとで自分で Application Insights のリソースを作成しておくとよい。</p><p>また、ボットが QnAMaker を使っている場合、QnAMaker のリソース作成時にも Application Insights を有効するかどうかのオプションがある。
本記事の手順で QnAMaker の結果もログ記録できるので、QnAMaker 側の Application Insights は必要ないと思われる。</p><h2 id=環境設定>環境設定</h2><h3 id=nuget-パッケージの追加>NuGet パッケージの追加</h3><p><code>Microsoft.Bot.Builder.Integration.ApplicationInsights.Core</code> を追加する。</p><h3 id=startupcs-の編集>Startup.cs の編集</h3><p>Startup.cs の ConfigureServices メソッドに下記を追加する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#111>ConfigureServices</span><span style=color:#111>(</span><span style=color:#111>IServiceCollection</span> <span style=color:#111>services</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#111>...</span>
        <span style=color:#75715e>// Add Application Insights services into service collection
</span><span style=color:#75715e></span>        <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddApplicationInsightsTelemetry</span><span style=color:#111>();</span>

        <span style=color:#75715e>// Create the telemetry client.
</span><span style=color:#75715e></span>        <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>IBotTelemetryClient</span><span style=color:#111>,</span> <span style=color:#111>BotTelemetryClient</span><span style=color:#111>&gt;();</span>

        <span style=color:#75715e>// Add telemetry initializer that will set the correlation context for all telemetry items.
</span><span style=color:#75715e></span>        <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>ITelemetryInitializer</span><span style=color:#111>,</span> <span style=color:#111>OperationCorrelationTelemetryInitializer</span><span style=color:#111>&gt;();</span>

        <span style=color:#75715e>// Add telemetry initializer that sets the user ID and session ID (in addition to other bot-specific properties such as activity ID)
</span><span style=color:#75715e></span>        <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>ITelemetryInitializer</span><span style=color:#111>,</span> <span style=color:#111>TelemetryBotIdInitializer</span><span style=color:#111>&gt;();</span>

        <span style=color:#75715e>// Create the telemetry middleware to initialize telemetry gathering
</span><span style=color:#75715e></span>        <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>TelemetryInitializerMiddleware</span><span style=color:#111>&gt;();</span>

        <span style=color:#75715e>// Create the telemetry middleware (used by the telemetry initializer) to track conversation events
</span><span style=color:#75715e></span>        <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>TelemetryLoggerMiddleware</span><span style=color:#111>&gt;();</span>
    <span style=color:#111>...</span>
<span style=color:#111>}</span>
</code></pre></div><h4 id=ユーザーが送ったメッセージをログに含める>ユーザーが送ったメッセージをログに含める</h4><p>上記の通りに実装すると、アクティビティの送受信がログに記録されるようになるが、ユーザーが送ってきたメッセージやユーザーIDなど、個人的な情報は既定では記録されない。
それらを有効にするには、<code>TelemetryLoggerMiddleware</code> のインスタンス生成時の引数の指定を追加する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// 変更前
</span><span style=color:#75715e></span><span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>TelemetryLoggerMiddleware</span><span style=color:#111>&gt;();</span>
<span style=color:#75715e>// ↓
</span><span style=color:#75715e>// 変更後
</span><span style=color:#75715e></span><span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>TelemetryLoggerMiddleware</span><span style=color:#111>&gt;(</span><span style=color:#111>sp</span> <span style=color:#111>=&gt;</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>telemetryClient</span> <span style=color:#111>=</span> <span style=color:#111>sp</span><span style=color:#111>.</span><span style=color:#111>GetService</span><span style=color:#111>&lt;</span><span style=color:#111>IBotTelemetryClient</span><span style=color:#111>&gt;();</span>
    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TelemetryLoggerMiddleware</span><span style=color:#111>(</span><span style=color:#111>telemetryClient</span><span style=color:#111>,</span> <span style=color:#111>logPersonalInformation</span><span style=color:#111>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>);</span>
<span style=color:#111>});</span>
</code></pre></div><p>このオプションを有効にする場合、ボットがメッセージやユーザーIDなどを収集することを、あらかじめユーザーに通知しておくとよさそう。
ボットのウェルカムメッセージにその旨を載せておくのが簡単かと思われる。</p><h3 id=adapterwitherrorhandlercs-の編集>AdapterWithErrorHandler.cs の編集</h3><p>AdapterWithErrorHandler.cs のコンストラクタ引数に <code>TelemetryInitializerMiddleware</code> を追加し、<code>Use</code> メソッドの呼び出しを追加する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>public</span> <span style=color:#111>AdapterWithErrorHandler</span><span style=color:#111>(</span><span style=color:#111>IConfiguration</span> <span style=color:#111>configuration</span><span style=color:#111>,</span> <span style=color:#111>ILogger</span><span style=color:#111>&lt;</span><span style=color:#111>BotFrameworkHttpAdapter</span><span style=color:#111>&gt;</span> <span style=color:#111>logger</span><span style=color:#111>,</span> <span style=color:#111>ConversationState</span> <span style=color:#111>conversationState</span> <span style=color:#111>=</span> <span style=color:#00a8c8>null</span>
    <span style=color:#111>,</span> <span style=color:#111>TelemetryInitializerMiddleware</span> <span style=color:#111>telemetryInitializerMiddleware</span>
    <span style=color:#111>)</span> <span style=color:#111>:</span> <span style=color:#00a8c8>base</span><span style=color:#111>(</span><span style=color:#111>configuration</span><span style=color:#111>,</span> <span style=color:#111>logger</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#111>...</span>
    <span style=color:#111>Use</span><span style=color:#111>(</span><span style=color:#111>telemetryInitializerMiddleware</span><span style=color:#111>);</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=appsettingsjson-の編集>appsettings.json の編集</h3><p>appsettings.json またはユーザーシークレットに、Application Insights のインストルメンテーションキーを追加する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#111>{</span>
    <span style=color:#f92672>&#34;ApplicationInsights&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span>
        <span style=color:#f92672>&#34;InstrumentationKey&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#34;</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p>これで、ログを Application Insights に記録する準備が整った。</p><h2 id=dialog-に-application-insights-を追加>Dialog に Application Insights を追加</h2><p>ComponentDialog や AdaptiveDialog のコンストラクタ引数に <code>IBotTelemetryClient</code> を追加してフィールド変数に代入しておくと、Dialog のログが出力されるようになる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>public</span> <span style=color:#111>MainDialog</span><span style=color:#111>(</span><span style=color:#111>IConfiguration</span> <span style=color:#111>configuration</span><span style=color:#111>,</span> <span style=color:#111>ILogger</span><span style=color:#111>&lt;</span><span style=color:#111>MainDialog</span><span style=color:#111>&gt;</span> <span style=color:#111>logger</span><span style=color:#111>,</span> <span style=color:#111>IBotTelemetryClient</span> <span style=color:#111>telemetryClient</span><span style=color:#111>)</span>
    <span style=color:#111>:</span> <span style=color:#00a8c8>base</span><span style=color:#111>(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>MainDialog</span><span style=color:#111>))</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>TelemetryClient</span> <span style=color:#111>=</span> <span style=color:#111>telemetryClient</span><span style=color:#111>;</span>
    <span style=color:#111>...</span>
<span style=color:#111>}</span>
</code></pre></div><h2 id=recognizer-に-application-insights-を追加>Recognizer に Application Insights を追加</h2><p>AdaptiveDialog で使う QnAMaker や LUIS の Recognizer に <code>IBotTelemetryClient</code> を渡すと、QnAMaker や LUIS の検証結果がログ出力されるようになる。</p><p>下記は、AdaptiveDialog のコンストラクタで、Recognizer に <code>IBotTelemetryClient</code> を渡しているサンプル。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00a8c8>public</span> <span style=color:#111>RootDialog</span><span style=color:#111>(</span><span style=color:#111>IConfiguration</span> <span style=color:#111>configuration</span><span style=color:#111>,</span> <span style=color:#111>IBotTelemetryClient</span> <span style=color:#111>telemetryClient</span><span style=color:#111>)</span> <span style=color:#111>:</span> <span style=color:#00a8c8>base</span><span style=color:#111>(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>RootDialog</span><span style=color:#111>))</span>
<span style=color:#111>{</span>
<span style=display:block;width:100%;background-color:#e1e1e1>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>TelemetryClient</span> <span style=color:#111>=</span> <span style=color:#111>telemetryClient</span><span style=color:#111>;</span>
</span>
    <span style=color:#111>Recognizer</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>RecognizerSet</span><span style=color:#111>()</span>
    <span style=color:#111>{</span>
        <span style=color:#111>Recognizers</span> <span style=color:#111>=</span>
        <span style=color:#111>{</span>
            <span style=color:#00a8c8>new</span> <span style=color:#111>QnAMakerRecognizer</span><span style=color:#111>()</span>
            <span style=color:#111>{</span>
                <span style=color:#111>HostName</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;qna:hostname&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>EndpointKey</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;qna:endpointKey&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>KnowledgeBaseId</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;qna:KnowledgeBaseId&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>QnAId</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;turn.qnaIdFromPrompt&#34;</span><span style=color:#111>,</span>
                <span style=color:#111>IncludeDialogNameInMetadata</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span>
<span style=display:block;width:100%;background-color:#e1e1e1>                <span style=color:#111>TelemetryClient</span> <span style=color:#111>=</span> <span style=color:#111>telemetryClient</span><span style=color:#111>,</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>                <span style=color:#111>LogPersonalInformation</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span>            <span style=color:#111>},</span>
            <span style=color:#00a8c8>new</span> <span style=color:#111>LuisAdaptiveRecognizer</span><span style=color:#111>()</span>
            <span style=color:#111>{</span>
                <span style=color:#111>ApplicationId</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;luis:applicationId&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>EndpointKey</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;luis:endpointKey&#34;</span><span style=color:#111>],</span>
                <span style=color:#111>Endpoint</span> <span style=color:#111>=</span> <span style=color:#111>configuration</span><span style=color:#111>[</span><span style=color:#d88200>&#34;luis:endpoint&#34;</span><span style=color:#111>],</span>
<span style=display:block;width:100%;background-color:#e1e1e1>                <span style=color:#111>TelemetryClient</span> <span style=color:#111>=</span> <span style=color:#111>telemetryClient</span><span style=color:#111>,</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>                <span style=color:#111>LogPersonalInformation</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span>            <span style=color:#111>}</span>
        <span style=color:#111>}</span>
    <span style=color:#111>};</span>
    <span style=color:#75715e>// 略
</span><span style=color:#75715e></span><span style=color:#111>}</span>
</code></pre></div><h2 id=分析>分析</h2><p>※ Bot Framework Solutions を使っているなら、<a href=https://microsoft.github.io/botframework-solutions/solution-accelerators/tutorials/view-analytics/1-intro/ target=_blank rel=noopener>Power BI のテンプレート</a> を使って Power BI からログを分析できる。ただし、Solutions を使わずにボットを作っている場合は、このテンプレートを使ってもあまり有用なデータは得られない。</p><p>集まったログは Azure ポータルサイトの Application Insights のリソースのページで検索できる。
とりあえず直近のログの一覧を見たい場合は、ページ左側のメニューから「トランザクションの検索」を選ぶ。直近24時間のログが表示される。
クエリを使って検索・分析したい場合は、「ログ」を選ぶ。クエリは「Kusto クエリ」というものを使う。SQLと似ているので、SQLを知っているなら応用がききやすいと思う。</p><p>参考：<a href=https://docs.microsoft.com/en-us/azure/data-explorer/kusto/concepts/ target=_blank rel=noopener>Getting started with Kusto | Microsoft Docs</a></p><p>ボットのログはほとんどが customEvents テーブルに蓄積されている。QnAMaker の場合は、name = QnAMakerRecognizerResult にある。それぞれの customEvents の詳しい内容は、customDimentions 列の中に json 形式で格納されている。</p><p>↓クエリのサンプルと結果</p><pre><code>customEvents
| where name == &quot;QnAMakerRecognizerResult&quot; and 
    customDimensions.activityType == &quot;message&quot;
| project
    timestamp,
    customDimensions
</code></pre><p><img src=2021-01-19-14-13-27.png alt></p><p>json は 直下のプロパティであれば <code>customDimentions.Intents</code> というようにドットでつなげて参照できる。
ただし、2階層目以降は、都度 <code>parse_json(tostring(プロパティ))</code> としないとアクセスできない。</p><p>↓クエリのサンプルと結果</p><pre><code>customEvents
| where name == &quot;QnAMakerRecognizerResult&quot; and 
    customDimensions.activityType == &quot;message&quot;
| extend d = parse_json(tostring(customDimensions))
| extend i = parse_json(tostring(d.Intents))
| project
    timestamp,
    customDimensions,
    score_ok = i.QnAMatch.score,
    score_ng = d.Intents.QnAMatch.score
</code></pre><p><img src=2021-01-19-14-20-34.png alt></p><h3 id=power-bi-desktop-で分析>Power BI Desktop で分析</h3><p>Azure ポータルサイトのクエリのページで色々検索するのもよいが、Power BI を使って検索するのも良いと思う。
特に customDimensions を目的に合わせてパースしていくのはクエリが煩雑になりがちなので、customEvents テーブルのデータを素のまま Power BI に取り込み、
あとは好みに合わせて Power BI 上でカスタマイズするのも良いと思う。</p><p>下記に、Power BI から Application Insights を検索する方法を示す。</p><p>まず、Azure ポータルサイトのクエリのページでクエリを入力する。
細かい抽出などは Power BI で行うため、ここではただ customEvents テーブルを全件検索する。
既定では直近3日間くらいのデータしか抽出されないため、下記のようにして検索条件で直近60日のデータが取得されるようにすると良い。</p><pre><code>customEvents
| where timestamp &gt; ago(60d)
</code></pre><p>クエリができたら、「エクスポート」→「Power BI へエクスポート (M Query)」をクリックする。</p><p><img src=2021-01-19-16-25-21.png alt></p><p>クエリが書かれたテキストファイルがダウンロードされる。</p><p>次に Power BI を起動し、新しいレポートを作成する。
「データを取得」の画面が表示されたら、「その他」の「空のクエリ」を選ぶ。</p><p>クエリエディターが起動するので、リボンの「詳細エディター」をクリックする。</p><p><img src=2021-01-19-16-30-04.png alt></p><p>詳細エディターの画面が表示されるので、先ほどダウンロードしたテキストファイルの内容をコピーして置換する。
そのあと、クエリの内容を確認し、下記画像のように <code>#"timespan"="P3D",</code> と書かれている部分がある場合は削除する。</p><p><img src=2021-01-19-17-35-41.png alt></p><p>これがあると、検索条件で直近60日間を指定していても、結局データが直近3日間に絞られてしまう。なので、これを利用して、クエリの where 句は無くして <code>#"timespan"="P60D",</code> としても良いかもしれない。</p><p>詳細エディターの「完了」を押すと、customEvents テーブルのデータが表示される。</p><p><img src=2021-01-19-16-37-45.png alt></p><p>このとき、Application Insights への接続が初めての場合、資格情報の入力を求められる。
「組織アカウント」→「サインイン」とクリックし、Azure のアカウントを入力すると接続できるようになる。</p><p><img src=2021-01-19-16-35-27.png alt></p><p>GitHub アカウントで Azure を使っている場合でも、GitHub アカウントのメールアドレスを入力すると自動的に GitHub 経由でのログインになる。</p><p>ちなみに、クエリの結果を見ると、customDimensions の方が文字列になっている。
JSONにするには、クエリエディターで customDimensions を選択し、リボンの「変換」タブ→「解析」→「JSON」とクリックする。</p></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>