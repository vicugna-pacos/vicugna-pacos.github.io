<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>会話の実装 (Dialog) - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Azure</li><li>Azure Bot Service</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#ライブラリの追加>ライブラリの追加</a></li><li><a href=#dialog-の種類>Dialog の種類</a></li><li><a href=#waterfalldialog>WaterfallDialog</a><ul><li><a href=#componentdialogを作成する>ComponentDialogを作成する</a></li><li><a href=#ステップを作成する>ステップを作成する</a><ul><li><a href=#ステップの戻り値>ステップの戻り値</a></li></ul></li><li><a href=#dialogを定義する>Dialogを定義する</a></li><li><a href=#ボットからdialogを呼び出す>ボットからDialogを呼び出す</a></li><li><a href=#dialogをdiに登録する>DialogをDIに登録する</a></li><li><a href=#実行してみる>実行してみる</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>会話の実装 (Dialog)</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-10-02 13:55:11 +0900 +0900" itemprop=datePublished>2020-10-02</time>
(最終更新：<time datetime="2021-06-23 13:12:13 +0900 +0900" itemprop=dateModified>2021-06-23</time>)</div><div></div></div><h2 id=はじめに>はじめに</h2><p>参考：</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-dialog target=_blank rel=noopener>Dialogs within the Bot Framework SDK - Bot Service | Microsoft Docs</a></li></ul><p>前提条件：</p><ul><li>Windows 10</li><li>Visual Studio 2019</li><li>C#</li></ul><p>Dialog は SDK の中核をなすもので、ユーザーとボットの会話のやり取りの管理を助けるライブラリである。
ステートレスなWebアプリにおいて、「今どこまで話したか？」を記憶・管理してくれる。
ボットの主な処理は Dialog クラスに実装するのがほとんどだと思う。</p><h2 id=ライブラリの追加>ライブラリの追加</h2><p>ボットで Dialog を使うには、プロジェクトに下記 NuGet パッケージを追加する。</p><pre><code>Microsoft.Bot.Builder.Dialogs
</code></pre><p>Dialogには色々な種類があるが、Adaptive Dialog が使えるなら Adaptive Dialog を主に使った方が良い。</p><h2 id=dialog-の種類>Dialog の種類</h2><p>現在色々な種類の Dialog があるが、まず使うのは Adaptive Dialog だと思う。複数の Dialog をまとめるための Component Dialog も使う。</p><ul><li>Component Dialog<ul><li>複数の Dialog をひとまとめににできる Dialog。</li></ul></li><li>Waterfall Dialog<ul><li>分岐やループのないシンプルな会話の流れを、ステップとして定義するDialog。Adaptive Dialog が上位互換になるので、新たに Waterfall Dialog を使うケースは少ないかもしれない。</li></ul></li><li>Prompt Dialog<ul><li>ユーザーへインプットを求め、回答を受け取るための小さな部品。Promptにはいくつか種類があり、それぞれ有効な入力値が得られるか、キャンセルされるまで自動的に質問を繰り返してくれる。Waterfall Dialogで使用するために設計された。</li></ul></li><li>Adaptive Dialog<ul><li>イベントトリガーを使って柔軟な会話を実装できる Dialog。大体の場合はこちらを使う。</li></ul></li><li>Action Dialog<ul><li>Adaptive Dialog で使用できる。Dialog の振る舞いが実装されたもの。メッセージ送信、条件分岐、ループなど、多彩なサブクラスがある。</li></ul></li><li>Input Dialog<ul><li>Adaptive Dialog で使用できる。Prompt の上位互換のようなもの。</li></ul></li></ul><h2 id=waterfalldialog>WaterfallDialog</h2><p>WaterfallDialogとは、決まった順番でユーザーへ質問を行い、回答を収集するようなケースで使用する。
このダイアログでは「ステップ」になるメソッドを定義して、それを順番に並べて定義する。</p><p><img src=2020-10-15-09-35-36.png alt></p><p>上記の例では、ステップが3つある。まず1番目のステップで最初の質問を行う。
2番目のステップで、最初の質問の回答を受け取り、保存するなどの処理をする。そして続けて次の質問を行う。</p><h3 id=componentdialogを作成する>ComponentDialogを作成する</h3><p>Dialogを実装する場合、まずラッパーとなる ComponentDialog クラスを作成し、その中にDialogを作りこんでいく。基本的な作り方は下記のサンプルの通り。<br>※ <code>UserData</code>は UserState に保存するオブジェクト。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>Microsoft.Bot.Builder.Dialogs</span><span style=color:#111>;</span>

<span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>WaterfallSampleDialog</span> <span style=color:#111>:</span> <span style=color:#111>ComponentDialog</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>readonly</span> <span style=color:#00a8c8>string</span> <span style=color:#111>DIALOG_ID</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;WaterfallSampleDialog&#34;</span><span style=color:#111>;</span>

    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>readonly</span> <span style=color:#111>IStatePropertyAccessor</span><span style=color:#111>&lt;</span><span style=color:#111>UserData</span><span style=color:#111>&gt;</span> <span style=color:#111>_accessor</span><span style=color:#111>;</span>

    <span style=color:#75715e>// コンストラクタ
</span><span style=color:#75715e></span>    <span style=color:#75715e>// ユーザーから得た回答は何かしら保存する必要があるため、UserStateやConversationStateを引数で受け取ることが多いと思う。
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>public</span> <span style=color:#111>WaterfallSampleDialog</span><span style=color:#111>(</span><span style=color:#111>UserState</span> <span style=color:#111>userState</span><span style=color:#111>)</span> <span style=color:#111>:</span> <span style=color:#00a8c8>base</span><span style=color:#111>(</span><span style=color:#111>DIALOG_ID</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
        <span style=color:#111>_accessor</span> <span style=color:#111>=</span> <span style=color:#111>userState</span><span style=color:#111>.</span><span style=color:#111>CreateProperty</span><span style=color:#111>&lt;</span><span style=color:#111>UserData</span><span style=color:#111>&gt;(</span><span style=color:#d88200>&#34;UserData&#34;</span><span style=color:#111>);</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=ステップを作成する>ステップを作成する</h3><p>ステップはメソッドとして定義する。メソッドの引数、戻り値は下記サンプルの通り。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>DialogTurnResult</span><span style=color:#111>&gt;</span> <span style=color:#111>XXXStepAsync</span><span style=color:#111>(</span><span style=color:#111>WaterfallStepContext</span> <span style=color:#111>stepContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
<span style=color:#111>}</span>
</code></pre></div><p>参考：<a href="https://docs.microsoft.com/ja-jp/dotnet/api/microsoft.bot.builder.dialogs.waterfallstep?view=botbuilder-dotnet-stable" target=_blank rel=noopener>WaterfallStep Delegate (Microsoft.Bot.Builder.Dialogs) | Microsoft Docs</a></p><p>今回のサンプルの場合、最初のステップでユーザーの名前を聞く。テキストの回答を受け付ける場合は、<code>TextPrompt</code> を使用する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>DialogTurnResult</span><span style=color:#111>&gt;</span> <span style=color:#111>Step1Async</span><span style=color:#111>(</span><span style=color:#111>WaterfallStepContext</span> <span style=color:#111>stepContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>prompt</span> <span style=color:#111>=</span> <span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#d88200>&#34;あなたの名前は？&#34;</span><span style=color:#111>);</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>options</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>PromptOptions</span>
    <span style=color:#111>{</span>
        <span style=color:#111>Prompt</span> <span style=color:#111>=</span> <span style=color:#111>prompt</span>
    <span style=color:#111>};</span>
    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>PromptAsync</span><span style=color:#111>(</span><span style=color:#d88200>&#34;TextPrompt&#34;</span><span style=color:#111>,</span> <span style=color:#111>options</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
<span style=color:#111>}</span>
</code></pre></div><p>2番目のステップでは、名前を受け取りつつ次の質問をする。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>DialogTurnResult</span><span style=color:#111>&gt;</span> <span style=color:#111>Step2Async</span><span style=color:#111>(</span><span style=color:#111>WaterfallStepContext</span> <span style=color:#111>stepContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#75715e>// 回答を保存する
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#111>name</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#00a8c8>string</span><span style=color:#111>)</span><span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>Result</span><span style=color:#111>;</span>

    <span style=color:#00a8c8>var</span> <span style=color:#111>userData</span> <span style=color:#111>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>_accessor</span><span style=color:#111>.</span><span style=color:#111>GetAsync</span><span style=color:#111>(</span><span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>,</span> <span style=color:#111>()</span> <span style=color:#111>=&gt;</span> <span style=color:#00a8c8>new</span> <span style=color:#111>UserData</span><span style=color:#111>());</span>
    <span style=color:#111>userData</span><span style=color:#111>.</span><span style=color:#111>name</span> <span style=color:#111>=</span> <span style=color:#111>name</span><span style=color:#111>;</span>

    <span style=color:#75715e>// 追加でメッセージを送ることも可能
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#111>msg</span> <span style=color:#111>=</span> <span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#d88200>$&#34;{name}さん こんにちは！&#34;</span><span style=color:#111>);</span>
    <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#111>msg</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

    <span style=color:#75715e>// 次の質問をする
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#111>prompt</span> <span style=color:#111>=</span> <span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#d88200>&#34;好きな色は？&#34;</span><span style=color:#111>);</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>choices</span> <span style=color:#111>=</span> <span style=color:#111>ChoiceFactory</span><span style=color:#111>.</span><span style=color:#111>ToChoices</span><span style=color:#111>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#00a8c8>string</span><span style=color:#111>&gt;</span> <span style=color:#111>{</span> <span style=color:#d88200>&#34;赤&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;青&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;黄&#34;</span> <span style=color:#111>});</span>
    <span style=color:#00a8c8>var</span> <span style=color:#111>options</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>PromptOptions</span>
    <span style=color:#111>{</span>
        <span style=color:#111>Prompt</span> <span style=color:#111>=</span> <span style=color:#111>prompt</span><span style=color:#111>,</span>
        <span style=color:#111>Choices</span> <span style=color:#111>=</span> <span style=color:#111>choices</span>
    <span style=color:#111>};</span>
    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>PromptAsync</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ChoicePrompt&#34;</span><span style=color:#111>,</span> <span style=color:#111>options</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
<span style=color:#111>}</span>
</code></pre></div><p>最後のステップでは、2番目の回答の保存と、会話の終了をさせる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span><span style=color:#111>&lt;</span><span style=color:#111>DialogTurnResult</span><span style=color:#111>&gt;</span> <span style=color:#111>Step3Async</span><span style=color:#111>(</span><span style=color:#111>WaterfallStepContext</span> <span style=color:#111>stepContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#75715e>// 回答を保存する
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#111>choice</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#111>FoundChoice</span><span style=color:#111>)</span><span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>Result</span><span style=color:#111>;</span>

    <span style=color:#00a8c8>var</span> <span style=color:#111>userData</span> <span style=color:#111>=</span> <span style=color:#00a8c8>await</span> <span style=color:#111>_accessor</span><span style=color:#111>.</span><span style=color:#111>GetAsync</span><span style=color:#111>(</span><span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>,</span> <span style=color:#111>()</span> <span style=color:#111>=&gt;</span> <span style=color:#00a8c8>new</span> <span style=color:#111>UserData</span><span style=color:#111>());</span>
    <span style=color:#111>userData</span><span style=color:#111>.</span><span style=color:#111>color</span> <span style=color:#111>=</span> <span style=color:#111>choice</span><span style=color:#111>.</span><span style=color:#111>Value</span><span style=color:#111>;</span>

    <span style=color:#00a8c8>var</span> <span style=color:#111>msg</span> <span style=color:#111>=</span> <span style=color:#111>MessageFactory</span><span style=color:#111>.</span><span style=color:#111>Text</span><span style=color:#111>(</span><span style=color:#d88200>$&#34;{choice.Value}が好きなんですね&#34;</span><span style=color:#111>);</span>
    <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>Context</span><span style=color:#111>.</span><span style=color:#111>SendActivityAsync</span><span style=color:#111>(</span><span style=color:#111>msg</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

    <span style=color:#75715e>// 会話の終わり
</span><span style=color:#75715e></span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>EndDialogAsync</span><span style=color:#111>(</span><span style=color:#111>cancellationToken</span><span style=color:#111>:</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
<span style=color:#111>}</span>
</code></pre></div><h4 id=ステップの戻り値>ステップの戻り値</h4><p>ステップのメソッドは、必ず <code>DialogTurnResult</code> を返す。
<code>DialogTurnResult</code> に持たせるパラメータによって、次のステップへ進むか、Dialogの流れを終わらせるか、などを制御できる。</p><p>大体の戻り値は、引数の <code>stepContext</code> のメソッドを呼び出せばよい。</p><p>以下に戻り値のパターンのサンプルを示す：</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>// ユーザーにPromptを送り、入力を待つ。
</span><span style=color:#75715e>// ユーザーの入力が正しい場合、次のステップへ進む。正しくない場合はPromptによって当ステップが繰り返される。
</span><span style=color:#75715e></span><span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>PromptAsync</span><span style=color:#111>(</span><span style=color:#d88200>&#34;TextPrompt&#34;</span><span style=color:#111>,</span> <span style=color:#111>promptOptions</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

<span style=color:#75715e>// ユーザーの入力を待つ
</span><span style=color:#75715e></span><span style=color:#00a8c8>return</span> <span style=color:#00a8c8>new</span> <span style=color:#111>DialogTurnResult</span><span style=color:#111>(</span><span style=color:#111>DialogTurnStatus</span><span style=color:#111>.</span><span style=color:#111>Waiting</span><span style=color:#111>);</span>

<span style=color:#75715e>// 当ステップを飛ばす
</span><span style=color:#75715e>// 第1引数は、次のステップへ渡すResultを指定する。
</span><span style=color:#75715e></span><span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>NextAsync</span><span style=color:#111>(</span><span style=color:#00a8c8>null</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

<span style=color:#75715e>// Dialogを終わらせる。最後のステップの戻り値はこれでないといけない
</span><span style=color:#75715e></span><span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>EndDialogAsync</span><span style=color:#111>(</span><span style=color:#111>cancellationToken</span><span style=color:#111>:</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

<span style=color:#75715e>// 現在の Dialog を終了させ、他の Dialog を開始する。
</span><span style=color:#75715e></span><span style=color:#00a8c8>return</span> <span style=color:#00a8c8>await</span> <span style=color:#111>stepContext</span><span style=color:#111>.</span><span style=color:#111>ReplaceDialogAsync</span><span style=color:#111>(</span><span style=color:#111>DIALOG_ID</span><span style=color:#111>,</span> <span style=color:#00a8c8>null</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
</code></pre></div><p>参考：
<a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.bot.builder.dialogs.dialogturnstatus?view=botbuilder-dotnet-stable" target=_blank rel=noopener>DialogTurnStatus Enum (Microsoft.Bot.Builder.Dialogs) | Microsoft Docs</a></p><h3 id=dialogを定義する>Dialogを定義する</h3><p>ComponentDialog のコンストラクタで、今まで定義したステップをつかってWaterfallDialogを作成する。作成した Dialog はComponentDialogへ登録し、ステップ中で使用する Prompt も同じように ComponentDialog へ登録する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>// コンストラクタ
</span><span style=color:#75715e></span><span style=color:#00a8c8>public</span> <span style=color:#111>WaterfallSampleDialog</span><span style=color:#111>(</span><span style=color:#111>UserState</span> <span style=color:#111>userState</span><span style=color:#111>)</span> <span style=color:#111>:</span> <span style=color:#00a8c8>base</span><span style=color:#111>(</span><span style=color:#111>DIALOG_ID</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#111>_accessor</span> <span style=color:#111>=</span> <span style=color:#111>userState</span><span style=color:#111>.</span><span style=color:#111>CreateProperty</span><span style=color:#111>&lt;</span><span style=color:#111>UserData</span><span style=color:#111>&gt;(</span><span style=color:#d88200>&#34;UserData&#34;</span><span style=color:#111>);</span>

<span style=display:block;width:100%;background-color:#e1e1e1>    <span style=color:#75715e>// dialogの登録
</span></span><span style=display:block;width:100%;background-color:#e1e1e1><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#111>steps</span> <span style=color:#111>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>WaterfallStep</span><span style=color:#111>[]</span> <span style=color:#111>{</span> <span style=color:#111>Step1Async</span><span style=color:#111>,</span> <span style=color:#111>Step2Async</span><span style=color:#111>,</span> <span style=color:#111>Step3Async</span> <span style=color:#111>};</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>
</span><span style=display:block;width:100%;background-color:#e1e1e1>    <span style=color:#111>AddDialog</span><span style=color:#111>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>WaterfallDialog</span><span style=color:#111>(</span><span style=color:#d88200>&#34;WaterfallDialog1&#34;</span><span style=color:#111>,</span> <span style=color:#111>steps</span><span style=color:#111>));</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>    <span style=color:#111>AddDialog</span><span style=color:#111>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>TextPrompt</span><span style=color:#111>(</span><span style=color:#d88200>&#34;TextPrompt&#34;</span><span style=color:#111>));</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>    <span style=color:#111>AddDialog</span><span style=color:#111>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ChoicePrompt</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ChoicePrompt&#34;</span><span style=color:#111>));</span>
</span><span style=display:block;width:100%;background-color:#e1e1e1>
</span><span style=display:block;width:100%;background-color:#e1e1e1>    <span style=color:#75715e>// 最初に実行するdialogを指定する
</span></span><span style=display:block;width:100%;background-color:#e1e1e1><span style=color:#75715e></span>    <span style=color:#111>InitialDialogId</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;WaterfallDialog1&#34;</span><span style=color:#111>;</span>
</span><span style=color:#111>}</span>
</code></pre></div><p>これで Dialog は完成となる。</p><h3 id=ボットからdialogを呼び出す>ボットからDialogを呼び出す</h3><p>できあがった Dialog をボットから実行する。DialogはDIでインスタンスを取得し、<code>OnMessageActivityAsync</code> で呼び出す。
その際、Dialog自身の状態管理に ConversationState が必要なので、一緒に渡す。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>SampleBot</span> <span style=color:#111>:</span> <span style=color:#111>ActivityHandler</span>
<span style=color:#111>{</span>
    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>readonly</span> <span style=color:#111>ConversationState</span> <span style=color:#111>_conversationState</span><span style=color:#111>;</span>
    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>readonly</span> <span style=color:#111>UserState</span> <span style=color:#111>_userState</span><span style=color:#111>;</span>
    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>readonly</span> <span style=color:#111>WaterfallSampleDialog</span> <span style=color:#111>_dialog</span><span style=color:#111>;</span>

    <span style=color:#00a8c8>public</span> <span style=color:#111>SampleBot</span><span style=color:#111>(</span><span style=color:#111>ConversationState</span> <span style=color:#111>conversationState</span><span style=color:#111>,</span> <span style=color:#111>UserState</span> <span style=color:#111>userState</span><span style=color:#111>,</span> <span style=color:#111>WaterfallSampleDialog</span> <span style=color:#111>dialog</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
        <span style=color:#111>_conversationState</span> <span style=color:#111>=</span> <span style=color:#111>conversationState</span><span style=color:#111>;</span>
        <span style=color:#111>_userState</span> <span style=color:#111>=</span> <span style=color:#111>userState</span><span style=color:#111>;</span>
        <span style=color:#111>_dialog</span> <span style=color:#111>=</span> <span style=color:#111>dialog</span><span style=color:#111>;</span>
    <span style=color:#111>}</span>

    <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnMessageActivityAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span><span style=color:#111>&lt;</span><span style=color:#111>IMessageActivity</span><span style=color:#111>&gt;</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>var</span> <span style=color:#111>dialogState</span> <span style=color:#111>=</span> <span style=color:#111>_conversationState</span><span style=color:#111>.</span><span style=color:#111>CreateProperty</span><span style=color:#111>&lt;</span><span style=color:#111>DialogState</span><span style=color:#111>&gt;(</span><span style=color:#111>nameof</span><span style=color:#111>(</span><span style=color:#111>DialogState</span><span style=color:#111>));</span>
        <span style=color:#00a8c8>await</span> <span style=color:#111>_dialog</span><span style=color:#111>.</span><span style=color:#111>RunAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>dialogState</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
    <span style=color:#111>}</span>

    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>override</span> <span style=color:#00a8c8>async</span> <span style=color:#111>Task</span> <span style=color:#111>OnTurnAsync</span><span style=color:#111>(</span><span style=color:#111>ITurnContext</span> <span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>CancellationToken</span> <span style=color:#111>cancellationToken</span> <span style=color:#111>=</span> <span style=color:#00a8c8>default</span><span style=color:#111>)</span>
    <span style=color:#111>{</span>
        <span style=color:#00a8c8>await</span> <span style=color:#00a8c8>base</span><span style=color:#111>.</span><span style=color:#111>OnTurnAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>

        <span style=color:#75715e>// state保存
</span><span style=color:#75715e></span>        <span style=color:#00a8c8>await</span> <span style=color:#111>_conversationState</span><span style=color:#111>.</span><span style=color:#111>SaveChangesAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
        <span style=color:#00a8c8>await</span> <span style=color:#111>_userState</span><span style=color:#111>.</span><span style=color:#111>SaveChangesAsync</span><span style=color:#111>(</span><span style=color:#111>turnContext</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#111>cancellationToken</span><span style=color:#111>);</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=dialogをdiに登録する>DialogをDIに登録する</h3><p><code>Startup.cs</code> の <code>ConfigureServices</code> メソッドで、Dialogクラスをサービスに登録する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#111>ConfigureServices</span><span style=color:#111>(</span><span style=color:#111>IServiceCollection</span> <span style=color:#111>services</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
    <span style=color:#111>services</span><span style=color:#111>.</span><span style=color:#111>AddSingleton</span><span style=color:#111>&lt;</span><span style=color:#111>WaterfallSampleDialog</span><span style=color:#111>&gt;();</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=実行してみる>実行してみる</h3><p><img src=2020-10-15-14-33-54.png alt></p><p>こちらから話しかけないとDialogが始まらないが、ステップ1～3の会話ができている。</p></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>