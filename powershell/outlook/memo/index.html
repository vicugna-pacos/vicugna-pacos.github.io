<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta property="og:title" content="PowerShellでOutlookを操作する"><meta property="og:description" content="はじめに PowerShellでVBAみたいなことができる Outlook版。 前提条件 PowerShell v5.1 Outlook 365 起動と終了 function main() { # 起動済みのOutlookがあるか確認 $outlookProcess = Get-Process -Name &#34;OUTLOOK&#34; -ErrorAction SilentlyContinue $needQuit = $false if ($outlookProcess -eq $null) { $needQuit = $true } $outlook = New-Object -ComObject Outlook.Application try { $namespace ="><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/powershell/outlook/memo/"><meta property="article:published_time" content="2020-09-30T20:08:58+09:00"><meta property="article:modified_time" content="2020-09-30T20:08:58+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PowerShellでOutlookを操作する"><meta name=twitter:description content="はじめに PowerShellでVBAみたいなことができる Outlook版。 前提条件 PowerShell v5.1 Outlook 365 起動と終了 function main() { # 起動済みのOutlookがあるか確認 $outlookProcess = Get-Process -Name &#34;OUTLOOK&#34; -ErrorAction SilentlyContinue $needQuit = $false if ($outlookProcess -eq $null) { $needQuit = $true } $outlook = New-Object -ComObject Outlook.Application try { $namespace ="><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>PowerShellでOutlookを操作する - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>PowerShell</li><li>Outlook VBA</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#前提条件>前提条件</a></li><li><a href=#起動と終了>起動と終了</a><ul><li><a href=#起動済みoutlookの確認>起動済みOutlookの確認</a></li></ul></li><li><a href=#受信トレイや予定表の取得>受信トレイや予定表の取得</a></li><li><a href=#特定のフォルダを取得>特定のフォルダを取得</a></li><li><a href=#フォルダ内のアイテムを取得>フォルダ内のアイテムを取得</a><ul><li><a href=#すべてのアイテムを取得>すべてのアイテムを取得</a></li><li><a href=#フィルターを使う>フィルターを使う</a></li></ul></li><li><a href=#終日の予定を作る>終日の予定を作る</a></li><li><a href=#appointmentitem-予定アイテム>AppointmentItem (予定アイテム)</a><ul><li><a href=#プロパティ>プロパティ</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>PowerShellでOutlookを操作する</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-09-30 20:08:58 +0900 +0900" itemprop=datePublished>2020-09-30</time></div><div></div></div><h2 id=はじめに>はじめに</h2><p>PowerShellでVBAみたいなことができる Outlook版。</p><h2 id=前提条件>前提条件</h2><ul><li>PowerShell v5.1</li><li>Outlook 365</li></ul><h2 id=起動と終了>起動と終了</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#00a8c8>function</span> <span style=color:#111>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
    <span style=color:#75715e># 起動済みのOutlookがあるか確認</span>
    <span style=color:#111>$outlookProcess</span> <span style=color:#111>=</span> <span style=color:#111>Get-Process</span> <span style=color:#111>-Name</span> <span style=color:#d88200>&#34;OUTLOOK&#34;</span> <span style=color:#111>-ErrorAction</span> <span style=color:#111>SilentlyContinue</span>
    <span style=color:#111>$needQuit</span> <span style=color:#111>=</span> <span style=color:#111>$false</span>
    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>$outlookProcess</span> <span style=color:#f92672>-eq</span> <span style=color:#111>$null</span><span style=color:#111>)</span> <span style=color:#111>{</span>
        <span style=color:#111>$needQuit</span> <span style=color:#111>=</span> <span style=color:#111>$true</span>
    <span style=color:#111>}</span>

    <span style=color:#111>$outlook</span> <span style=color:#111>=</span> <span style=color:#111>New-Object</span> <span style=color:#111>-ComObject</span> <span style=color:#111>Outlook</span><span style=color:#111>.</span><span style=color:#111>Application</span>
    <span style=color:#00a8c8>try</span> <span style=color:#111>{</span>
        <span style=color:#111>$namespace</span> <span style=color:#111>=</span> <span style=color:#111>$outlook</span><span style=color:#111>.</span><span style=color:#111>GetNamespace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MAPI&#34;</span><span style=color:#111>)</span>

        <span style=color:#75715e># ここに色々処理を書く</span>

    <span style=color:#111>}</span> <span style=color:#00a8c8>finally</span> <span style=color:#111>{</span>
        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>$needQuit</span><span style=color:#111>)</span> <span style=color:#111>{</span>
            <span style=color:#00a8c8>[void]</span><span style=color:#111>$outlook</span><span style=color:#111>.</span><span style=color:#111>Quit</span><span style=color:#111>()</span>
            <span style=color:#00a8c8>[void][System.Runtime.Interopservices.Marshal]</span><span style=color:#111>::</span><span style=color:#111>ReleaseComObject</span><span style=color:#111>(</span><span style=color:#111>$outlook</span><span style=color:#111>)</span>
        <span style=color:#111>}</span>
    <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=起動済みoutlookの確認>起動済みOutlookの確認</h3><p>Outlookの場合、起動するインスタンスは常に1つらしい。
Outlookが起動した状態でスクリプトを実行すると、スクリプトは起動済みのOutlookを使うので、処理の最後に起動していたOutlookが終了してしまう。
それを避けるために、インスタンス取得の前にプロセスを確認し、起動しているOutlookがある場合は、最後に終了させないようにした方が良いかもしれない。
(便利スクリプト起動のたびにOutlookが終了したら便利ではないため)</p><h2 id=受信トレイや予定表の取得>受信トレイや予定表の取得</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># 目的に合わせてフォルダ取得</span>
<span style=color:#75715e># 予定表</span>
<span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderCalendar</span><span style=color:#111>)</span>
<span style=color:#75715e># 連絡先</span>
<span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderContacts</span><span style=color:#111>)</span>
<span style=color:#75715e># 下書き</span>
<span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderDrafts</span><span style=color:#111>)</span>
<span style=color:#75715e># 受信トレイ</span>
<span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderInbox</span><span style=color:#111>)</span>
<span style=color:#75715e># タスク</span>
<span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderTasks</span><span style=color:#111>)</span>
<span style=color:#75715e># To Do</span>
<span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderToDo</span><span style=color:#111>)</span>
</code></pre></div><p><code>GetDefaultFolder</code>を使用しない場合は、<code>$namespace.Folders</code>をあさって目的のフォルダを取得する。
フォルダ階層は、以下のようになっている(※Office365のメールアカウントの場合)。</p><ul><li>パブリックフォルダ</li><li>自分のメールアカウント(フォルダ名はメールアドレス)<ul><li>受信トレイ</li><li>予定表</li><li>タスク　等</li></ul></li><li>共有メールアカウント(フォルダ名はアカウント名)<ul><li>受信トレイ</li><li>予定表</li><li>タスク　等</li></ul></li></ul><h2 id=特定のフォルダを取得>特定のフォルダを取得</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>&lt;#
</span><span style=color:#75715e>aaa@example.com\受信トレイ\テストフォルダ　など\区切りで指定したフォルダを取得する
</span><span style=color:#75715e>必要な変数：
</span><span style=color:#75715e> $namespace
</span><span style=color:#75715e>#&gt;</span>
<span style=color:#00a8c8>function</span> <span style=color:#111>getFolder</span><span style=color:#111>(</span><span style=color:#111>$folderName</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#111>$names</span> <span style=color:#111>=</span> <span style=color:#111>$folderName</span><span style=color:#111>.</span><span style=color:#111>Split</span><span style=color:#111>(</span><span style=color:#d88200>&#34;\&#34;</span><span style=color:#111>)</span>
    <span style=color:#111>$folders</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>Folders</span>
    <span style=color:#111>$result</span> <span style=color:#111>=</span> <span style=color:#111>$null</span>

    <span style=color:#00a8c8>foreach</span> <span style=color:#111>(</span><span style=color:#111>$name</span> <span style=color:#00a8c8>in</span> <span style=color:#111>$names</span><span style=color:#111>)</span> <span style=color:#111>{</span>
        <span style=color:#111>$result</span> <span style=color:#111>=</span> <span style=color:#111>$null</span>

        <span style=color:#00a8c8>foreach</span> <span style=color:#111>(</span><span style=color:#111>$folder</span> <span style=color:#00a8c8>in</span> <span style=color:#111>$folders</span><span style=color:#111>)</span> <span style=color:#111>{</span>
            <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>$folder</span><span style=color:#111>.</span><span style=color:#111>Name</span> <span style=color:#f92672>-eq</span> <span style=color:#111>$name</span><span style=color:#111>)</span> <span style=color:#111>{</span>
                <span style=color:#111>$result</span> <span style=color:#111>=</span> <span style=color:#111>$folder</span>
                <span style=color:#111>$folders</span> <span style=color:#111>=</span> <span style=color:#111>$folder</span><span style=color:#111>.</span><span style=color:#111>Folders</span>
                <span style=color:#00a8c8>break</span>
            <span style=color:#111>}</span>
        <span style=color:#111>}</span>
    <span style=color:#111>}</span>

    <span style=color:#00a8c8>return</span> <span style=color:#111>$result</span>
<span style=color:#111>}</span>
</code></pre></div><h2 id=フォルダ内のアイテムを取得>フォルダ内のアイテムを取得</h2><p>メールの場合、MailItem
予定表の場合、AppointmentItem</p><h3 id=すべてのアイテムを取得>すべてのアイテムを取得</h3><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#00a8c8>foreach</span> <span style=color:#111>(</span><span style=color:#111>$item</span> <span style=color:#00a8c8>in</span> <span style=color:#111>$folder</span><span style=color:#111>.</span><span style=color:#111>Items</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#111>Write-Host</span> <span style=color:#111>$item</span><span style=color:#111>.</span><span style=color:#111>Subject</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=フィルターを使う>フィルターを使う</h3><p>フィルターを使うと、例えば「件名が●●のアイテム」を抽出したりできる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#111>$items</span> <span style=color:#111>=</span> <span style=color:#111>$folder</span><span style=color:#111>.</span><span style=color:#111>Items</span><span style=color:#111>.</span><span style=color:#111>Find</span><span style=color:#111>()</span>    <span style=color:#75715e># 条件に一致するItemを1件だけ返す</span>
<span style=color:#111>$items</span> <span style=color:#111>=</span> <span style=color:#111>$folder</span><span style=color:#111>.</span><span style=color:#111>Items</span><span style=color:#111>.</span><span style=color:#111>Restrict</span><span style=color:#111>()</span>    <span style=color:#75715e># 条件に一致するItemを全件返す</span>
</code></pre></div><p>フィルター構文については下記参照。<br><a href=https://vicugna-pacos.github.io/vba/outlook/search-and-filter/>検索やフィルターの構文</a></p><h2 id=終日の予定を作る>終日の予定を作る</h2><p>「終日」の予定とは、時間指定がない予定のこと。</p><p><img src=2020-10-21-17-34-43.png alt></p><p>参考：<a href=https://docs.microsoft.com/ja-jp/office/client-developer/outlook/pia/how-to-create-an-appointment-that-is-an-all-day-event target=_blank rel=noopener>終日イベントの予定を作成する | Microsoft Docs</a></p><p>終日の予定を作るための要件は、下記の通り：</p><ul><li><code>AllDayEvent</code>を<code>true</code>にする</li><li><code>Start</code>は開始日の0時を指定</li><li><code>End</code>は終了日の次の日の0時を指定する</li></ul><p>下記のサンプルでは、2020年1月1日に終日の予定を作成している。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># アセンブリのロード</span>
<span style=color:#00a8c8>[void][Reflection.Assembly]</span><span style=color:#111>::</span><span style=color:#111>LoadWithPartialName</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Microsoft.Office.Interop.Outlook&#34;</span><span style=color:#111>)</span>

<span style=color:#75715e># 列挙型を変数に入れておく</span>
<span style=color:#111>$OlDefaultFolders</span> <span style=color:#111>=</span> <span style=color:#00a8c8>[Microsoft.Office.Interop.Outlook.OlDefaultFolders]</span>
<span style=color:#111>$OlItemType</span> <span style=color:#111>=</span> <span style=color:#00a8c8>[Microsoft.Office.Interop.Outlook.OlItemType]</span>
<span style=color:#111>$OlBusyStatus</span> <span style=color:#111>=</span> <span style=color:#00a8c8>[Microsoft.Office.Interop.Outlook.OlBusyStatus]</span>

<span style=color:#75715e># --- 中略 ---</span>

<span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderCalendar</span><span style=color:#111>)</span>

<span style=color:#111>$date</span> <span style=color:#111>=</span> <span style=color:#00a8c8>[DateTime]</span><span style=color:#111>::</span><span style=color:#111>ParseExact</span><span style=color:#111>(</span><span style=color:#d88200>&#34;20200101&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;yyyyMMdd&#34;</span><span style=color:#111>,</span> <span style=color:#111>$null</span><span style=color:#111>)</span>

<span style=color:#111>$newItem</span> <span style=color:#111>=</span> <span style=color:#111>$outlook</span><span style=color:#111>.</span><span style=color:#111>CreateItem</span><span style=color:#111>(</span><span style=color:#111>$OlItemType</span><span style=color:#111>::</span><span style=color:#111>olAppointmentItem</span><span style=color:#111>)</span>
<span style=color:#111>$newItem</span><span style=color:#111>.</span><span style=color:#111>Subject</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;終日の予定&#34;</span>
<span style=color:#111>$newItem</span><span style=color:#111>.</span><span style=color:#111>Start </span><span style=color:#111>=</span> <span style=color:#111>$date</span>
<span style=color:#111>$newItem</span><span style=color:#111>.</span><span style=color:#00a8c8>End</span> <span style=color:#111>=</span> <span style=color:#111>$date</span><span style=color:#111>.</span><span style=color:#111>AddDays</span><span style=color:#111>(</span><span style=color:#111>1</span><span style=color:#111>)</span>
<span style=color:#111>$newItem</span><span style=color:#111>.</span><span style=color:#111>AllDayEvent</span> <span style=color:#111>=</span> <span style=color:#111>$true</span>
<span style=color:#111>$newItem</span><span style=color:#111>.</span><span style=color:#111>BusyStatus</span> <span style=color:#111>=</span> <span style=color:#111>$OlBusyStatus</span><span style=color:#111>::</span><span style=color:#111>olFree</span>  <span style=color:#75715e># 空き時間</span>
<span style=color:#111>$newItem</span><span style=color:#111>.</span><span style=color:#111>Save</span><span style=color:#111>()</span>
</code></pre></div><h2 id=appointmentitem-予定アイテム>AppointmentItem (予定アイテム)</h2><p><a href=https://docs.microsoft.com/ja-jp/office/vba/api/outlook.appointmentitem>https://docs.microsoft.com/ja-jp/office/vba/api/outlook.appointmentitem</a></p><h3 id=プロパティ>プロパティ</h3><ul><li><code>Subject</code> (文字) 件名</li><li><code>Start</code> (日付) 開始日時</li><li><code>End</code> (日付) 終了日時</li><li><code>AllDayEvent</code> (Boolean) 終日かどうか</li><li><code>Body</code> (文字) 本文</li><li><code>BusyStatus</code> (<code>OlBusyStatus</code>) 予定の公開方法<ul><li><code>olBusy</code> (2) 予定あり</li><li><code>olFree</code> (0) 空き時間</li><li><code>olOutOfOffice</code> (3) 外出中</li><li><code>olTentative</code> (1) 仮の予定</li><li><code>olWorkingElsewhere</code> (4) 他の場所で作業中</li></ul></li><li><code>ReminderSet</code> (Boolean) リマインダーを付けるかどうか</li><li><code>ReminderMinutesBeforeStart</code> (数値) 何分前にリマインダーを鳴らすか</li><li><code>Duration</code> (long) 所要時間(分)</li><li><code>Importance</code> (<code>OlImportance</code>) 重要度<ul><li><code>olImportanceHigh</code> (2)</li><li><code>olImportanceLow</code> (0)</li><li><code>olImportanceNormal</code> (1)</li></ul></li><li><code>IsRecurring</code> (Boolean) 繰り返しの予定かどうか</li><li><code>Location</code> (文字) 場所</li><li><code>Attachments</code> (コレクション) 添付ファイル</li><li><code>MeetingStatus</code> (<code>OlMeetingStatus</code>) 会議予定かどうかとその状態<ul><li><code>olMeeting</code> (1) 会議予定である</li><li><code>olMeetingCanceled</code> (5) キャンセルされた会議予定</li><li><code>olMeetingReceived</code> (3) 受信した会議予定</li><li><code>olMeetingReceivedAndCanceled</code> (7) キャンセルされたがカレンダーに残っている会議予定</li><li><code>olNonMeeting</code> (0) 会議ではない予定</li></ul></li><li><code>Recipients</code> (コレクション) 出席者</li></ul></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>