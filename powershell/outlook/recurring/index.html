<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>繰り返しの予定 - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>PowerShell</li><li>Outlook VBA</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#概要>概要</a></li><li><a href=#繰り返しの予定の参照>繰り返しの予定の参照</a><ul><li><a href=#getoccurrence-メソッド>GetOccurrence メソッド</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>繰り返しの予定</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-10-28 13:39:53 +0900 +0900" itemprop=datePublished>2020-10-28</time></div><div></div></div><h2 id=はじめに>はじめに</h2><p>Outlookの予定、タスクに設定できる「繰り返し」について。</p><h2 id=概要>概要</h2><p>参照：<a href=https://docs.microsoft.com/en-us/office/vba/api/outlook.recurrencepattern target=_blank rel=noopener>RecurrencePattern object (Outlook) | Microsoft Docs</a></p><p><code>AppointmentItem</code> または <code>TaskItem</code> で設定できる。
上記2つには <code>IsRecurring</code>(Boolean) プロパティがあり、まずこれで繰り返しのアイテムかどうか確認できる。
繰り返しの詳細は、<code>GetRecurrencePattern</code> メソッドで取得できる。
<code>GetRecurrencePattern</code> または <code>ClearRecurrencePattern</code> メソッドを呼び出すと、<code>IsRecurring</code> プロパティが自動的に変更される。
つまり、何も気にせず <code>GetRecurrencePattern</code> を呼び出すと、<code>IsRecurring</code> が勝手に true になるので注意。</p><h2 id=繰り返しの予定の参照>繰り返しの予定の参照</h2><p>例えば 2020/10/1 12:00～13:00 に作った予定「test昼休み」を繰り返しの予定にしたとする。</p><ul><li>開始日 - 2020/10/1</li><li>終了日 - 2020/10/31</li><li>繰り返しのパターン - 毎日</li><li>間隔 - 1日ごと</li></ul><p>これに対して、10/01～10/31すべての予定を取りたい場合は、以下のサンプルのように検索する。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#111>$OlDefaultFolders</span> <span style=color:#111>=</span> <span style=color:#00a8c8>[Microsoft.Office.Interop.Outlook.OlDefaultFolders]</span>

<span style=color:#111>$namespace</span> <span style=color:#111>=</span> <span style=color:#111>$outlook</span><span style=color:#111>.</span><span style=color:#111>GetNamespace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;MAPI&#34;</span><span style=color:#111>)</span>
<span style=color:#111>$folder</span> <span style=color:#111>=</span> <span style=color:#111>$namespace</span><span style=color:#111>.</span><span style=color:#111>GetDefaultFolder</span><span style=color:#111>(</span><span style=color:#111>$OlDefaultFolders</span><span style=color:#111>::</span><span style=color:#111>olFolderCalendar</span><span style=color:#111>)</span>

<span style=color:#111>$allItems</span> <span style=color:#111>=</span> <span style=color:#111>$folder</span><span style=color:#111>.</span><span style=color:#111>Items</span>
<span style=color:#111>$allItems</span><span style=color:#111>.</span><span style=color:#111>Sort</span><span style=color:#111>(</span><span style=color:#d88200>&#34;[Start]&#34;</span><span style=color:#111>)</span>
<span style=color:#111>$allItems</span><span style=color:#111>.</span><span style=color:#111>IncludeRecurrences</span> <span style=color:#111>=</span> <span style=color:#111>$true</span>

<span style=color:#111>$filter</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;[Start] &gt;= &#39;2020/10/01 00:00&#39;&#34;</span>
<span style=color:#111>$filter</span> <span style=color:#111>=</span> <span style=color:#111>$filter</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34; AND [Start] &lt;= &#39;2020/11/01 00:00&#39;&#34;</span>
<span style=color:#111>$filter</span> <span style=color:#111>=</span> <span style=color:#111>$filter</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34; AND [Subject] = &#39;test昼休み&#39;&#34;</span>

<span style=color:#111>$items</span> <span style=color:#111>=</span> <span style=color:#111>$allItems</span><span style=color:#111>.</span><span style=color:#111>Restrict</span><span style=color:#111>(</span><span style=color:#111>$filter</span><span style=color:#111>)</span>
</code></pre></div><p>Filter や Restrict を使う前に、Items を Start の昇順で並べ替えてから IncludeRecurrences プロパティを true にする。
もし Items に終了日のない繰り返しの予定があるときに IncludeRecurrences をtrueにすると、Items.Count の値がundefinedになるので注意。</p><p>参考：<a href=https://docs.microsoft.com/en-us/office/vba/api/outlook.items.includerecurrences target=_blank rel=noopener>Items.IncludeRecurrences property (Outlook) | Microsoft Docs</a></p><h3 id=getoccurrence-メソッド>GetOccurrence メソッド</h3><p><code>AppointmentItem.RecurrencePattern().GetOccurrence(DateTime)</code> メソッドを使うと、
繰り返しの予定のうち、指定した日付の <code>AppointmentItem</code> を取得できる。
指定した日に予定がない場合はエラーになる。</p><pre><code>この定期的なアイテムの 1 回分に変更を加えたので、この回はもう存在しません。開いているアイテムをすべて閉じて、再度実行してください。
発生場所 C:\xxxtest.ps1:39 文字:17
+ ...             $newItem = $item.GetRecurrencePattern().GetOccurrence($dt ...
+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OperationStopped: (:) [], COMException
    + FullyQualifiedErrorId : System.Runtime.InteropServices.COMException
</code></pre><p>引数に指定する日付は、<strong>予定の開始時刻と同時刻でなければいけない</strong> 。「test昼休み」の場合、単純に「2020/10/08」と日付だけ指定している下記のサンプルではエラーになる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># $item は「test昼休み」のAppointmentItem</span>
<span style=color:#00a8c8>[DateTime]</span><span style=color:#111>$dt</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;2020/10/08&#34;</span>
<span style=color:#111>$item2</span> <span style=color:#111>=</span> <span style=color:#111>$item</span><span style=color:#111>.</span><span style=color:#111>GetRecurrencePattern</span><span style=color:#111>().</span><span style=color:#111>GetOccurrence</span><span style=color:#111>(</span><span style=color:#111>$dt</span><span style=color:#111>)</span>
</code></pre></div><p>正しくは、「test昼休み」が始まる12:00も指定しなくてはいけない。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># $item は「test昼休み」のAppointmentItem</span>
<span style=color:#00a8c8>[DateTime]</span><span style=color:#111>$dt</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;2020/10/08 12:00&#34;</span>
<span style=color:#111>$item2</span> <span style=color:#111>=</span> <span style=color:#111>$item</span><span style=color:#111>.</span><span style=color:#111>GetRecurrencePattern</span><span style=color:#111>().</span><span style=color:#111>GetOccurrence</span><span style=color:#111>(</span><span style=color:#111>$dt</span><span style=color:#111>)</span>
</code></pre></div><p>参考：<a href=https://stackoverflow.com/questions/12167921/getoccurrence-always-throws-exception target=_blank rel=noopener>vb.net - GetOccurrence always throws exception - Stack Overflow</a></p><p>検索したい全ての日付について GetOccurrence メソッドで総当たりすれば、繰り返しの予定が全て取得できる。</p></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>