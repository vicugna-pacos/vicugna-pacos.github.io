<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>Trello APIを実行する - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>PowerShell</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#apiキーとトークンを取得する>APIキーとトークンを取得する</a></li><li><a href=#自分が所属するボードの一覧を取得>自分が所属するボードの一覧を取得</a></li><li><a href=#ボードのリスト一覧を取得>ボードのリスト一覧を取得</a></li><li><a href=#カードを作成>カードを作成</a></li><li><a href=#認証>認証</a></li></ul></nav></aside></div><div class=main><article><h1>Trello APIを実行する</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2020-11-02 16:26:39 +0900 +0900" itemprop=datePublished>2020-11-02</time>
(最終更新：<time datetime="2020-11-06 10:16:22 +0900 +0900" itemprop=dateModified>2020-11-06</time>)</div><div></div></div><h2 id=はじめに>はじめに</h2><p>PowerShellで、Trelloのカード作成などを自動化したい。</p><ul><li>Windows 10</li><li>PowerShell v5.1</li></ul><h2 id=apiキーとトークンを取得する>APIキーとトークンを取得する</h2><p>参考：<a href=https://developer.atlassian.com/cloud/trello/guides/rest-api/api-introduction/ target=_blank rel=noopener>API Introduction</a></p><p><a href=https://trello.com/app-key target=_blank rel=noopener>https://trello.com/app-key</a> へアクセス。</p><p>画面に表示されるAPIキーをコピーして保存しておく。
そのあと、自分でテストするためのAPIトークンを取得する。APIキーの下に記載されている「トークン」のリンクをクリックする。</p><p><img src=2020-11-02-17-48-29.png alt></p><p>このアプリを許可するかどうか確認する画面が表示されるので、下へスクロールして「許可」を押す。</p><p>「以下のトークンを使用したTrelloアカウントへのアクセスを許可しました」の画面になる。
トークンをコピーして保存する。</p><p><img src=2020-11-02-18-54-04.png alt></p><p>この手順で取得するトークンはあくまでも自分用なので、APIキーを使ったスクリプトを共有する際は、トークンはユーザーに取得してもらうことになる。</p><h2 id=自分が所属するボードの一覧を取得>自分が所属するボードの一覧を取得</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#111>$params</span> <span style=color:#111>=</span> <span style=color:#111>@{</span>
    <span style=color:#111>key</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;APIキー&#34;</span>
    <span style=color:#111>token</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;トークン&#34;</span>
<span style=color:#111>}</span>
<span style=color:#111>$uri</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;https://api.trello.com/1/members/me/boards&#34;</span>
<span style=color:#111>$response</span> <span style=color:#111>=</span> <span style=color:#111>Invoke-WebRequest</span> <span style=color:#111>-Uri</span> <span style=color:#111>$uri</span> <span style=color:#111>-Body</span> <span style=color:#111>$params</span>
<span style=color:#111>$content</span> <span style=color:#111>=</span> <span style=color:#111>$response</span><span style=color:#111>.</span><span style=color:#111>Content</span>
<span style=color:#111>$boards</span> <span style=color:#111>=</span> <span style=color:#111>ConvertFrom-Json</span> <span style=color:#111>$content</span>

<span style=color:#00a8c8>foreach</span> <span style=color:#111>(</span><span style=color:#111>$item</span> <span style=color:#00a8c8>in</span> <span style=color:#111>$boards</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#111>Write-Host</span> <span style=color:#111>$item</span><span style=color:#111>.</span><span style=color:#111>id</span>
    <span style=color:#111>Write-Host</span> <span style=color:#111>$item</span><span style=color:#111>.</span><span style=color:#111>name</span>
    <span style=color:#111>Write-Host</span> <span style=color:#111>$item</span><span style=color:#111>.</span><span style=color:#111>url</span>
    <span style=color:#111>Write-Host</span> <span style=color:#d88200>&#34;&#34;</span>
<span style=color:#111>}</span>
</code></pre></div><p>自分が所属するボードの一覧を取得できる。ここで取得できるボードIDを、カード作成などのAPIで使用するので、まずこのAPIを実行してボードIDのリストを取得しておくと良い。</p><h2 id=ボードのリスト一覧を取得>ボードのリスト一覧を取得</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#111>$params</span> <span style=color:#111>=</span> <span style=color:#111>@{</span>
    <span style=color:#111>key</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;APIキー&#34;</span>
    <span style=color:#111>token</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;トークン&#34;</span>
<span style=color:#111>}</span>
<span style=color:#111>$boardId</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;ボードID&#34;</span>

<span style=color:#111>$uri</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;https://api.trello.com/1/boards/${boardId}/lists&#34;</span>
<span style=color:#111>$response</span> <span style=color:#111>=</span> <span style=color:#111>Invoke-WebRequest</span> <span style=color:#111>-Uri</span> <span style=color:#111>$uri</span> <span style=color:#111>-Body</span> <span style=color:#111>$params</span>
<span style=color:#111>$content</span> <span style=color:#111>=</span> <span style=color:#111>$response</span><span style=color:#111>.</span><span style=color:#111>Content</span>
<span style=color:#111>$lists</span> <span style=color:#111>=</span> <span style=color:#111>ConvertFrom-Json</span> <span style=color:#111>$content</span>

<span style=color:#00a8c8>foreach</span> <span style=color:#111>(</span><span style=color:#111>$item</span> <span style=color:#00a8c8>in</span> <span style=color:#111>$lists</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#111>Write-Host</span> <span style=color:#111>$item</span><span style=color:#111>.</span><span style=color:#111>id</span>
    <span style=color:#111>Write-Host</span> <span style=color:#111>$item</span><span style=color:#111>.</span><span style=color:#111>name</span>
    <span style=color:#111>Write-Host</span> <span style=color:#d88200>&#34;&#34;</span>
<span style=color:#111>}</span>
</code></pre></div><p>特定のボードのリスト (カードをまとめるグループのようなもの) の一覧を取得できる。
APIでカード作成などを行う場合、どのリストに作成するかは必須指定なので、このAPIをあらかじめ実行してリストIDを取得しておくと良い。</p><h2 id=カードを作成>カードを作成</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#111>$params</span> <span style=color:#111>=</span> <span style=color:#111>@{</span>
    <span style=color:#111>key</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;APIキー&#34;</span>
    <span style=color:#111>token</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;トークン&#34;</span>
    <span style=color:#111>idList</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;リストID&#34;</span>
    <span style=color:#111>idCardSource</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;テンプレートカードID&#34;</span>
    <span style=color:#111>name</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;カードの名前&#34;</span>
<span style=color:#111>}</span>

<span style=color:#111>$uri</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;https://api.trello.com/1/cards&#34;</span>
<span style=color:#111>$response</span> <span style=color:#111>=</span> <span style=color:#111>Invoke-WebRequest</span> <span style=color:#111>-Uri</span> <span style=color:#111>$uri</span> <span style=color:#111>-Body</span> <span style=color:#111>$params</span> <span style=color:#111>-Method</span> <span style=color:#d88200>&#34;POST&#34;</span>
</code></pre></div><p>既存のカードを元ネタにして、新しいカードを作成する。
<code>idCardSource</code> を指定しなければ、元ネタ無しで新しいカードを作成する。</p><h2 id=認証>認証</h2><p>参考：<a href=https://developer.atlassian.com/cloud/trello/guides/rest-api/authorization/ target=_blank rel=noopener>Authorization</a></p><p>APIがユーザーの認証を得る方法は2つある。
1つは <code>1/authorize</code> 経由、もう1つはOAuthを使う方法があるが、今回は <code>1/authorize</code> を利用してトークンを得ることにする。</p><p>処理の流れとしては、大まかに下記の通り：</p><ol><li>スクリプトはブラウザで <code>https://api.trello.com/1/authorize</code> を開く。</li><li>スクリプトはトークンの入力を待つ。</li><li>ユーザーはアプリを許可する。</li><li>許可するとブラウザにトークンが表示されるので、ユーザーはそれをコピペしてスクリプトへ入力する。</li><li>スクリプトは受け取ったトークンをファイルに保存する。</li></ol><p>サンプルは下記の通り。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#111>$APP_DATA_DIR</span> <span style=color:#111>=</span> <span style=color:#111>$env:LOCALAPPDATA</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34;\TestApp&#34;</span>
<span style=color:#111>$TOKEN_FILE</span> <span style=color:#111>=</span> <span style=color:#111>$APP_DATA_DIR</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34;\token.txt&#34;</span>

<span style=color:#00a8c8>function</span> <span style=color:#111>Get-NewToken</span><span style=color:#111>()</span> <span style=color:#111>{</span>
    <span style=color:#75715e># トークンを得る</span>

    <span style=color:#111>$queryString</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;?&#34;</span>
    <span style=color:#111>$queryString</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#111>$queryString</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34;key=&#34;</span> <span style=color:#111>+</span> <span style=color:#111>$API_KEY</span><span style=color:#111>)</span> <span style=color:#75715e># APIキーに置き換える</span>
    <span style=color:#111>$queryString</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#111>$queryString</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34;&amp;scope=read,write&#34;</span><span style=color:#111>)</span>
    <span style=color:#111>$queryString</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#111>$queryString</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34;&amp;expiration=never&#34;</span><span style=color:#111>)</span>
    <span style=color:#111>$queryString</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#111>$queryString</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34;&amp;name=TestApp&#34;</span><span style=color:#111>)</span>
    <span style=color:#111>$queryString</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#111>$queryString</span> <span style=color:#111>+</span> <span style=color:#d88200>&#34;&amp;response_type=token&#34;</span><span style=color:#111>)</span>

    <span style=color:#111>$uri</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#d88200>&#34;https://api.trello.com/1/authorize&#34;</span> <span style=color:#111>+</span> <span style=color:#111>$queryString</span><span style=color:#111>)</span>

    <span style=color:#111>Start-Process</span> <span style=color:#111>$uri</span>

    <span style=color:#111>$token</span> <span style=color:#111>=</span> <span style=color:#111>Read-Host</span> <span style=color:#d88200>&#34;ブラウザに表示されたトークンを入力してください&#34;</span>

    <span style=color:#75715e># トークンをファイルに書き込み</span>
    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>-not</span> <span style=color:#111>(</span><span style=color:#111>Test-Path</span> <span style=color:#111>$APP_DATA_DIR</span><span style=color:#111>))</span> <span style=color:#111>{</span>
        <span style=color:#111>New-Item</span> <span style=color:#111>$APP_DATA_DIR</span> <span style=color:#111>-ItemType</span> <span style=color:#d88200>&#34;directory&#34;</span>
    <span style=color:#111>}</span>

    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>Test-Path</span> <span style=color:#111>$TOKEN_FILE</span><span style=color:#111>)</span> <span style=color:#111>{</span>
        <span style=color:#111>Remove-Item</span> <span style=color:#111>$TOKEN_FILE</span>
    <span style=color:#111>}</span>
    
    <span style=color:#111>Out-File</span> <span style=color:#111>-FilePath</span> <span style=color:#111>$TOKEN_FILE</span> <span style=color:#111>-InputObject</span> <span style=color:#111>$token</span>
<span style=color:#111>}</span>
</code></pre></div><p>ファイルに保存したトークンは、APIを実行するときに読み込む。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#00a8c8>function</span> <span style=color:#111>Read-Token</span><span style=color:#111>()</span> <span style=color:#111>{</span>
    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>-not</span> <span style=color:#111>(</span><span style=color:#111>Test-Path</span> <span style=color:#111>$TOKEN_FILE</span><span style=color:#111>))</span> <span style=color:#111>{</span>
        <span style=color:#111>Get-NewToken</span>
    <span style=color:#111>}</span>
    <span style=color:#111>$script:API_TOKEN</span> <span style=color:#111>=</span> <span style=color:#111>Get-Content</span> <span style=color:#111>$TOKEN_FILE</span>
<span style=color:#111>}</span>
</code></pre></div></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>