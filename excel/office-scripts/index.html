<!doctype html><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-143399608-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-143399608-2');</script><meta property="og:title" content="Office スクリプト"><meta property="og:description" content="はじめに Office スクリプトは、Web 版 Excel で使用できるスクリプトの仕組み。VBA の Web 版と捉えられる。 言語は TypeScript。 Office スクリプトを使うには、Office 365 の商用または教育向けライセンスが必要。もし"><meta property="og:type" content="article"><meta property="og:url" content="https://vicugna-pacos.github.io/excel/office-scripts/"><meta property="article:published_time" content="2021-09-09T18:01:48+09:00"><meta property="article:modified_time" content="2021-09-22T11:26:52+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Office スクリプト"><meta name=twitter:description content="はじめに Office スクリプトは、Web 版 Excel で使用できるスクリプトの仕組み。VBA の Web 版と捉えられる。 言語は TypeScript。 Office スクリプトを使うには、Office 365 の商用または教育向けライセンスが必要。もし"><meta name=generator content="Hugo 0.74.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="https://fonts.googleapis.com/icon?family=Material+Icons"><link rel=stylesheet href=https://vicugna-pacos.github.io/css/normalize.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/main.css><link rel=stylesheet href=https://vicugna-pacos.github.io/css/pagination.css><title>Office スクリプト - アルパカのメモ</title></head><body><header class=header-area><div class=content-container><span class=logo-text><a href=/>アルパカのメモ</a></span></div></header><div class=content-container><nav><ol class=breadcrumbnav><li>Home</li><li>Excel</li></ol></nav></div><main class=main-area><div class="content-container single"><div class=side><aside class=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#始め方>始め方</a></li><li><a href=#スクリプトの基本>スクリプトの基本</a><ul><li><a href=#main-関数>main 関数</a></li></ul></li><li><a href=#スクリプトが保存される場所>スクリプトが保存される場所</a></li><li><a href=#エディタ>エディタ</a><ul><li><a href=#文字を大きくする>文字を大きくする</a></li></ul></li><li><a href=#power-automate-から実行する>Power Automate から実行する</a><ul><li><a href=#戻り値がjsonのとき>戻り値がJSONのとき</a></li><li><a href=#日付のやりとり>日付のやりとり</a></li></ul></li><li><a href=#サンプル>サンプル</a><ul><li><a href=#日付のシリアル値javascriptの日付型の変換>日付のシリアル値→JavaScriptの日付型の変換</a></li><li><a href=#javascriptの日付型日付のシリアル値の変換>JavaScriptの日付型→日付のシリアル値の変換</a></li><li><a href=#土日祝日を避けて日付を加減算する>土日祝日を避けて日付を加減算する</a></li><li><a href=#テーブルにフィルタを設定し結果を取得する>テーブルにフィルタを設定し結果を取得する</a></li><li><a href=#テーブルをjsonへ変換する>テーブルをJSONへ変換する</a></li></ul></li></ul></nav></aside></div><div class=main><article><h1>Office スクリプト</h1><div class=article-info><div><i class=material-icons>calendar_today</i>
<time datetime="2021-09-09 18:01:48 +0900 +0900" itemprop=datePublished>2021-09-09</time>
(最終更新：<time datetime="2021-09-22 11:26:52 +0900 +0900" itemprop=dateModified>2021-09-22</time>)</div><div></div></div><h2 id=はじめに>はじめに</h2><p>Office スクリプトは、Web 版 Excel で使用できるスクリプトの仕組み。VBA の Web 版と捉えられる。
言語は TypeScript。</p><p>Office スクリプトを使うには、Office 365 の商用または教育向けライセンスが必要。もしOffice スクリプトを使えるなら、Web 版 Excel を開いたときにリボンに「自動化」タブが表示される。</p><p><img src=2021-09-07-09-26-16.png alt></p><p>表示されない場合、ライセンスを持っていないか、持っていたとしても組織の管理者が機能を制限している可能性がある。</p><p>Office スクリプトの利点：</p><ul><li>マクロを Web 版で実行できる</li><li>Power Automate や Azure Logic Apps から呼び出せる。<ul><li>Power Automate で Excel のデータを色々いじりたいときは、Office スクリプトに実装し、Power Automate から呼び出すだけにした方が効率がいい場合がある。さらには、細かい処理を Power Automate で一生懸命作るよりも、まるっと Office スクリプトに書いてしまうという使い方もできるかもしれない。</li></ul></li><li>一つのスクリプトを色々なブックへ使いまわせる。<ul><li>スクリプトはユーザー個人ごとに保存され、それを色々なブックで使うイメージ。</li></ul></li></ul><p>Office スクリプトのデメリット：</p><ul><li>デスクトップアプリでは利用できない。</li><li>共有設定をしない限りスクリプト作成者本人しか使用できない。<ul><li>スクリプトはブックには含まれず、ユーザー個人の OneDrive に保存されるため.</li></ul></li></ul><h2 id=始め方>始め方</h2><p>Web 版 Excel で新しいファイルを作成するか、OneDrive または SharePoint 上に作成した Excel ファイルを Web 版で開いてもいい。
リボンに「自動化」タブがあるので、クリックする。
画面右側に表れるウィンドウで、スクリプトの管理を行う。</p><h2 id=スクリプトの基本>スクリプトの基本</h2><p><a href=https://docs.microsoft.com/en-us/office/dev/scripts/develop/scripting-fundamentals target=_blank rel=noopener>Scripting fundamentals for Office Scripts in Excel on the web - Office Scripts | Microsoft Docs</a></p><h3 id=main-関数>main 関数</h3><p>すべてのスクリプトには、main 関数が必要。この関数がスクリプトのエントリーポイントになる。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#00a8c8>function</span> <span style=color:#75af00>main</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span>: <span style=color:#00a8c8>ExcelScript.Workbook</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#75715e>// ここに処理を書く
</span><span style=color:#75715e></span><span style=color:#111>}</span>
</code></pre></div><p><a href="https://docs.microsoft.com/en-us/javascript/api/office-scripts/overview?view=office-scripts" target=_blank rel=noopener>Office Scripts API reference - Office Scripts | Microsoft Docs</a></p><h2 id=スクリプトが保存される場所>スクリプトが保存される場所</h2><p><a href=https://docs.microsoft.com/en-us/office/dev/scripts/overview/script-storage target=_blank rel=noopener>Office Scripts file storage and ownership - Office Scripts | Microsoft Docs</a></p><p>VBA と違い、Office Script はブックとは別の場所に保存される。</p><p>スクリプトは、スクリプトを作成したユーザーの OneDrive に保存される。そのため、共有設定をしない限り、他の人はそのスクリプトを編集したり実行することはできない。</p><p><img src=2021-09-09-16-52-08.png alt></p><p>共有設定をしても保存場所は変わらないため、スクリプト作成者のアカウントを削除するとスクリプトも一緒に削除されると考えられる。
複数人でスクリプトを共有する場合は、バックアップを共有フォルダ (SharePoint とか) に取っておくと良いかもしれない。</p><p><img src=2021-09-09-16-32-09.png alt></p><h2 id=エディタ>エディタ</h2><p><a href=https://docs.microsoft.com/en-us/office/dev/scripts/overview/code-editor-environment target=_blank rel=noopener>Office Scripts Code Editor environment - Office Scripts | Microsoft Docs</a></p><p>下記がスクリプトの編集画面。</p><p><img src=2021-09-07-16-44-05.png alt></p><p>VS Code がベースになっているので、VS Code みたいに IntelliSense が使えたりする。</p><h3 id=文字を大きくする>文字を大きくする</h3><p>エディタの文字が小さくて見づらい場合は、大きくすることができる。</p><ol><li>F1 キーを押してコマンドパレットを表示する。</li><li>Font と入力し、「Editor Font Zoom In」を選ぶ。</li><li>文字が少し大きくなる。もっと大きくしたい場合は、1～3の手順を繰り返す。</li></ol><p><img src=2021-09-07-16-55-07.png alt></p><h2 id=power-automate-から実行する>Power Automate から実行する</h2><ol><li>アクションの一覧から「Excel Online (Business)」を選ぶ。<br><img src=2021-09-08-15-21-50.png alt></li><li>「スクリプトの実行」を選ぶ。<br><img src=2021-09-08-15-22-54.png alt></li><li>スクリプトを書いた Excel ファイルを指定すると、「スクリプト」のリストがファイルに定義したスクリプトの一覧になる。</li><li>さらにスクリプトを選択すると、そのスクリプトの main 関数に追加した引数が入力項目として現れる。<br><img src=2021-09-08-15-27-44.png alt></li></ol><p>実行するスクリプトの main 関数に追加する引数は、プリミティブ型のみ有効。Date 型などはサポートされていない。</p><h3 id=戻り値がjsonのとき>戻り値がJSONのとき</h3><p>スクリプトの戻り値がJSON形式の場合、スクリプト側でJSONスキーマが明示されていれば Power Automate 側ですんなりとスクリプトの実行結果をJSONとして扱える。</p><p>Office スクリプトのサンプル：</p><p><img src=2021-09-24-11-06-44.png alt></p><p>Power Automate のサンプル：</p><p><img src=2021-09-24-11-11-35.png alt></p><p>ただし、スクリプト内でスキーマが明記されていない場合は、スクリプトの実行結果を「JSONの解析」する必要がある。</p><p><img src=2021-09-24-11-20-03.png alt></p><p><img src=2021-09-24-11-16-09.png alt></p><h3 id=日付のやりとり>日付のやりとり</h3><p>Office スクリプトの戻り値が日付の場合、下記のようにして ISO8601 形式の文字列にするとよい。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#00a8c8>let</span> <span style=color:#75af00>dt</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Date</span><span style=color:#111>();</span>
<span style=color:#00a8c8>return</span> <span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>toISOString</span><span style=color:#111>();</span>
</code></pre></div><p>Power Automate で、この日付のタイムゾーン＆書式の変換を行える。</p><p>参考：<a href=https://docs.microsoft.com/en-us/azure/logic-apps/workflow-definition-language-functions-reference#convertTimeZone target=_blank rel=noopener>関数 convertTimeZone のドキュメント</a></p><p>日本時間にするときは、JSTではなく「Tokyo Standard Time」を指定する。</p><p>参考：<a href=https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/default-time-zones target=_blank rel=noopener>Default Time Zones | Microsoft Docs</a></p><h2 id=サンプル>サンプル</h2><h3 id=日付のシリアル値javascriptの日付型の変換>日付のシリアル値→JavaScriptの日付型の変換</h3><p>日付が格納されたセルの値を取ると、シリアル値になっている。
これを JavaScript の日付型に変換するサンプル。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#75715e>/**
</span><span style=color:#75715e> * 日付シリアル値をJavaScriptの日付型へ変換する
</span><span style=color:#75715e> */</span>
<span style=color:#00a8c8>function</span> <span style=color:#75af00>convertSerialToDate</span><span style=color:#111>(</span><span style=color:#75af00>dateSerial</span>: <span style=color:#00a8c8>number</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>milliseconds</span> <span style=color:#f92672>=</span> <span style=color:#111>Math</span><span style=color:#111>.</span><span style=color:#75af00>round</span><span style=color:#111>((</span><span style=color:#75af00>dateSerial</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>25569</span><span style=color:#111>)</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>86400</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span><span style=color:#111>);</span>
  <span style=color:#75af00>milliseconds</span> <span style=color:#f92672>-=</span> <span style=color:#111>(</span><span style=color:#ae81ff>9</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span><span style=color:#111>);</span>  <span style=color:#75715e>// タイムゾーンの調整
</span><span style=color:#75715e></span>  <span style=color:#00a8c8>let</span> <span style=color:#75af00>javaScriptDate</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Date</span><span style=color:#111>(</span><span style=color:#75af00>milliseconds</span><span style=color:#111>);</span>
  
  <span style=color:#00a8c8>return</span> <span style=color:#75af00>javaScriptDate</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><p>Excel の日付シリアル値は 1900-01-01 から 1ずつ増える。対して JavaScript の <code>new Date(ミリ秒)</code> は、1970-01-01(UTC) から増えたミリ秒を指定する。
25569 は 1900-01-01 ～ 1970-01-01 の日数。</p><p>そして、コンストラクタに指定するミリ秒は UTC が基準であるのに対して Excel にはタイムゾーンがないため、JST で書かれた日付のシリアル値をそのまま足すと9時間早くなってしまう。
その差を調整するために9時間分のミリ秒を引いている。この調整は、Excel の日付がどのタイムゾーンを前提として記載されているかによって変わる。</p><h3 id=javascriptの日付型日付のシリアル値の変換>JavaScriptの日付型→日付のシリアル値の変換</h3><p>先ほどのサンプルとは逆に、日付型からシリアル値へ変換するサンプル。</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>/**
</span><span style=color:#75715e> * JavaScriptの日付型を、Excelの日付シリアル値へ変換する
</span><span style=color:#75715e> */</span>
<span style=color:#00a8c8>function</span> <span style=color:#75af00>convertDateToSerial</span><span style=color:#111>(</span><span style=color:#75af00>dt</span><span style=color:#f92672>:</span> <span style=color:#111>Date</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>seconds</span> <span style=color:#f92672>=</span> <span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>getHours</span><span style=color:#111>()</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span><span style=color:#111>;</span>
  <span style=color:#75af00>seconds</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>getMinutes</span><span style=color:#111>()</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span><span style=color:#111>;</span>
  <span style=color:#75af00>seconds</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>getSeconds</span><span style=color:#111>();</span>

  <span style=color:#00a8c8>let</span> <span style=color:#75af00>serial</span> <span style=color:#f92672>=</span> <span style=color:#111>Math</span><span style=color:#111>.</span><span style=color:#75af00>round</span><span style=color:#111>(</span><span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>getTime</span><span style=color:#111>()</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>86400</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>25569</span><span style=color:#111>);</span>

  <span style=color:#75af00>serial</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>seconds</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>86400</span><span style=color:#111>;</span>
  <span style=color:#75af00>serial</span> <span style=color:#f92672>=</span> <span style=color:#111>Math</span><span style=color:#111>.</span><span style=color:#75af00>round</span><span style=color:#111>(</span><span style=color:#75af00>serial</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100000</span><span style=color:#111>)</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>100000</span><span style=color:#111>;</span> <span style=color:#75715e>// 小数点以下5桁を残して四捨五入
</span><span style=color:#75715e></span>  
  <span style=color:#00a8c8>return</span> <span style=color:#75af00>serial</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><p>日数については、先ほどのサンプルの反対の計算を行う。
時刻は例えば PM 0:00 の場合は 0.5 となるため、0時からの秒数 / 24時間の秒数 で求めている。</p><p>JavaScript の getHours() などは実行環境のローカル時刻を返す。このサンプルではそれを意図したものとして、タイムゾーンの変換は行っていない。</p><h3 id=土日祝日を避けて日付を加減算する>土日祝日を避けて日付を加減算する</h3><p>「稼働日ベースで10日前」という感じの計算をするためのサンプル。
スクリプトを実行するブックに、「祝日リスト」というテーブルがあることが前提。</p><p>↓ 祝日リストのサンプル<br><img src=2021-09-14-15-00-33.png alt></p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#00a8c8>const</span> <span style=color:#75af00>SHEET_NAME</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;Sheet1&#34;</span><span style=color:#111>;</span>
<span style=color:#00a8c8>const</span> <span style=color:#75af00>TABLE_NAME</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;祝日リスト&#34;</span><span style=color:#111>;</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> * 日付に日数を加算する。
</span><span style=color:#75715e> * 土日祝日は日数から除外する。つまり稼働日のみで日数を加算。
</span><span style=color:#75715e> */</span>
<span style=color:#00a8c8>function</span> <span style=color:#75af00>addDaysAndSkipHolidays</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span><span style=color:#f92672>:</span> <span style=color:#75af00>ExcelScript</span><span style=color:#111>.</span><span style=color:#75af00>Workbook</span><span style=color:#111>,</span> <span style=color:#75af00>dt</span><span style=color:#f92672>:</span> <span style=color:#111>Date</span><span style=color:#111>,</span> <span style=color:#75af00>daysAdd</span><span style=color:#f92672>:</span> <span style=color:#75af00>number</span><span style=color:#111>)</span> <span style=color:#111>{</span>

  <span style=color:#00a8c8>let</span> <span style=color:#75af00>table</span> <span style=color:#f92672>=</span> <span style=color:#75af00>workbook</span><span style=color:#111>.</span><span style=color:#75af00>getWorksheet</span><span style=color:#111>(</span><span style=color:#75af00>SHEET_NAME</span><span style=color:#111>).</span><span style=color:#75af00>getTable</span><span style=color:#111>(</span><span style=color:#75af00>TABLE_NAME</span><span style=color:#111>);</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>dataRange</span> <span style=color:#f92672>=</span> <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>getRangeBetweenHeaderAndTotal</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>holidays</span> <span style=color:#f92672>=</span> <span style=color:#75af00>dataRange</span><span style=color:#111>.</span><span style=color:#75af00>getValues</span><span style=color:#111>();</span>

  <span style=color:#00a8c8>let</span> <span style=color:#75af00>increment</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>count</span> <span style=color:#f92672>=</span> <span style=color:#75af00>daysAdd</span><span style=color:#111>;</span>

  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>daysAdd</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#75af00>increment</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>;</span>
    <span style=color:#75af00>count</span> <span style=color:#f92672>*=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>;</span>
  <span style=color:#111>}</span>

  <span style=color:#00a8c8>let</span> <span style=color:#75af00>result</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Date</span><span style=color:#111>(</span><span style=color:#75af00>dt</span><span style=color:#111>);</span>

  <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#00a8c8>let</span> <span style=color:#75af00>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#75af00>count</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>setDate</span><span style=color:#111>(</span><span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>getDate</span><span style=color:#111>()</span> <span style=color:#f92672>+</span> <span style=color:#75af00>increment</span><span style=color:#111>);</span>
    <span style=color:#75715e>// 休日のスキップ
</span><span style=color:#75715e></span>    <span style=color:#75af00>result</span> <span style=color:#f92672>=</span> <span style=color:#75af00>skipHolidays</span><span style=color:#111>(</span><span style=color:#75af00>holidays</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>,</span> <span style=color:#75af00>increment</span><span style=color:#111>);</span>
  <span style=color:#111>}</span>

  <span style=color:#00a8c8>return</span> <span style=color:#75af00>result</span><span style=color:#111>;</span>
<span style=color:#111>}</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> * 引数の日付シリアル値が土日祝の場合、その分だけ日付をずらす
</span><span style=color:#75715e> */</span>
<span style=color:#00a8c8>function</span> <span style=color:#75af00>skipHolidays</span><span style=color:#111>(</span><span style=color:#75af00>holidays</span><span style=color:#f92672>:</span> <span style=color:#111>(</span><span style=color:#75af00>string</span> <span style=color:#f92672>|</span> <span style=color:#75af00>number</span> <span style=color:#f92672>|</span> <span style=color:#00a8c8>boolean</span><span style=color:#111>)[][],</span> <span style=color:#75af00>dt</span><span style=color:#f92672>:</span> <span style=color:#111>Date</span><span style=color:#111>,</span> <span style=color:#75af00>increment</span><span style=color:#f92672>:</span> <span style=color:#75af00>number</span><span style=color:#111>)</span> <span style=color:#111>{</span>

  <span style=color:#00a8c8>let</span> <span style=color:#75af00>result</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Date</span><span style=color:#111>(</span><span style=color:#75af00>dt</span><span style=color:#111>);</span>

  <span style=color:#75715e>// 土日祝のいずれかの場合、1日ずらして再帰呼び出し
</span><span style=color:#75715e></span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>getDay</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
    <span style=color:#f92672>||</span> <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>getDay</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>6</span>
    <span style=color:#f92672>||</span> <span style=color:#75af00>isExtraHoliday</span><span style=color:#111>(</span><span style=color:#75af00>holidays</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>))</span> <span style=color:#111>{</span>
    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>setDate</span><span style=color:#111>(</span><span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>getDate</span><span style=color:#111>()</span> <span style=color:#f92672>+</span> <span style=color:#75af00>increment</span><span style=color:#111>);</span>
    <span style=color:#75af00>result</span> <span style=color:#f92672>=</span> <span style=color:#75af00>skipHolidays</span><span style=color:#111>(</span><span style=color:#75af00>holidays</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>,</span> <span style=color:#75af00>increment</span><span style=color:#111>);</span>
  <span style=color:#111>}</span>

  <span style=color:#00a8c8>return</span> <span style=color:#75af00>result</span><span style=color:#111>;</span>
<span style=color:#111>}</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> * 引数の日付が祝日かどうか判定する
</span><span style=color:#75715e> */</span>
<span style=color:#00a8c8>function</span> <span style=color:#75af00>isExtraHoliday</span><span style=color:#111>(</span><span style=color:#75af00>holidays</span><span style=color:#f92672>:</span> <span style=color:#111>(</span><span style=color:#75af00>string</span> <span style=color:#f92672>|</span> <span style=color:#75af00>number</span> <span style=color:#f92672>|</span> <span style=color:#00a8c8>boolean</span><span style=color:#111>)[][],</span> <span style=color:#75af00>dt</span><span style=color:#f92672>:</span> <span style=color:#111>Date</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#75715e>// シリアル値に時刻の情報はいらないので、切り捨てる
</span><span style=color:#75715e></span>  <span style=color:#00a8c8>let</span> <span style=color:#75af00>dtSerial</span> <span style=color:#f92672>=</span> <span style=color:#111>Math</span><span style=color:#111>.</span><span style=color:#75af00>floor</span><span style=color:#111>(</span><span style=color:#75af00>convertDateToSerial</span><span style=color:#111>(</span><span style=color:#75af00>dt</span><span style=color:#111>));</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>holidayCount</span> <span style=color:#f92672>=</span> <span style=color:#75af00>holidays</span><span style=color:#111>.</span><span style=color:#75af00>length</span><span style=color:#111>;</span>

  <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#00a8c8>let</span> <span style=color:#75af00>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#75af00>holidayCount</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#00a8c8>let</span> <span style=color:#75af00>holidaySerial</span> <span style=color:#f92672>=</span> <span style=color:#75af00>holidays</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>][</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#75af00>as</span> <span style=color:#75af00>number</span><span style=color:#111>;</span>
    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>dtSerial</span> <span style=color:#f92672>==</span> <span style=color:#75af00>holidaySerial</span><span style=color:#111>)</span> <span style=color:#111>{</span>
      <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span><span style=color:#111>;</span>
    <span style=color:#111>}</span>
  <span style=color:#111>}</span>
  <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span><span style=color:#111>;</span>
<span style=color:#111>}</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> * JavaScriptの日付型を、Excelの日付シリアル値へ変換する
</span><span style=color:#75715e> */</span>
<span style=color:#00a8c8>function</span> <span style=color:#75af00>convertDateToSerial</span><span style=color:#111>(</span><span style=color:#75af00>dt</span><span style=color:#f92672>:</span> <span style=color:#111>Date</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>seconds</span> <span style=color:#f92672>=</span> <span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>getHours</span><span style=color:#111>()</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span><span style=color:#111>;</span>
  <span style=color:#75af00>seconds</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>getMinutes</span><span style=color:#111>()</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span><span style=color:#111>;</span>
  <span style=color:#75af00>seconds</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>getSeconds</span><span style=color:#111>();</span>

  <span style=color:#00a8c8>let</span> <span style=color:#75af00>serial</span> <span style=color:#f92672>=</span> <span style=color:#111>Math</span><span style=color:#111>.</span><span style=color:#75af00>round</span><span style=color:#111>(</span><span style=color:#75af00>dt</span><span style=color:#111>.</span><span style=color:#75af00>getTime</span><span style=color:#111>()</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>86400</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>25569</span><span style=color:#111>);</span>

  <span style=color:#75af00>serial</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>seconds</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>86400</span><span style=color:#111>;</span>
  <span style=color:#75af00>serial</span> <span style=color:#f92672>=</span> <span style=color:#111>Math</span><span style=color:#111>.</span><span style=color:#75af00>round</span><span style=color:#111>(</span><span style=color:#75af00>serial</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100000</span><span style=color:#111>)</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>100000</span><span style=color:#111>;</span> <span style=color:#75715e>// 小数点以下5桁を残して四捨五入
</span><span style=color:#75715e></span>
  <span style=color:#00a8c8>return</span> <span style=color:#75af00>serial</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=テーブルにフィルタを設定し結果を取得する>テーブルにフィルタを設定し結果を取得する</h3><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#00a8c8>function</span> <span style=color:#75af00>main</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span>: <span style=color:#00a8c8>ExcelScript.Workbook</span><span style=color:#111>)</span>
<span style=color:#111>{</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>sheet</span> <span style=color:#f92672>=</span> <span style=color:#75af00>workbook</span><span style=color:#111>.</span><span style=color:#75af00>getWorksheet</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Sheet1&#34;</span><span style=color:#111>);</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>table</span> <span style=color:#f92672>=</span> <span style=color:#75af00>sheet</span><span style=color:#111>.</span><span style=color:#75af00>getTable</span><span style=color:#111>(</span><span style=color:#d88200>&#34;テーブル1&#34;</span><span style=color:#111>);</span>
  
  <span style=color:#75715e>// フィルタ
</span><span style=color:#75715e></span>  <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>clearFilters</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>column</span> <span style=color:#f92672>=</span> <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>getColumnByName</span><span style=color:#111>(</span><span style=color:#d88200>&#34;列1&#34;</span><span style=color:#111>);</span>
  <span style=color:#75af00>column</span><span style=color:#111>.</span><span style=color:#75af00>getFilter</span><span style=color:#111>().</span><span style=color:#75af00>applyValuesFilter</span><span style=color:#111>([</span><span style=color:#d88200>&#34;検索したい値&#34;</span><span style=color:#111>]);</span>

  <span style=color:#75715e>// 結果を取得
</span><span style=color:#75715e></span>  <span style=color:#00a8c8>let</span> <span style=color:#75af00>range</span> <span style=color:#f92672>=</span> <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>getRange</span><span style=color:#111>().</span><span style=color:#75af00>getVisibleView</span><span style=color:#111>();</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>range</span><span style=color:#111>.</span><span style=color:#75af00>getRowCount</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#00a8c8>return</span><span style=color:#111>;</span>
  <span style=color:#111>}</span>

  <span style=color:#75715e>// values は Object[][] 型。1行目にヘッダー、2行目以降にデータ行。
</span><span style=color:#75715e></span>  <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>range</span><span style=color:#111>.</span><span style=color:#75af00>getValues</span><span style=color:#111>());</span>
<span style=color:#111>}</span>
</code></pre></div><h3 id=テーブルをjsonへ変換する>テーブルをJSONへ変換する</h3><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#00a8c8>function</span> <span style=color:#75af00>main</span><span style=color:#111>(</span><span style=color:#75af00>workbook</span><span style=color:#f92672>:</span> <span style=color:#75af00>ExcelScript</span><span style=color:#111>.</span><span style=color:#75af00>Workbook</span><span style=color:#111>)</span><span style=color:#f92672>:</span> <span style=color:#75af00>TableData</span><span style=color:#111>[]</span> <span style=color:#111>{</span>
  <span style=color:#00a8c8>const</span> <span style=color:#75af00>table</span> <span style=color:#f92672>=</span> <span style=color:#75af00>workbook</span><span style=color:#111>.</span><span style=color:#75af00>getWorksheet</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Sheet1&#34;</span><span style=color:#111>).</span><span style=color:#75af00>getTable</span><span style=color:#111>(</span><span style=color:#d88200>&#34;テーブル1&#34;</span><span style=color:#111>);</span>
  <span style=color:#75715e>// テーブルの値を表示されているテキストの形式で取得
</span><span style=color:#75715e></span>  <span style=color:#00a8c8>const</span> <span style=color:#75af00>texts</span> <span style=color:#f92672>=</span> <span style=color:#75af00>table</span><span style=color:#111>.</span><span style=color:#75af00>getRange</span><span style=color:#111>().</span><span style=color:#75af00>getTexts</span><span style=color:#111>();</span>
  
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>result</span> <span style=color:#f92672>=</span> <span style=color:#75af00>convertToJson</span><span style=color:#111>(</span><span style=color:#75af00>texts</span><span style=color:#111>);</span>

  <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>result</span><span style=color:#111>);</span>
<span style=color:#111>}</span>

<span style=color:#75715e>// テーブルの値(二次元配列)をJSONにする。
</span><span style=color:#75715e></span><span style=color:#00a8c8>function</span> <span style=color:#75af00>convertToJson</span><span style=color:#111>(</span><span style=color:#75af00>values</span><span style=color:#f92672>:</span> <span style=color:#111>Object</span><span style=color:#111>[][])</span> <span style=color:#111>{</span>
  <span style=color:#00a8c8>let</span> <span style=color:#75af00>result</span> <span style=color:#f92672>=</span> <span style=color:#111>{};</span>

  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>values</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>||</span> <span style=color:#75af00>values</span><span style=color:#111>.</span><span style=color:#75af00>length</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#111>;</span>
  <span style=color:#111>}</span>

  <span style=color:#75715e>// 1行目はヘッダー行なので2行目から始める
</span><span style=color:#75715e></span>  <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#00a8c8>let</span> <span style=color:#75af00>i</span><span style=color:#f92672>:</span><span style=color:#75af00>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>&lt;</span><span style=color:#75af00>values</span><span style=color:#111>.</span><span style=color:#75af00>length</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#00a8c8>let</span> <span style=color:#75af00>j</span><span style=color:#f92672>:</span><span style=color:#75af00>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>j</span><span style=color:#f92672>&lt;</span><span style=color:#75af00>values</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>].</span><span style=color:#75af00>length</span><span style=color:#111>;</span> <span style=color:#75af00>j</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
      <span style=color:#00a8c8>let</span> <span style=color:#75af00>key</span> <span style=color:#f92672>=</span> <span style=color:#75af00>values</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>][</span><span style=color:#75af00>j</span><span style=color:#111>]</span> <span style=color:#75af00>as</span> <span style=color:#75af00>string</span><span style=color:#111>;</span>
      <span style=color:#00a8c8>let</span> <span style=color:#75af00>value</span> <span style=color:#f92672>=</span> <span style=color:#75af00>values</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>][</span><span style=color:#75af00>j</span><span style=color:#111>];</span>

      <span style=color:#75af00>result</span><span style=color:#111>[</span><span style=color:#75af00>key</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#75af00>value</span><span style=color:#111>;</span>
    <span style=color:#111>}</span>
  <span style=color:#111>}</span>

  <span style=color:#00a8c8>return</span> <span style=color:#75af00>result</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div></article></div></div></main><footer class=footer-area><div class=content-container><hr><div class=author-container><div class=avatar><img src=/images/avatar.jpg></div><div class=author><p class=author-name>alpaca</p><p>おおむねSIerにいますが、他業種の社内SEだったこともあります。</p><p><a href=https://github.com/vicugna-pacos><img src=/images/GitHub-Mark-32px.png style=width:2rem></a></p></div></div></div></footer></body></html>